<!doctype html>
<html class="h-full">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Worship Planner</title>

  <?!= HtmlService.createHtmlOutputFromFile('styles').getContent(); ?>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <script id="rows-json" type="application/json">
    <?!= JSON.stringify(rowsData).replace(/<\//g, '<\\/') ?>
  </script>
  <script id="services-json" type="application/json">
    <?!= JSON.stringify((servicesData && servicesData.items) ? servicesData.items : []).replace(/<\//g, '<\\/') ?>
  </script>
  <script id="viewer-json" type="application/json">
    <?!= JSON.stringify(typeof viewerProfile !== 'undefined' ? viewerProfile : null).replace(/<\//g, '<\\/') ?>
  </script>
  <script>
    const parseJsonFallback = (text, fallback) => {
      if (!text || /<\?!=/.test(text)) return fallback;
      try { return JSON.parse(text); } catch (_) { return fallback; }
    };

    const rowsEl = document.getElementById('rows-json');
    const servicesEl = document.getElementById('services-json');
    const viewerEl = document.getElementById('viewer-json');
    const existingRows = Array.isArray(window.__ROWS__) ? window.__ROWS__ : [];
    const existingServices = Array.isArray(window.__SERVICES__) ? window.__SERVICES__ : [];
    const existingViewer = typeof window.__VIEWER__ === 'object' ? window.__VIEWER__ : null;
    window.__ROWS__ = parseJsonFallback(rowsEl && rowsEl.textContent, existingRows);
    window.__SERVICES__ = parseJsonFallback(servicesEl && servicesEl.textContent, existingServices);
    window.__VIEWER__ = parseJsonFallback(viewerEl && viewerEl.textContent, existingViewer);

    const baseTemplate = `<?!= JSON.stringify(typeof baseUrl !== 'undefined' ? baseUrl : '') ?>`;
    const guestTemplate = `<?!= JSON.stringify(typeof guestMode !== 'undefined' ? !!guestMode : false) ?>`;
    const parseTemplateString = (raw, fallback) => {
      if (!raw || /<\?!=/.test(raw)) return fallback;
      try { return JSON.parse(raw); } catch (_) { return fallback; }
    };

    const baseFromServer = parseTemplateString(baseTemplate, '');
    const guestFromServer = parseTemplateString(guestTemplate, false);
    // Prefer server-provided Web App URL; fallback to current location
    window.__BASE__ = baseFromServer || (location.origin + location.pathname);
    // Guest mode injected by server (via ?mode=guest)
    window.__GUEST__ = guestFromServer;
  </script>
  <script>
    (function ensureRpcBase() {
      if (window.__BASE__ && window.__BASE__ !== (location.origin + location.pathname)) return;
      if (window.APP_RPC_BASE) {
        window.__BASE__ = window.APP_RPC_BASE;
        return;
      }
      try {
        const meta = document.querySelector('meta[name="app-script-base"]');
        if (meta && meta.content) window.__BASE__ = meta.content;
      } catch (_) { }
    })();
  </script>
  <?!= HtmlService.createHtmlOutputFromFile('util').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('context').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-songs').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-team').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-weekly-plan').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-availability').getContent(); ?>
  <template id="songs-browser-template">
    <?!= HtmlService.createHtmlOutputFromFile('songs-browser').getContent(); ?>
  </template>

</head>

<body x-data="app()" x-init="init()" class="h-full bg-gray-50 overflow-hidden flex flex-col">

  <!-- Topbar -->
  <?!= HtmlService.createHtmlOutputFromFile('topbar').getContent(); ?>

  <!-- Views stay mounted; tabs toggle visibility to preserve state -->
  <main class="h-[calc(100vh-58px)] overflow-hidden flex flex-col flex-1 min-h-0">
    <template x-if="route==='songs'">
      <?!= HtmlService.createHtmlOutputFromFile('songs').getContent(); ?>
    </template>

    <div x-show="route==='plan' && auth && auth.capabilities && auth.capabilities.canViewPlan" class="h-full flex-1 min-h-0 flex flex-col">
      <?!= HtmlService.createHtmlOutputFromFile('weekly-plan').getContent(); ?>
    </div>

    <div x-show="route==='team' && auth && auth.capabilities && auth.capabilities.canViewTeam" class="h-full flex-1 min-h-0">
      <?!= HtmlService.createHtmlOutputFromFile('team').getContent(); ?>
    </div>

    <div x-show="route==='availability'" class="h-full flex-1 min-h-0">
      <?!= HtmlService.createHtmlOutputFromFile('availability').getContent(); ?>
    </div>
  </main>


  <script>
    function app() {
      const initialAuth = (typeof window !== 'undefined' && window.__AUTH__) || {
        ready: false,
        capabilities: { canViewTeam: false }
      };
      const routesForAuth = (authState) => {
        const set = new Set(['songs', 'availability']);
        if (authState && authState.capabilities && authState.capabilities.canViewPlan) {
          set.add('plan');
        }
        if (authState && authState.capabilities && authState.capabilities.canViewTeam) {
          set.add('team');
        }
        return set;
      };
      return {
        route: 'plan',
        auth: initialAuth,
        allowedRoutes: routesForAuth(initialAuth),
        init() {
          const normalize = (value) => String(value || '').trim().toLowerCase();
          const parseHashRoute = () => normalize(location.hash.replace('#/', ''));
          const fallbackRoute = () => {
            if (this.allowedRoutes.has('plan')) return 'plan';
            if (this.allowedRoutes.has('songs')) return 'songs';
            if (this.allowedRoutes.has('availability')) return 'availability';
            const first = this.allowedRoutes.values().next();
            return first && first.value ? first.value : 'songs';
          };
          const setRoute = (value) => {
            const fallback = fallbackRoute();
            const next = this.allowedRoutes.has(value) ? value : fallback;
            this.route = next;
            return next;
          };
          const ensureHash = () => {
            if (!location.hash || location.hash === '#') {
              location.hash = `#/${this.route}`;
            }
          };
          const applyAuth = (authState) => {
            this.auth = authState || initialAuth;
            this.allowedRoutes = routesForAuth(this.auth);
            const prevRoute = this.route;
            const resolved = setRoute(prevRoute);
            if (resolved !== prevRoute) {
              location.hash = `#/${resolved}`;
            }
          };
          applyAuth(this.auth);

          const params = (() => {
            try { return new URLSearchParams(location.search || ''); }
            catch (_) { return null; }
          })();
          const paramRoute = params
            ? [params.get('tab'), params.get('route'), params.get('view')].map(normalize).find(Boolean) || ''
            : '';

          const initialHashRoute = parseHashRoute();
          if (initialHashRoute) {
            const resolved = setRoute(initialHashRoute);
            if (resolved !== initialHashRoute) {
              location.hash = `#/${resolved}`;
            }
          } else if (paramRoute) {
            const resolved = setRoute(paramRoute);
            location.hash = `#/${resolved}`;
          } else {
            setRoute(this.route);
            ensureHash();
          }

          window.addEventListener('hashchange', () => {
            const next = parseHashRoute() || 'plan';
            const resolved = setRoute(next);
            if (resolved !== next) {
              location.hash = `#/${resolved}`;
            }
          });

          try {
            document.addEventListener('app-auth-changed', (evt) => applyAuth(evt.detail || initialAuth));
          } catch (_) { /* ignore */ }
        }
      }
    }
  </script>
</body>

</html>

