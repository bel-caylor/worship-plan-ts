<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Worship Planner</title>

  <?!= HtmlService.createHtmlOutputFromFile('styles').getContent(); ?>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <script id="rows-json" type="application/json">
    <?!= JSON.stringify(rowsData).replace(/<\//g, '<\\/') ?>
  </script>
  <script id="services-json" type="application/json">
    <?!= JSON.stringify((servicesData && servicesData.items) ? servicesData.items : []).replace(/<\//g, '<\\/') ?>
  </script>
  <script>
    const parseJsonFallback = (text, fallback) => {
      if (!text || /<\?!=/.test(text)) return fallback;
      try { return JSON.parse(text); } catch (_) { return fallback; }
    };

    const rowsEl = document.getElementById('rows-json');
    const servicesEl = document.getElementById('services-json');
    const existingRows = Array.isArray(window.__ROWS__) ? window.__ROWS__ : [];
    const existingServices = Array.isArray(window.__SERVICES__) ? window.__SERVICES__ : [];
    window.__ROWS__ = parseJsonFallback(rowsEl && rowsEl.textContent, existingRows);
    window.__SERVICES__ = parseJsonFallback(servicesEl && servicesEl.textContent, existingServices);

    const baseTemplate = `<?!= JSON.stringify(typeof baseUrl !== 'undefined' ? baseUrl : '') ?>`;
    const guestTemplate = `<?!= JSON.stringify(typeof guestMode !== 'undefined' ? !!guestMode : false) ?>`;
    const parseTemplateString = (raw, fallback) => {
      if (!raw || /<\?!=/.test(raw)) return fallback;
      try { return JSON.parse(raw); } catch (_) { return fallback; }
    };

    const baseFromServer = parseTemplateString(baseTemplate, '');
    const guestFromServer = parseTemplateString(guestTemplate, false);
    // Prefer server-provided Web App URL; fallback to current location
    window.__BASE__ = baseFromServer || (location.origin + location.pathname);
    // Guest mode injected by server (via ?mode=guest)
    window.__GUEST__ = guestFromServer;
  </script>
  <script>
    (function ensureRpcBase() {
      if (window.__BASE__ && window.__BASE__ !== (location.origin + location.pathname)) return;
      if (window.APP_RPC_BASE) {
        window.__BASE__ = window.APP_RPC_BASE;
        return;
      }
      try {
        const meta = document.querySelector('meta[name="app-script-base"]');
        if (meta && meta.content) window.__BASE__ = meta.content;
      } catch (_) {}
    })();
  </script>
  <?!= HtmlService.createHtmlOutputFromFile('util').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('context').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-songs').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-team').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-weekly-plan').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-availability').getContent(); ?>
  <template id="songs-browser-template">
    <?!= HtmlService.createHtmlOutputFromFile('songs-browser').getContent(); ?>
  </template>

</head>

<body x-data="app()" x-init="init()" class="min-h-screen overflow-y-auto bg-gray-50">

  <!-- Topbar -->
  <?!= HtmlService.createHtmlOutputFromFile('topbar').getContent(); ?>

  <!-- Views stay mounted; tabs toggle visibility to preserve state -->
  <main class="min-h-[calc(100vh-56px)]">
    <div class="h-full">
      <template x-if="route==='songs'">
        <?!= HtmlService.createHtmlOutputFromFile('songs').getContent(); ?>
      </template>

      <div x-show="route==='plan'" class="h-full">
        <?!= HtmlService.createHtmlOutputFromFile('weekly-plan').getContent(); ?>
      </div>

      <div x-show="route==='team' && !window.__GUEST__" class="h-full">
        <?!= HtmlService.createHtmlOutputFromFile('team').getContent(); ?>
      </div>

      <div x-show="route==='availability'" class="h-full">
        <?!= HtmlService.createHtmlOutputFromFile('availability').getContent(); ?>
      </div>
    </div>
  </main>


  <script>
    function app() {
      return {
        route: 'plan',
        init() {
          const isGuest = !!(window.__GUEST__);
          const allowed = new Set(isGuest ? ['plan','songs','availability'] : ['plan','songs','team','availability']);
          const normalize = (value) => String(value || '').trim().toLowerCase();
          const parseHashRoute = () => normalize(location.hash.replace('#/', ''));
          const setRoute = (value) => {
            const next = allowed.has(value) ? value : 'plan';
            this.route = next;
          };
          const params = (() => {
            try { return new URLSearchParams(location.search || ''); }
            catch (_) { return null; }
          })();
          const paramRoute = params
            ? [params.get('tab'), params.get('route'), params.get('view')].map(normalize).find(Boolean) || ''
            : '';

          const initialHashRoute = parseHashRoute();
          if (initialHashRoute) {
            setRoute(initialHashRoute);
          } else if (paramRoute) {
            setRoute(paramRoute);
            if (!location.hash || location.hash === '#') {
              location.hash = `#/${this.route}`;
            }
          } else {
            setRoute('plan');
          }

          window.addEventListener('hashchange', () => {
            const next = parseHashRoute() || 'plan';
            setRoute(next);
          });
        }
      }
    }
  </script>
</body>

</html>



