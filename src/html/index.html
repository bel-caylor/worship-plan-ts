<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Songs</title>
  <?!= HtmlService.createHtmlOutputFromFile('html/styles').getContent(); ?>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="h-screen overflow-hidden"> <!-- no page scroll -->
  <div x-data="songsApp()" x-init="init()" class="h-full flex flex-col">
    <h1 class="text-3xl font-bold mb-4">Song List</h1>

    <!-- Sticky controls -->
    <div class="sticky top-0 z-10 bg-white/95 backdrop-blur border-b">
      <div class="p-4 flex flex-wrap items-center gap-3">

        <!-- Search Input -->
        <input type="search" placeholder="Filter (title, theme, scripture‚Ä¶)" class="border rounded px-3 py-2 w-80"
          x-model.debounce.200ms="q" @input="render()" />

        <!-- Lyric Checkbox -->
        <label class="inline-flex items-center gap-2 text-sm">
          <input type="checkbox" x-model="searchLyrics" @change="render()" />
          Search lyrics
        </label>

        <!-- Season dropdown -->
        <label class="text-sm">
          Season:
          <select class="border rounded px-2 py-1" x-model="selectedSeason" @change="render()">
            <option value="">All seasons</option>
            <template x-for="{key,label} in seasons" :key="key">
              <option :value="key" x-text="label"></option>
            </template>
          </select>
        </label>

        <!-- Leader dropdown -->
        <label class="text-sm">
          Leader:
          <select class="border rounded px-2 py-1" x-model="selectedLeader" @change="render()">
            <option value="">All leaders</option>
            <template x-for="name in leaderOptions" :key="name">
              <option :value="name" x-text="name"></option>
            </template>
          </select>
        </label>


        <span class="text-sm text-gray-700" x-text="`${filtered.length} of ${rows.length} shown`"></span>
        <span class="text-sm italic text-gray-500" x-show="loading">Loading‚Ä¶</span>
        <span class="text-sm text-red-600" x-text="error"></span>
      </div>
    </div>

    <!-- Content area fills the rest of the viewport; no page scroll -->
    <div class="flex-1 min-h-0 p-4">
      <div class="flex gap-4 h-full">
        <!-- LEFT PANE: table scrolls -->
        <div class="w-[350px] flex-shrink-0 h-full overflow-auto border rounded">
          <table class="min-w-full">
            <thead class="bg-gray-50 sticky top-0 z-10">
              <tr>
                <template x-for="h in tableHeaders" :key="h">
                  <th class="text-left px-3 py-2 cursor-pointer select-none" @click="sort(h)" x-text="h"></th>
                </template>
              </tr>
            </thead>
            <tbody>
              <template x-for="(r, i) in filtered" :key="i">
                <tr class="odd:bg-white even:bg-gray-50 hover:bg-indigo-50 cursor-pointer"
                  :class="selected === r ? 'ring-2 ring-indigo-400' : ''" @click="select(r)">
                  <template x-for="h in tableHeaders" :key="h">
                    <td class="px-3 py-2" x-text="format(r[h])"></td>
                  </template>
                </tr>
              </template>
              <tr x-show="!filtered.length">
                <td class="px-3 py-6 text-center text-gray-500" :colspan="tableHeaders.length">
                  No results
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- RIGHT PANE: Preview -->
        <div class="flex-1 h-full overflow-auto border rounded p-4">
          <div x-show="selected">
            <!-- HEADER -->
            <div class="flex items-start justify-between gap-3">
              <div>
                <h2 class="text-2xl font-semibold" x-text="selected?.Song || '(Untitled)'"></h2>

                <div class="mt-1 text-sm text-gray-600" x-show="selected?.Leader">
                  Leader: <span class="font-medium" x-text="selected?.Leader"></span>
                </div>

                <div class="mt-1 text-sm text-gray-600" x-show="selected?.Season">
                  Season: <span class="font-medium" x-text="selected?.Season"></span>
                </div>

                <div class="mt-1 text-sm text-gray-600" x-show="selected?.Themes">
                  Themes: <span class="font-medium" x-text="selected?.Themes"></span>
                </div>

                <div class="mt-1 text-sm text-gray-600" x-show="selected?.Scriptures">
                  Scriptures: <span class="font-medium" x-text="selected?.Scriptures"></span>
                </div>

                <div class="mt-1 text-sm text-gray-600" x-show="selected?.Keywords">
                  Keywords: <span class="font-medium" x-text="selected?.Keywords"></span>
                </div>
              </div>

              <div class="text-sm text-right text-gray-600">
                <div x-show="selected?.Uses">Uses: <span class="font-medium" x-text="selected?.Uses"></span></div>
                <div x-show="selected?.Usage">Usage: <span class="font-medium" x-text="selected?.Usage"></span></div>
                <div x-show="selected?.Years_Used">Years Used: <span class="font-medium"
                    x-text="selected?.Years_Used"></span></div>
                <div x-show="selected?.Last_Used">Last used: <span class="font-medium"
                    x-text="format(selected?.Last_Used)"></span></div>
                <div x-show="selected?.First_Used">First used: <span class="font-medium"
                    x-text="format(selected?.First_Used)"></span></div>
              </div>
            </div>

            <!-- MEDIA -->
            <div class="mt-4">
              <div class="text-sm font-medium text-gray-700 mb-1">Media</div>

              <div x-show="selected?._folderUrl" class="mb-2">
                <a class="inline-flex items-center gap-1 px-2 py-1 border rounded hover:bg-gray-50"
                  :href="selected._folderUrl" target="_blank" rel="noopener">
                  üìÅ <span>Open Folder</span>
                </a>
              </div>

              <div x-show="mediaLoading" class="text-sm text-gray-500">Loading files‚Ä¶</div>

              <ul x-show="!mediaLoading && mediaFiles.length" class="space-y-1">
                <template x-for="({name,url,mimeType}, i) in mediaFiles" :key="i">
                  <li>
                    <a class="underline" :href="url" target="_blank" rel="noopener">
                      <span x-text="fileIcon(mimeType)"></span>
                      <span x-text="name"></span>
                    </a>
                  </li>
                </template>
              </ul>

              <div x-show="!mediaLoading && !mediaFiles.length" class="text-sm text-gray-500">
                No files in folder.
              </div>
            </div>



            <!-- NOTES -->
            <div class="mt-3" x-show="selected?.Notes">
              <div class="text-sm font-medium text-gray-700 mb-1">Notes</div>
              <div class="text-sm whitespace-pre-wrap" x-text="selected?.Notes"></div>
            </div>

            <!-- LYRICS -->
            <div class="mt-4">
              <div class="flex items-center justify-between mb-1">
                <div class="text-sm font-medium text-gray-700">Lyrics</div>
                <button type="button" class="text-sm underline" @click="copy(selected['Lyrics (PD)'])">Copy</button>
              </div>
              <pre class="bg-gray-50 border rounded p-3 overflow-auto max-h-[60vh] whitespace-pre-wrap"
                x-text="selected?.['Lyrics (PD)'] || '(No lyrics)'"></pre>
            </div>
          </div>

          <div x-show="!selected" class="text-gray-500">Select a song to preview.</div>
        </div>

      </div>
    </div>

</body>
<script>window.__ROWS__ = <?!= rowsJson ?>;</script>

<script>
  // helper: split Season tokens
  const splitSeasons = (val) => String(val ?? '')
    .split(/[\/,;|]/g).map(s => s.trim()).filter(Boolean);
  const norm = (s) => s.toLowerCase();
  const title = (s) => s.replace(/\w\S*/g, w => w[0].toUpperCase() + w.slice(1).toLowerCase());

  function songsApp() {
    return {
      // data
      rows: window.__ROWS__ || [],
      filtered: [],
      selected: null,

      // which columns to show in the LEFT table
      tableHeaders: ['Song', 'Last_Used'],  // edit this list as you like

      // season dropdown
      seasons: [],            // [{key:'easter', label:'Easter'}, ...]
      selectedSeason: '',     // '' = all

      // search/sort
      q: '',
      searchLyrics: false,
      sortKey: 'Song',
      sortDir: 1,

      // status
      loading: false,
      error: '',

      mediaFiles: [],
      mediaLoading: false,
      leaderOptions: [],
      selectedLeader: '',


      fileIcon(m) {
        if (!m) return 'üìÑ';
        if (m.startsWith('audio/')) return 'üéµ';
        if (m.startsWith('video/')) return 'üé¨';
        if (m === 'application/pdf') return 'üìï';
        if (m.includes('presentation')) return 'üìä';
        if (m.includes('spreadsheet')) return 'üìà';
        if (m.includes('document')) return 'üìù';
        return 'üìÑ';
      },

      init() {
        // build season tokens
        const bucket = new Map();
        for (const r of this.rows) {
          for (const tok of splitSeasons(r['Season'])) {
            const k = norm(tok);
            if (k) bucket.set(k, title(tok));
          }
        }
        if (this.rows.some(r => !String(r['Season'] || '').trim())) {
          bucket.set('__uncat__', 'Uncategorized');
        }
        this.seasons = Array.from(bucket.entries())
          .sort((a, b) => a[1].localeCompare(b[1]))
          .map(([key, label]) => ({ key, label }));

        // Build unique leader list across rows (from _leaders arrays)
        const leaderSet = new Set();
        for (const r of this.rows) {
          const L = Array.isArray(r._leaders) ? r._leaders : [];
          for (const name of L) leaderSet.add(name);
        }
        this.leaderOptions = Array.from(leaderSet).sort((a, b) => a.localeCompare(b));


        this.render();
      },

      // selection
      select(row) {
        this.selected = row;
        this.mediaFiles = [];
        this.mediaLoading = false;
        const folderUrl = row?._folderUrl;
        if (folderUrl) {
          this.mediaLoading = true;
          google.script.run
            .withSuccessHandler((files) => {
              this.mediaFiles = Array.isArray(files) ? files : [];
              this.mediaLoading = false;
            })
            .withFailureHandler(err => {
              console.error(err);
              this.mediaLoading = false;
            })
            .getFilesForFolderUrl(folderUrl);
        }
      },

      // sorting
      sort(h) { this.sortKey === h ? this.sortDir *= -1 : (this.sortKey = h, this.sortDir = 1); this.render(true); },

      // render with filters/search/sort, and keep selection sane
      render(resetSelection = false) {
        const wantLeader = (this.selectedLeader || '').trim(); // ‚Üê add this

        const q = this.q.toLowerCase().trim();
        const want = this.selectedSeason;
        const baseFields = ['Song', 'Themes', 'Season', 'Keywords', 'Scriptures', 'Notes'];
        const fields = this.searchLyrics ? [...baseFields, 'Lyrics (PD)'] : baseFields;

        let out = this.rows.filter(r => {
          // season filter
          if (want) {
            const toks = splitSeasons(r['Season']).map(norm);
            const ok = want === '__uncat__' ? toks.length === 0 : toks.includes(want);
            if (!ok) return false;
          }
          // leader filter
          if (wantLeader) {
            const L = Array.isArray(r._leaders) ? r._leaders : [];
            if (!L.includes(wantLeader)) return false;
          }
          // text search
          if (!q) return true;
          for (const f of fields) {
            const v = r[f];
            if (v != null && String(v).toLowerCase().includes(q)) return true;
          }
          return false;
        });

        if (this.sortKey) {
          const k = this.sortKey, d = this.sortDir;
          out = out.slice().sort((a, b) => {
            const av = (a[k] ?? '').toString().toLowerCase();
            const bv = (b[k] ?? '').toString().toLowerCase();
            return av < bv ? -1 * d : av > bv ? 1 * d : 0;
          });
        }

        this.filtered = out;

        // maintain or reset selection
        if (resetSelection || !this.selected || !out.includes(this.selected)) {
          this.selected = out[0] || null;
        }
      },

      // formatting for table & preview
      format(v) {
        if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(v)) {
          const d = new Date(v); return d.toLocaleDateString();
        }
        return v ?? '';
      },

      // util: copy lyrics button
      async copy(text) {
        try { await navigator.clipboard.writeText(String(text ?? '')); }
        catch { /* ignore */ }
      }
    }
  }
</script>

</html>