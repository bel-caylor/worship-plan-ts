<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Worship Planner</title>

  <?!= HtmlService.createHtmlOutputFromFile('styles').getContent(); ?>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <script id="rows-json" type="application/json">
    <?!= JSON.stringify(rowsData).replace(/<\//g, '<\\/') ?>
  </script>
  <script id="services-json" type="application/json">
    <?!= JSON.stringify((servicesData && servicesData.items) ? servicesData.items : []).replace(/<\//g, '<\\/') ?>
  </script>
  <script>
    window.__ROWS__ = JSON.parse(document.getElementById('rows-json').textContent);
    try { window.__SERVICES__ = JSON.parse(document.getElementById('services-json').textContent); } catch(_) { window.__SERVICES__ = []; }
    // console.info('rows loaded:', Array.isArray(window.__ROWS__) && window.__ROWS__.length);
    // Prefer server-provided Web App URL; fallback to current location
    window.__BASE__ = <?!= JSON.stringify(typeof baseUrl !== 'undefined' ? baseUrl : '') ?> || (location.origin + location.pathname);
    // Guest mode injected by server (via ?mode=guest)
    window.__GUEST__ = <?!= JSON.stringify(typeof guestMode !== 'undefined' ? !!guestMode : false) ?>;
  </script>
  <?!= HtmlService.createHtmlOutputFromFile('util').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('context').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-songs').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-team').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-weekly-plan').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('apps-availability').getContent(); ?>

</head>

<body x-data="app()" x-init="init()" class="min-h-screen overflow-y-auto bg-gray-50">

  <!-- Topbar -->
  <?!= HtmlService.createHtmlOutputFromFile('topbar').getContent(); ?>

  <!-- Views stay mounted; tabs toggle visibility to preserve state -->
  <main class="min-h-[calc(100vh-56px)]">
    <div class="h-full">
      <template x-if="route==='songs'">
        <?!= HtmlService.createHtmlOutputFromFile('songs').getContent(); ?>
      </template>

      <div x-show="route==='plan'" class="h-full">
        <?!= HtmlService.createHtmlOutputFromFile('weekly-plan').getContent(); ?>
      </div>

      <div x-show="route==='team' && !window.__GUEST__" class="h-full">
        <?!= HtmlService.createHtmlOutputFromFile('team').getContent(); ?>
      </div>

      <div x-show="route==='availability'" class="h-full">
        <?!= HtmlService.createHtmlOutputFromFile('availability').getContent(); ?>
      </div>
    </div>
  </main>


  <script>
    function app() {
      return {
        route: 'plan',
        init() {
          const isGuest = !!(window.__GUEST__);
          const allowed = new Set(isGuest ? ['plan','songs','availability'] : ['plan','songs','team','availability']);
          const normalize = (value) => String(value || '').trim().toLowerCase();
          const parseHashRoute = () => normalize(location.hash.replace('#/', ''));
          const setRoute = (value) => {
            const next = allowed.has(value) ? value : 'plan';
            this.route = next;
          };
          const params = (() => {
            try { return new URLSearchParams(location.search || ''); }
            catch (_) { return null; }
          })();
          const paramRoute = params
            ? [params.get('tab'), params.get('route'), params.get('view')].map(normalize).find(Boolean) || ''
            : '';

          const initialHashRoute = parseHashRoute();
          if (initialHashRoute) {
            setRoute(initialHashRoute);
          } else if (paramRoute) {
            setRoute(paramRoute);
            if (!location.hash || location.hash === '#') {
              location.hash = `#/${this.route}`;
            }
          } else {
            setRoute('plan');
          }

          window.addEventListener('hashchange', () => {
            const next = parseHashRoute() || 'plan';
            setRoute(next);
          });
        }
      }
    }
  </script>
</body>

</html>



