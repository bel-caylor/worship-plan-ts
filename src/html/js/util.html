<script>
  const AUTH_STORAGE_KEY = '__wpAuthToken';

  function getStoredAuthToken() {
    if (typeof window === 'undefined') return '';
    try {
      const stored = window.sessionStorage?.getItem(AUTH_STORAGE_KEY) || '';
      return stored || window.__AUTH_TOKEN__ || '';
    } catch (_) {
      return window.__AUTH_TOKEN__ || '';
    }
  }

  function setStoredAuthToken(token) {
    window.__AUTH_TOKEN__ = token || '';
    if (typeof window === 'undefined') return;
    try {
      if (token) {
        window.sessionStorage?.setItem(AUTH_STORAGE_KEY, token);
      } else {
        window.sessionStorage?.removeItem(AUTH_STORAGE_KEY);
      }
    } catch (_) { /* ignore */ }
  }

  function handleAuthMessage(evt) {
    try {
      if (!evt || !evt.origin || !evt.origin.includes('script.google.com')) return;
      const data = evt.data;
      if (data && data.type === 'auth-token' && typeof data.token === 'string') {
        setStoredAuthToken(data.token);
        refreshAuthContext();
      }
    } catch (_) { }
  }

  window.addEventListener('message', handleAuthMessage, false);

  function openAdminLogin() {
    const base = window.__BASE__ || `${location.origin}${location.pathname}`;
    const loginUrl = `${base}${base.includes('?') ? '&' : '?'}view=login`;
    window.open(loginUrl, 'worship-admin-login', 'width=520,height=640');
  }

  window.openAdminLogin = openAdminLogin;

  function callRpc(method, payload) {
    return new Promise((resolve, reject) => {
      const runner = (window.google && google.script && google.script.run) || null;
      if (runner && runner.rpc) {
        runner
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .rpc({ method, payload });
        return;
      }

      const base = String(window.__BASE__ || '').replace(/\/+$/, '');
      if (!base) {
        reject(new Error('RPC endpoint is not configured.'));
        return;
      }

      const headers = Object.assign(
        { 'Content-Type': 'text/plain;charset=utf-8' },
        window.__RPC_HEADERS__ && typeof window.__RPC_HEADERS__ === 'object'
          ? window.__RPC_HEADERS__
          : {}
      );
      const authToken = getStoredAuthToken();
      if (authToken) {
        headers.Authorization = `Bearer ${authToken}`;
      }

      fetch(`${base}/exec`, {
        method: 'POST',
        mode: 'cors',
        credentials: 'omit',
        headers,
        body: JSON.stringify({ method, payload })
      })
        .then(async (res) => {
          let data = null;
          try { data = await res.json(); }
          catch (_) { throw new Error('Invalid RPC response'); }

          if (data && typeof data === 'object' && 'ok' in data) {
            if (data.ok) return data.data;
            throw new Error(data.error || 'RPC request failed');
          }
          return data;
        })
        .then(resolve)
        .catch((err) => reject(err));
    });
  }

  const forcedGuestFlag = (() => {
    try {
      const params = new URLSearchParams(window.location.search || '');
      const mode = String(params.get('mode') || params.get('view') || '').toLowerCase();
      return mode === 'guest';
    } catch (_) {
      return false;
    }
  })();

  const isLikelyLocalhost = (() => {
    try {
      const host = String(window.location.hostname || '').toLowerCase();
      if (!host) return false;
      if (host === 'localhost' || host === '127.0.0.1' || host === '0.0.0.0') return true;
      if (host.endsWith('.local')) return true;
      if (/^\d+\.\d+\.\d+\.\d+$/.test(host)) {
        if (host.startsWith('10.')) return true;
        if (host.startsWith('192.168.')) return true;
        if (/^172\.(1[6-9]|2\d|3[0-1])\./.test(host)) return true;
      }
      return false;
    } catch (_) {
      return false;
    }
  })();

  // Local dev helper: simulate an editor profile on localhost so tabs stay accessible.
  const devAuthOverride = (() => {
    if (forcedGuestFlag) return null;
    if (!isLikelyLocalhost) return null;
    try {
      const params = new URLSearchParams(window.location.search || '');
      const authParam = String(params.get('auth') || params.get('dev') || '').toLowerCase();
      if (authParam === 'off' || authParam === 'guest') return null;
    } catch (_) { /* ignore */ }
    try {
      const lsFlag = window.localStorage && window.localStorage.getItem && window.localStorage.getItem('wp.devAuthOverride');
      if (String(lsFlag || '').toLowerCase() === 'off') return null;
    } catch (_) { /* ignore */ }
    return {
      email: 'local.dev@worshipplanner.test',
      permissions: 'Administrator',
      first: 'Local',
      last: 'Dev',
      isAdmin: true,
      isLoggedIn: true,
      capabilities: {
        canViewPlan: true,
        canEditPlan: true,
        canEditSongs: true,
        canViewTeam: true,
        canManageTeams: true,
        canAdminAvailability: true
      },
      devOverride: true
    };
  })();

  let devOverrideNoticeShown = false;
  const applyDevAuthOverride = (profile) => {
    if (!devAuthOverride) return profile;
    const email = String(profile && profile.email || '').trim();
    const caps = profile && profile.capabilities;
    const hasCapabilities = !!(caps && (caps.canViewPlan || caps.canEditPlan || caps.canEditSongs || caps.canViewTeam || caps.canManageTeams || caps.canAdminAvailability));
    if (email || hasCapabilities) return profile;
    if (!devOverrideNoticeShown) {
      devOverrideNoticeShown = true;
      try {
        console.info('[auth] Local dev auth override enabled. Append "?mode=guest" or set localStorage["wp.devAuthOverride"]="off" to view as guest.');
      } catch (_) { /* ignore */ }
    }
    return Object.assign({}, devAuthOverride);
  };

  const DEFAULT_CAPABILITIES = {
    canEditPlan: false,
    canEditSongs: false,
    canViewTeam: false,
    canManageTeams: false,
    canAdminAvailability: false
  };
  const DEFAULT_AUTH = {
    email: '',
    permissions: '',
    first: '',
    last: '',
    isAdmin: false,
    isLoggedIn: false,
    capabilities: { ...DEFAULT_CAPABILITIES },
    ready: false
  };

  const dispatchAuthChanged = (auth) => {
    try {
      document.dispatchEvent(new CustomEvent('app-auth-changed', { detail: auth }));
    } catch (_) { /* ignore */ }
  };

  function normalizeAuthState(profile, ready = false) {
    const raw = profile && typeof profile === 'object' ? profile : {};
    const capabilities = Object.assign({}, DEFAULT_CAPABILITIES, raw.capabilities || {});
    const normalized = Object.assign({}, DEFAULT_AUTH, raw, {
      capabilities,
      ready: ready || Boolean(raw.ready)
    });
    if (typeof normalized.isLoggedIn !== 'boolean') {
      normalized.isLoggedIn = Boolean(normalized.email);
    }
    if (typeof normalized.isAdmin !== 'boolean') {
      normalized.isAdmin = Boolean(capabilities.canManageTeams);
    }
    return normalized;
  }

  function setAuthState(profile, { ready = false } = {}) {
    const effectiveProfile = applyDevAuthOverride(profile);
    const normalized = normalizeAuthState(effectiveProfile, ready || Boolean(effectiveProfile && effectiveProfile.devOverride));
    window.__AUTH__ = normalized;
    window.__GUEST__ = Boolean(window.__FORCE_GUEST__ || forcedGuestFlag || !normalized.capabilities.canEditPlan);
    dispatchAuthChanged(normalized);
    return normalized;
  }

  async function refreshAuthContext() {
    try {
      const profile = await callRpc('getViewerProfile', null);
      return setAuthState(profile, { ready: true });
    } catch (err) {
      console.warn('Auth check failed', err);
      const fallbackReady = Boolean(devAuthOverride);
      return setAuthState(window.__AUTH__ || DEFAULT_AUTH, { ready: fallbackReady });
    }
  }

  window.__FORCE_GUEST__ = forcedGuestFlag;
  const initialProfile = applyDevAuthOverride(typeof window.__VIEWER__ === 'object' ? window.__VIEWER__ : null);
  const initialReady = Boolean(window.__VIEWER__) || Boolean(initialProfile && initialProfile.devOverride);
  window.__AUTH__ = normalizeAuthState(initialProfile, initialReady);
  window.__GUEST__ = Boolean(window.__FORCE_GUEST__ || !window.__AUTH__.capabilities.canEditPlan);
  dispatchAuthChanged(window.__AUTH__);
  refreshAuthContext();
  window.refreshAuthContext = refreshAuthContext;

  // Minimal toast-style notifier for consistent UX (client-only)
  function notify(message, type = 'info', ms = 2200) {
    try {
      const root = document.createElement('div');
      root.textContent = String(message ?? '');
      root.style.position = 'fixed';
      root.style.right = '12px';
      root.style.bottom = '12px';
      root.style.zIndex = '9999';
      root.style.maxWidth = '70vw';
      root.style.padding = '8px 12px';
      root.style.borderRadius = '6px';
      root.style.color = '#111827';
      root.style.background = type === 'error' ? '#fecaca' : type === 'success' ? '#bbf7d0' : '#e5e7eb';
      root.style.boxShadow = '0 4px 14px rgba(0,0,0,0.2)';
      document.body.appendChild(root);
      setTimeout(() => root.remove(), ms);
    } catch (_) {
      try { alert(String(message ?? '')); } catch(_) {}
    }
  }

  (function (global) {
    if (global && typeof global.songPreview === 'function') return;
    function normalizePreview(data) {
      if (!data || !data.hasSong) return { hasSong: false };
      return {
        hasSong: true,
        songName: data.song?.Song || data.songName || '(Untitled)',
        reason: data.song?.Reason || data.reason || '',
        leader: data.song?.Leader || data.leader || '',
        season: data.song?.Season || data.season || '',
        themes: data.song?.Themes || data.themes || '',
        scriptures: data.song?.Scriptures || data.scriptures || '',
        keywords: data.song?.Keywords || data.keywords || '',
        lyrics: data.song?.Lyrics || data.song?.['Lyrics (PD)'] || data.lyrics || '',
        aiReason: data.aiReason || '',
        additional: data.additional || '',
        showUse: !!data.isModalContext,
        onUse: typeof data.useSong === 'function' ? () => data.useSong() : null,
        onCopy: typeof data.onCopy === 'function'
          ? (evt) => data.onCopy(evt)
          : (typeof data.copyLyrics === 'function' ? (evt) => data.copyLyrics(evt) : null),
        link: data.song?.Link || data.link || '',
        showMedia: !!data.mediaFiles,
        mediaFiles: Array.isArray(data.mediaFiles) ? data.mediaFiles : [],
        mediaLoading: !!data.mediaLoading,
        mediaMessage: data.mediaMessage || 'No files in folder.',
        stats: {
          uses: data.stats?.uses || data.song?.Uses || '',
          usage: data.stats?.usage || data.song?.Usage || '',
          years: data.stats?.years || data.song?.Years_Used || '',
          lastUsed: data.stats?.lastUsed || data.song?.Last_Used || '',
          firstUsed: data.stats?.firstUsed || data.song?.First_Used || ''
        },
        folderUrl: data.song?._folderUrl || '',
        onOpenFolder: typeof data.openFolder === 'function' ? () => data.openFolder(data.song?._folderUrl) : null,
        starred: !!data.starred,
        onToggleStar: typeof data.onToggleStar === 'function' ? (evt) => data.onToggleStar(evt) : null
      };
    }
    global.songPreview = function songPreview(initial = {}) {
      return {
        preview: normalizePreview(initial),
        update(data) {
          this.preview = normalizePreview(data);
        }
      };
    };
  })(typeof window !== 'undefined' ? window : this);
</script>
