<script>
  function callRpc(method, payload) {
    return new Promise((resolve, reject) => {
      const runner = (window.google && google.script && google.script.run) || null;
      if (runner && runner.rpc) {
        runner
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .rpc({ method, payload });
        return;
      }

      const base = String(window.__BASE__ || '').replace(/\/+$/, '');
      if (!base) {
        reject(new Error('RPC endpoint is not configured.'));
        return;
      }

      const headers = Object.assign(
        { 'Content-Type': 'text/plain;charset=utf-8' },
        window.__RPC_HEADERS__ && typeof window.__RPC_HEADERS__ === 'object'
          ? window.__RPC_HEADERS__
          : {}
      );

      fetch(`${base}/exec`, {
        method: 'POST',
        mode: 'cors',
        credentials: 'omit',
        headers,
        body: JSON.stringify({ method, payload })
      })
        .then(async (res) => {
          let data = null;
          try { data = await res.json(); }
          catch (_) { throw new Error('Invalid RPC response'); }

          if (data && typeof data === 'object' && 'ok' in data) {
            if (data.ok) return data.data;
            throw new Error(data.error || 'RPC request failed');
          }
          return data;
        })
        .then(resolve)
        .catch((err) => reject(err));
    });
  }

  // Minimal toast-style notifier for consistent UX (client-only)
  function notify(message, type = 'info', ms = 2200) {
    try {
      const root = document.createElement('div');
      root.textContent = String(message ?? '');
      root.style.position = 'fixed';
      root.style.right = '12px';
      root.style.bottom = '12px';
      root.style.zIndex = '9999';
      root.style.maxWidth = '70vw';
      root.style.padding = '8px 12px';
      root.style.borderRadius = '6px';
      root.style.color = '#111827';
      root.style.background = type === 'error' ? '#fecaca' : type === 'success' ? '#bbf7d0' : '#e5e7eb';
      root.style.boxShadow = '0 4px 14px rgba(0,0,0,0.2)';
      document.body.appendChild(root);
      setTimeout(() => root.remove(), ms);
    } catch (_) {
      try { alert(String(message ?? '')); } catch(_) {}
    }
  }
</script>
