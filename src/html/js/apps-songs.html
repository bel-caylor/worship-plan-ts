<script>
  // Alpine app for the Songs view, separated so it's available before template mounts
  function songsApp() {
    // helpers
    const splitSeasons = (val) => String(val ?? '').split(/[\/,;|]/g).map(s => s.trim()).filter(Boolean);
    const norm = (s) => String(s || '').toLowerCase();
    const title = (s) => String(s || '').replace(/\w\S*/g, w => w[0].toUpperCase() + w.slice(1).toLowerCase());

    return {
      // data
      rows: window.__ROWS__ || [],
      filtered: [],
      selected: null,

      tableHeaders: ['Song', 'Last_Used'],

      seasons: [],
      selectedSeason: '',

      q: '',
      searchLyrics: false,
      sortKey: 'Song',
      sortDir: 1,

      loading: false,
      error: '',

      mediaFiles: [],
      mediaLoading: false,
      leaderOptions: [],
      selectedLeader: '',

      fileIcon(m) {
        if (!m) return '📄';
        if (m.startsWith('audio/')) return '🎵';
        if (m.startsWith('video/')) return '🎬';
        if (m === 'application/pdf') return '📄';
        if (m.includes('presentation')) return '📽️';
        if (m.includes('spreadsheet')) return '📈';
        if (m.includes('document')) return '📄';
        return '📁';
      },

      init() {
        // seasons
        const bucket = new Map();
        for (const r of this.rows) {
          for (const tok of splitSeasons(r['Season'])) {
            const k = norm(tok);
            if (k) bucket.set(k, title(tok));
          }
        }
        if (this.rows.some(r => !String(r['Season'] || '').trim())) bucket.set('__uncat__', 'Uncategorized');
        this.seasons = Array.from(bucket.entries())
          .sort((a, b) => a[1].localeCompare(b[1]))
          .map(([key, label]) => ({ key, label }));

        // leader options
        const leaderSet = new Set();
        for (const r of this.rows) {
          const L = Array.isArray(r._leaders) ? r._leaders : [];
          for (const name of L) leaderSet.add(name);
        }
        this.leaderOptions = Array.from(leaderSet).sort((a, b) => a.localeCompare(b));

        this.$watch('q', () => this.render(true));
        this.$watch('selectedSeason', () => this.render(true));
        this.$watch('selectedLeader', () => this.render(true));
        this.$watch('searchLyrics', () => this.render(true));

        this.render();
      },

      select(row) {
        this.selected = row;
        this.mediaFiles = [];
        const url = row && row._folderUrl;
        if (!url) return;
        this.mediaLoading = true;
        Promise.resolve()
          .then(() => callRpc('getFilesForFolderUrl', url))
          .then((files) => { this.mediaFiles = Array.isArray(files) ? files : []; })
          .catch(() => { this.mediaFiles = []; })
          .finally(() => { this.mediaLoading = false; });
      },

      sort(h) { this.sortKey === h ? this.sortDir *= -1 : (this.sortKey = h, this.sortDir = 1); this.render(true); },

      render(resetSelection = false) {
        const wantLeader = (this.selectedLeader || '').trim();
        const q = this.q.toLowerCase().trim();
        const want = this.selectedSeason;
        const baseFields = ['Song', 'Themes', 'Season', 'Keywords', 'Scriptures', 'Notes'];
        const fields = this.searchLyrics ? [...baseFields, 'Lyrics (PD)'] : baseFields;

        let out = this.rows.filter(r => {
          if (want) {
            const toks = splitSeasons(r['Season']).map(norm);
            const ok = want === '__uncat__' ? toks.length === 0 : toks.includes(want);
            if (!ok) return false;
          }
          if (wantLeader) {
            const L = Array.isArray(r._leaders) ? r._leaders : [];
            if (!L.includes(wantLeader)) return false;
          }
          if (!q) return true;
          for (const f of fields) {
            const v = r[f];
            if (v != null && String(v).toLowerCase().includes(q)) return true;
          }
          return false;
        });

        if (this.sortKey) {
          const k = this.sortKey, d = this.sortDir;
          out = out.slice().sort((a, b) => {
            const av = (a[k] ?? '').toString().toLowerCase();
            const bv = (b[k] ?? '').toString().toLowerCase();
            return av < bv ? -1 * d : av > bv ? 1 * d : 0;
          });
        }

        this.filtered = out;
        if (resetSelection || !this.selected || !out.includes(this.selected)) this.selected = out[0] || null;
      },

      format(v) {
        if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(v)) { const d = new Date(v); return d.toLocaleDateString(); }
        return v ?? '';
      },

      async copy(text) { try { await navigator.clipboard.writeText(String(text ?? '')); } catch { } }
    }
  }
</script>

