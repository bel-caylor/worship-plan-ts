<div data-songs-browser-root class="flex-1 min-h-0 flex flex-col w-full">
    <h1 class="text-3xl font-bold mb-4 text-center hidden">Song List</h1>

    <!-- Sticky controls -->
    <div class="sticky top-0 z-10 bg-white/95 backdrop-blur border-b">
        <div class="p-4 flex items-center gap-4 bg-gray-100">

            <!-- Search Input -->
            <input type="search" placeholder="Filter (title, theme, scripture…)"
                class="hidden xl:block form-control w-80 flex-1" x-model.debounce.200ms="q"
                @search="render(true)" />


            <!-- Mobile Filters trigger -->
            <button type="button" class="xl:hidden btn btn--muted btn--lg"
                @click="filtersOpen = true">Filters</button>

            <!-- Options/Filters group for md+ -->
            <div class="hidden xl:flex items-center gap-4">
                <!-- Options Dropdown -->
                <div class="relative" x-data="{ open: false }">
                    <button type="button"
                        class="btn btn--muted btn--xs"
                        @click="open = !open">
                        Options
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="open" x-cloak @click.outside="open = false"
                        class="absolute z-20 mt-1 w-48 bg-white border rounded shadow">
                        <label class="flex items-center gap-2 px-3 py-2 text-sm border-b">
                            <input type="checkbox" x-model="searchLyrics" @change="render()" />
                            Lyrics
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 text-sm border-b">
                            <input type="checkbox" x-model="spanishOnly" @change="render(true)" />
                            Spanish
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 text-sm">
                            <input type="checkbox" x-model="showArchived" @change="render(true)" />
                            Archived
                        </label>
                    </div>
                </div>

                <!-- Season dropdown -->
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600 text-center sr-only">Season</span>
                    <select class="form-control form-control--dense" x-model="selectedSeason" @change="render()">
                        <option value="">All seasons</option>
                        <template x-for="{key,label} in seasons" :key="key">
                            <option :value="key" x-text="label"></option>
                        </template>
                    </select>
                </label>

                <!-- Leader dropdown -->
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600 text-center sr-only">Leader</span>
                    <select class="form-control form-control--dense" x-model="selectedLeader" @change="render()">
                        <option value="">All leaders</option>
                        <template x-for="name in leaderOptions" :key="name">
                            <option :value="name" x-text="name"></option>
                        </template>
                    </select>
                </label>

                <!-- Usage dropdown -->
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600 text-center sr-only">Usage</span>
                    <select class="form-control form-control--dense" x-model="selectedUsage" @change="render()">
                        <option value="">All usage</option>
                        <template x-for="u in usageOptions" :key="u">
                            <option :value="u" x-text="u"></option>
                        </template>
                    </select>
                </label>
            </div>


            <div class="flex flex-wrap items-center gap-2 ml-auto">
                <span class="text-sm text-gray-700" x-text="`${filtered.length} of ${rows.length}`"></span>
                <span class="text-sm italic text-gray-500" x-show="loading">Loading…</span>
                <span class="text-sm text-red-600" x-text="error"></span>
                <button type="button"
                    class="btn btn--outline btn--xs text-amber-700"
                    @click="clearStarred()"
                    :disabled="!starredTitles || !starredTitles.size">
                    Clear stars
                </button>
                <template x-if="!isGuest && !isModalContext && !isEmbedded">
                    <button type="button"
                        class="btn btn--muted btn--lg"
                        @click="openSongEditor('edit')" :disabled="!selected" title="Edit song" aria-label="Edit song">
                        <!-- icon below xl, label on xl+ -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            class="h-5 w-5 xl:hidden">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536M16.5 3.964a2.25 2.25 0 113.182 3.182L7.5 19.5 3 21l1.5-4.5L16.5 3.964z" />
                        </svg>
                        <span class="hidden xl:inline">Edit song</span>
                    </button>
                </template>
                <template x-if="!isGuest && !isModalContext && !isEmbedded">
                    <button type="button"
                        class="btn btn--accent-soft btn--lg"
                        @click="openSongEditor('create')" title="Add song" aria-label="Add song">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            class="h-5 w-5 xl:hidden">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span class="hidden xl:inline">Add song</span>
                    </button>
                </template>
                <button type="button"
                    class="md:hidden btn btn--muted btn--lg"
                    @click="mobileListOpen = true" title="Browse songs" aria-label="Browse songs">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        class="h-5 w-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-4.35-4.35M10 18a8 8 0 110-16 8 8 0 010 16z" />
                    </svg>
                    <span class="hidden xl:inline">Browse songs</span>
                </button>
            </div>
        </div>
    </div>
    <!-- Mobile Filters sheet -->
    <div x-show="filtersOpen" x-cloak class="fixed inset-0 z-50 xl:hidden">
        <div class="absolute inset-0 bg-black/40" @click="filtersOpen=false"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-xl shadow-lg p-4 space-y-3">
            <div class="flex items-center justify-between">
                <div class="font-semibold">Filters</div>
                <button type="button" class="btn btn--link" @click="filtersOpen=false">Close</button>
            </div>
            <div class="grid grid-cols-1 gap-3">
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600">Keyword</span>
                    <input type="search" class="form-control"
                        placeholder="Filter (title, theme, scripture...)" x-model.debounce.200ms="q"
                        @search="render(true)" />
                </label>
                <label class="text-sm flex items-center gap-2">
                    <input type="checkbox" x-model="searchLyrics" @change="render()" />
                    <span>Lyrics</span>
                </label>
                <label class="text-sm flex items-center gap-2">
                    <input type="checkbox" x-model="spanishOnly" @change="render(true)" />
                    <span>Spanish</span>
                </label>
                <label class="text-sm flex items-center gap-2">
                    <input type="checkbox" x-model="showArchived" @change="render(true)" />
                    <span>Archived</span>
                </label>
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600">Season</span>
                    <select class="form-control form-control--dense" x-model="selectedSeason" @change="render()">
                        <option value="">All seasons</option>
                        <template x-for="{key,label} in seasons" :key="key">
                            <option :value="key" x-text="label"></option>
                        </template>
                    </select>
                </label>
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600">Leader</span>
                    <select class="form-control form-control--dense" x-model="selectedLeader" @change="render()">
                        <option value="">All leaders</option>
                        <template x-for="name in leaderOptions" :key="name">
                            <option :value="name" x-text="name"></option>
                        </template>
                    </select>
                </label>
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600">Usage</span>
                    <select class="form-control form-control--dense" x-model="selectedUsage" @change="render()">
                        <option value="">All usage</option>
                        <template x-for="u in usageOptions" :key="u">
                            <option :value="u" x-text="u"></option>
                        </template>
                    </select>
                </label>
            </div>
        </div>
    </div>
</div>
<!-- Content area fills the rest of the viewport; no page scroll -->
<div class="h-full min-h-0 p-4 z-0" :class="isModalContext ? 'mt-14' : 'mt-16'">
    <div class="flex gap-4 h-full relative">
        <!-- LEFT PANE: table scrolls -->
        <div class="hidden md:block w-[220px] lg:w-[380px] flex-shrink-0 h-full overflow-auto border rounded">
            <table class="app-table">
                <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr>
                        <th class="w-8 text-center text-xs">★</th>
                        <template x-for="h in tableHeaders" :key="h">
                            <th class="text-left py-2 cursor-pointer select-none" @click="sort(h)">
                                <span class="inline-block w-4 text-xs align-top text-right"
                                    x-html="headerIcon(h)"></span>
                                <span x-text="headerLabel(h)"></span>
                            </th>
                        </template>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="(r, i) in filtered" :key="r._uid || normalizeTitle(r?.Song) || i">
                        <tr class="odd:bg-white even:bg-gray-50 hover:bg-indigo-50 cursor-pointer transition"
                            :class="[selected === r ? 'ring-2 ring-indigo-400' : '', isAiSuggestion(r) ? 'border-l-4 border-amber-400 bg-amber-50/70' : '', isStarred(r) ? 'bg-blue-50/60' : '']"
                            @click="select(r)">
                            <td class="px-2 py-2 text-center align-middle">
                                <button type="button" class="text-lg leading-none"
                                  :class="isStarred(r) ? 'text-amber-500' : 'text-gray-300 hover:text-amber-500'"
                                  title="Toggle star" @click.stop="toggleStar(r)">
                                  ★
                                </button>
                            </td>
                            <template x-for="h in tableHeaders" :key="h">
                                <td class="px-3 py-2 text-xs lg:text-sm" x-text="format(r[h])"></td>
                            </template>
                        </tr>
                    </template>
                    <tr x-show="!filtered.length">
                        <td class="px-3 py-6 text-center text-gray-500" :colspan="tableHeaders.length + 1">
                            No results
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- RIGHT PANE: Preview -->
        <div class="flex-1 h-full overflow-auto border rounded p-4">
                    <div x-data="songPreview(songBrowserPreviewContext())"
                      x-init="update(songBrowserPreviewContext())"
                      x-effect="update(songBrowserPreviewContext())">
                        <template x-if="preview?.hasSong">
                          <div class="h-full flex flex-col gap-4">
                            <div class="flex items-start justify-between gap-4">
                              <div class="space-y-2 text-sm text-gray-600">
                                <div x-show="preview.aiReason" class="text-xs uppercase tracking-wide font-semibold text-amber-700">
                                  AI suggestion
                                </div>
                                <div x-show="preview.aiReason" class="text-sm text-gray-700" x-text="preview.aiReason"></div>
                                <h3 class="text-3xl font-semibold text-blue-900" x-text="preview.songName || '(Untitled)'"></h3>
                                <div x-show="preview.reason">
                                  <span class="font-medium text-gray-700">Reason:</span>
                                  <span x-text="preview.reason"></span>
                                </div>
                                <div class="flex flex-wrap gap-x-8 gap-y-1">
                                  <div x-show="preview.leader">Leader: <span class="font-semibold" x-text="preview.leader"></span></div>
                                  <div x-show="preview.season">Season: <span class="font-semibold" x-text="preview.season"></span></div>
                                </div>
                                <div class="flex flex-wrap gap-x-8 gap-y-1">
                                  <div x-show="preview.themes">Themes: <span class="font-semibold" x-text="preview.themes"></span></div>
                                  <div x-show="preview.scriptures">Scriptures: <span class="font-semibold" x-text="preview.scriptures"></span></div>
                                </div>
                                <div x-show="preview.keywords">
                                  Keywords: <span class="font-semibold" x-text="preview.keywords"></span>
                                </div>
                              </div>
                              <div class="text-sm text-right text-gray-600 space-y-1 flex flex-col items-end">
                                <button type="button" class="btn btn--outline btn--xs" x-show="preview.onToggleStar"
                                  @click="preview.onToggleStar?.()">
                                  <span x-text="preview.starred ? '★ Starred' : '☆ Star'"></span>
                                </button>
                                <button type="button" class="btn btn--outline btn--xs" x-show="preview.showUse" @click="preview.onUse?.()">
                                  Use This Song
                                </button>
                                <button type="button" class="btn btn--link btn--sm text-blue-700" x-show="preview.onCopy" @click="preview.onCopy?.($event)">
                                  Copy Lyrics
                                </button>
                                <a class="text-sm text-blue-700 hover:underline" x-show="preview.link" :href="preview.link" target="_blank" rel="noopener">
                                  Song Link
                                </a>
                                <a class="text-sm text-blue-700 hover:underline" x-show="preview.folderUrl" :href="preview.folderUrl" target="_blank" rel="noopener">
                                  Open Folder
                                </a>
                                <div x-show="preview.stats?.uses">Uses: <span class="font-semibold" x-text="preview.stats.uses"></span></div>
                                <div x-show="preview.stats?.usage">Usage: <span class="font-semibold" x-text="preview.stats.usage"></span></div>
                                <div x-show="preview.stats?.years">Years: <span class="font-semibold" x-text="preview.stats.years"></span></div>
                                <div x-show="preview.stats?.lastUsed">Last used: <span class="font-semibold" x-text="preview.stats.lastUsed"></span></div>
                                <div x-show="preview.stats?.firstUsed">First used: <span class="font-semibold" x-text="preview.stats.firstUsed"></span></div>
                              </div>
                            </div>
                            <div class="flex-1 flex flex-col">
                              <div class="text-sm font-medium text-gray-700 mb-1">Lyrics</div>
                              <pre class="flex-1 bg-gray-50 border rounded p-3 overflow-auto whitespace-pre-wrap"
                                x-text="preview.lyrics || 'Lyrics preview will appear after selecting a song.'"></pre>
                            </div>
                            <div>
                              <div class="text-sm font-medium text-gray-700 mb-1">Media</div>
                              <div class="text-sm text-gray-500" x-show="preview.mediaLoading">Loading files...</div>
                              <ul x-show="!preview.mediaLoading && preview.mediaFiles && preview.mediaFiles.length" class="space-y-1">
                                <template x-for="(file, idx) in preview.mediaFiles" :key="idx">
                                  <li class="text-sm">
                                    <a class="text-blue-600 hover:underline inline-flex items-center gap-2" :href="file.url" target="_blank" rel="noopener">
                                      <span x-text="file.icon"></span>
                                      <span x-text="file.label"></span>
                                    </a>
                                  </li>
                                </template>
                              </ul>
                              <div class="text-sm text-gray-500" x-show="!preview.mediaLoading && (!preview.mediaFiles || !preview.mediaFiles.length)"
                                x-text="preview.mediaMessage || 'No files in folder.'"></div>
                            </div>
                          </div>
                        </template>
                        <template x-if="!preview?.hasSong">
                          <div class="text-sm text-gray-500">Select a song to preview.</div>
                        </template>
                    </div>
        </div>

    </div>
</div>

<!-- Song editor modal -->
<div x-show="showSongEditor" x-cloak class="modal-overlay z-50" @click.self="cancelSongEditor()">
    <div class="modal-panel max-w-3xl w-[95vw] max-h-[90vh] overflow-y-auto">
        <div class="px-4 py-3 border-b flex items-center justify-between">
            <div class="font-semibold" x-text="songEditorMode === 'edit' ? 'Edit Song' : 'Add Song'"></div>
            <button type="button" class="btn btn--link"
                @click="cancelSongEditor()">Close</button>
        </div>
        <form class="p-4 space-y-4" @submit.prevent="saveSongEditor()">
            <div class="grid md:grid-cols-2 gap-4">
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Song title</span>
                    <input type="text" class="form-control" x-model="songForm.Song" x-ref="songTitle"
                        required>
                </label>
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Leader(s)</span>
                    <input type="text" class="form-control" x-model="songForm.Leader"
                        placeholder="Comma separated">
                </label>
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Season</span>
                    <input type="text" class="form-control" x-model="songForm.Season">
                </label>
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Usage</span>
                    <input type="text" class="form-control" x-model="songForm.Usage">
                </label>
                <label class="text-sm flex flex-col gap-1 md:col-span-2">
                    <span class="font-medium text-gray-700">Themes</span>
                    <input type="text" class="form-control" x-model="songForm.Themes"
                        placeholder="Comma separated">
                </label>
                <label class="text-sm flex flex-col gap-1 md:col-span-2">
                    <span class="font-medium text-gray-700">Keywords</span>
                    <input type="text" class="form-control" x-model="songForm.Keywords"
                        placeholder="Comma separated">
                </label>
                <label class="text-sm flex flex-col gap-1 md:col-span-2">
                    <span class="font-medium text-gray-700">Scriptures</span>
                    <input type="text" class="form-control" x-model="songForm.Scriptures"
                        placeholder="Comma separated">
                </label>
                <label class="text-sm flex flex-col gap-1 md:col-span-2">
                    <span class="font-medium text-gray-700">Link</span>
                    <input type="url" class="form-control" x-model="songForm.Link"
                        placeholder="https://...">
                </label>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Notes</span>
                    <textarea class="form-control min-h-[80px]" x-model="songForm.Notes"></textarea>
                </label>
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Lyrics</span>
                    <textarea class="form-control min-h-[120px]" x-model="songForm.Lyrics"></textarea>
                </label>
            </div>
            <div class="flex items-center gap-4">
                <label class="inline-flex items-center gap-2 text-sm">
                    <input type="checkbox" x-model="songForm.Sp">
                    Spanish
                </label>
                <label class="inline-flex items-center gap-2 text-sm">
                    <input type="checkbox" x-model="songForm.Archive">
                    Archived
                </label>
            </div>
            <div class="text-sm text-rose-600" x-show="songEditorError" x-text="songEditorError"></div>
            <div class="flex justify-end gap-2 pt-2">
                <button type="button" class="btn btn--muted btn--lg" @click="cancelSongEditor()"
                    :disabled="songEditorSaving">Cancel</button>
                <button type="submit" class="btn btn--accent btn--lg"
                    :disabled="songEditorSaving">
                    <span x-show="!songEditorSaving">Save song</span>
                    <span x-show="songEditorSaving">Saving…</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Mobile song list overlay -->
<div class="md:hidden" x-show="mobileListOpen" x-transition.opacity x-cloak>
    <div class="fixed inset-0 bg-black/40 z-40" @click="mobileListOpen = false"></div>
    <div class="fixed inset-y-0 left-0 right-0 z-50 flex">
        <div class="ml-auto h-full w-full max-w-md bg-white shadow-xl border-l flex flex-col">
            <div class="px-4 py-3 border-b flex items-center justify-between">
                <div class="font-semibold">Select a song</div>
                <button type="button" class="btn btn--link"
                    @click="mobileListOpen = false">Close</button>
            </div>
            <div class="flex-1 overflow-auto">
                <table class="app-table">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <template x-for="h in tableHeaders" :key="h">
                                <th class="text-left py-2 cursor-pointer select-none px-3" @click="sort(h)">
                                    <span class="inline-block w-4 text-xs align-middle" x-html="headerIcon(h)"></span>
                                    <span x-text="headerLabel(h)"></span>
                                </th>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(r, i) in filtered" :key="i">
                            <tr class="odd:bg-white even:bg-gray-50 hover:bg-indigo-50 cursor-pointer"
                                :class="selected === r ? 'ring-2 ring-indigo-400' : ''" @click="select(r)">
                                <template x-for="h in tableHeaders" :key="h">
                                    <td class="px-3 py-2" x-text="format(r[h])"></td>
                                </template>
                            </tr>
                        </template>
                        <tr x-show="!filtered.length">
                            <td class="px-3 py-6 text-center text-gray-500" :colspan="tableHeaders.length">
                                No results
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
