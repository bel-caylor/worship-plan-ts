<div data-songs-browser-root class="flex-1 min-h-0 flex flex-col w-full">
    <h1 class="text-3xl font-bold mb-4 text-center hidden">Song List</h1>

    <!-- Sticky controls -->
    <div class="sticky top-0 z-10 bg-white/95 backdrop-blur border-b">
        <div class="p-4 flex items-center gap-4 bg-gray-100">

            <!-- Search Input -->
            <input type="search" placeholder="Filter (title, theme, scripture…)"
                class="hidden xl:block border rounded px-3 py-2 w-80 flex-1" x-model.debounce.200ms="q"
                @search="render(true)" />


            <!-- Mobile Filters trigger -->
            <button type="button" class="xl:hidden px-3 py-2 border rounded bg-white hover:bg-gray-50"
                @click="filtersOpen = true">Filters</button>

            <!-- Options/Filters group for md+ -->
            <div class="hidden xl:flex items-center gap-4">
                <!-- Options Dropdown -->
                <div class="relative" x-data="{ open: false }">
                    <button type="button"
                        class="px-3 py-[2px] border rounded bg-white hover:bg-gray-50 flex items-center gap-2"
                        @click="open = !open">
                        Options
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="open" x-cloak @click.outside="open = false"
                        class="absolute z-20 mt-1 w-48 bg-white border rounded shadow">
                        <label class="flex items-center gap-2 px-3 py-2 text-sm border-b">
                            <input type="checkbox" x-model="searchLyrics" @change="render()" />
                            Lyrics
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 text-sm border-b">
                            <input type="checkbox" x-model="spanishOnly" @change="render(true)" />
                            Spanish
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 text-sm">
                            <input type="checkbox" x-model="showArchived" @change="render(true)" />
                            Archived
                        </label>
                    </div>
                </div>

                <!-- Season dropdown -->
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600 text-center sr-only">Season</span>
                    <select class="border rounded px-2 py-1" x-model="selectedSeason" @change="render()">
                        <option value="">All seasons</option>
                        <template x-for="{key,label} in seasons" :key="key">
                            <option :value="key" x-text="label"></option>
                        </template>
                    </select>
                </label>

                <!-- Leader dropdown -->
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600 text-center sr-only">Leader</span>
                    <select class="border rounded px-2 py-1" x-model="selectedLeader" @change="render()">
                        <option value="">All leaders</option>
                        <template x-for="name in leaderOptions" :key="name">
                            <option :value="name" x-text="name"></option>
                        </template>
                    </select>
                </label>

                <!-- Usage dropdown -->
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600 text-center sr-only">Usage</span>
                    <select class="border rounded px-2 py-1" x-model="selectedUsage" @change="render()">
                        <option value="">All usage</option>
                        <template x-for="u in usageOptions" :key="u">
                            <option :value="u" x-text="u"></option>
                        </template>
                    </select>
                </label>
            </div>


            <div class="flex flex-wrap items-center gap-2 ml-auto">
                <span class="text-sm text-gray-700" x-text="`${filtered.length} of ${rows.length}`"></span>
                <span class="text-sm italic text-gray-500" x-show="loading">Loading…</span>
                <span class="text-sm text-red-600" x-text="error"></span>
                <template x-if="!isGuest && !isModalContext">
                    <button type="button"
                        class="px-3 py-2 border rounded bg-white hover:bg-gray-50 flex items-center gap-2"
                        @click="openSongEditor('edit')" :disabled="!selected" title="Edit song" aria-label="Edit song">
                        <!-- icon below xl, label on xl+ -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            class="h-5 w-5 xl:hidden">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536M16.5 3.964a2.25 2.25 0 113.182 3.182L7.5 19.5 3 21l1.5-4.5L16.5 3.964z" />
                        </svg>
                        <span class="hidden xl:inline">Edit song</span>
                    </button>
                </template>
                <template x-if="!isGuest && !isModalContext">
                    <button type="button"
                        class="px-3 py-2 border rounded bg-emerald-50 text-emerald-700 hover:bg-emerald-100 flex items-center gap-2"
                        @click="openSongEditor('create')" title="Add song" aria-label="Add song">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            class="h-5 w-5 xl:hidden">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span class="hidden xl:inline">Add song</span>
                    </button>
                </template>
                <button type="button"
                    class="md:hidden px-3 py-2 border rounded bg-white hover:bg-gray-50 flex items-center gap-2"
                    @click="mobileListOpen = true" title="Browse songs" aria-label="Browse songs">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        class="h-5 w-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-4.35-4.35M10 18a8 8 0 110-16 8 8 0 010 16z" />
                    </svg>
                    <span class="hidden xl:inline">Browse songs</span>
                </button>
            </div>
        </div>
    </div>
    <!-- Mobile Filters sheet -->
    <div x-show="filtersOpen" x-cloak class="fixed inset-0 z-50 xl:hidden">
        <div class="absolute inset-0 bg-black/40" @click="filtersOpen=false"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-xl shadow-lg p-4 space-y-3">
            <div class="flex items-center justify-between">
                <div class="font-semibold">Filters</div>
                <button type="button" class="text-sm underline" @click="filtersOpen=false">Close</button>
            </div>
            <div class="grid grid-cols-1 gap-3">
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600">Keyword</span>
                    <input type="search" class="border rounded px-3 py-2"
                        placeholder="Filter (title, theme, scripture...)" x-model.debounce.200ms="q"
                        @search="render(true)" />
                </label>
                <label class="text-sm flex items-center gap-2">
                    <input type="checkbox" x-model="searchLyrics" @change="render()" />
                    <span>Lyrics</span>
                </label>
                <label class="text-sm flex items-center gap-2">
                    <input type="checkbox" x-model="spanishOnly" @change="render(true)" />
                    <span>Spanish</span>
                </label>
                <label class="text-sm flex items-center gap-2">
                    <input type="checkbox" x-model="showArchived" @change="render(true)" />
                    <span>Archived</span>
                </label>
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600">Season</span>
                    <select class="border rounded px-2 py-1" x-model="selectedSeason" @change="render()">
                        <option value="">All seasons</option>
                        <template x-for="{key,label} in seasons" :key="key">
                            <option :value="key" x-text="label"></option>
                        </template>
                    </select>
                </label>
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600">Leader</span>
                    <select class="border rounded px-2 py-1" x-model="selectedLeader" @change="render()">
                        <option value="">All leaders</option>
                        <template x-for="name in leaderOptions" :key="name">
                            <option :value="name" x-text="name"></option>
                        </template>
                    </select>
                </label>
                <label class="text-sm flex flex-col">
                    <span class="text-gray-600">Usage</span>
                    <select class="border rounded px-2 py-1" x-model="selectedUsage" @change="render()">
                        <option value="">All usage</option>
                        <template x-for="u in usageOptions" :key="u">
                            <option :value="u" x-text="u"></option>
                        </template>
                    </select>
                </label>
            </div>
        </div>
    </div>
</div>
<!-- Content area fills the rest of the viewport; no page scroll -->
<div class="h-full min-h-0 p-4 z-0" :class="isModalContext ? 'mt-14' : ''">
    <div class="flex gap-4 h-full relative">
        <!-- LEFT PANE: table scrolls -->
        <div class="hidden md:block w-[200px] lg:w-[360px] flex-shrink-0 h-full overflow-auto border rounded">
            <table class="min-w-full">
                <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr>
                        <template x-for="h in tableHeaders" :key="h">
                            <th class="text-left py-2 cursor-pointer select-none" @click="sort(h)">
                                <span class="inline-block w-4 text-xs align-top text-right"
                                    x-html="headerIcon(h)"></span>
                                <span x-text="headerLabel(h)"></span>
                            </th>
                        </template>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="(r, i) in filtered" :key="i">
                        <tr class="odd:bg-white even:bg-gray-50 hover:bg-indigo-50 cursor-pointer"
                            :class="selected === r ? 'ring-2 ring-indigo-400' : ''" @click="select(r)">
                            <template x-for="h in tableHeaders" :key="h">
                                <td class="px-3 py-2 text-xs lg:text-sm" x-text="format(r[h])"></td>
                            </template>
                        </tr>
                    </template>
                    <tr x-show="!filtered.length">
                        <td class="px-3 py-6 text-center text-gray-500" :colspan="tableHeaders.length">
                            No results
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- RIGHT PANE: Preview -->
        <div class="flex-1 h-full overflow-auto border rounded p-4">
            <div x-show="selected">
                <!-- HEADER -->
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <h2 class="text-2xl font-semibold" x-text="selected?.Song || '(Untitled)'"></h2>
                        <div class="mt-1 text-xs font-semibold uppercase text-rose-600" x-show="isArchived(selected)">
                            Archived
                        </div>

                        <div class="mt-1 text-sm text-gray-600" x-show="selected?.Leader">
                            Leader: <span class="font-medium" x-text="selected?.Leader"></span>
                        </div>

                        <div class="mt-1 text-sm text-gray-600" x-show="selected?.Season">
                            Season: <span class="font-medium" x-text="selected?.Season"></span>
                        </div>

                        <div class="mt-1 text-sm text-gray-600" x-show="selected?.Themes">
                            Themes: <span class="font-medium" x-text="selected?.Themes"></span>
                        </div>

                        <div class="mt-1 text-sm text-gray-600" x-show="selected?.Scriptures">
                            Scriptures: <span class="font-medium" x-text="selected?.Scriptures"></span>
                        </div>

                        <div class="mt-1 text-sm text-gray-600" x-show="selected?.Keywords">
                            Keywords: <span class="font-medium" x-text="selected?.Keywords"></span>
                        </div>

                        <a :href="selected?.Link" class="mt-1 text-sm "
                          x-show="selected?.Link"
                          @click.prevent="openSongLink(selected?.Link)">
                            Link: <span class="font-medium text-blue-700" x-text="selected?.Link"></span>
                        </a>
                    </div>

                    <div class="text-sm text-right text-gray-600">
                        <button type="button"
                            class="mb-2 inline-flex items-center justify-center px-3 py-1.5 border rounded bg-blue-50 text-blue-800 border-blue-200 hover:bg-blue-100 disabled:opacity-50"
                            x-show="isModalContext" :disabled="!selected"
                            @click="$dispatch('use-song', { index: $root.suggestTargetIndex, name: selected?.Song || '' })">
                            Use This Song
                        </button>
                        <div x-show="selected?.Uses">Uses: <span class="font-medium" x-text="selected?.Uses"></span>
                        </div>
                        <div x-show="selected?.Usage">Usage: <span class="font-medium" x-text="selected?.Usage"></span>
                        </div>
                        <div x-show="selected?.Years_Used">Years Used: <span class="font-medium"
                                x-text="selected?.Years_Used"></span></div>
                        <div x-show="selected?.Last_Used">Last used: <span class="font-medium"
                                x-text="format(selected?.Last_Used)"></span></div>
                        <div x-show="selected?.First_Used">First used: <span class="font-medium"
                                x-text="format(selected?.First_Used)"></span></div>
                        <div x-show="selected?._folderUrl" class="mt-2">
                            <a class="inline-flex items-center gap-2 px-2 py-1 border rounded hover:bg-gray-50"
                                :href="selected?._folderUrl || '#'" target="_blank" rel="noopener">
                                <span class="font-semibold text-sm">Open Folder</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- MEDIA -->
                <div class="flex gap-1 align-middle mt-1">
                    <div class="text-sm font-medium text-gray-700">Media:</div>
                    <div x-show="mediaLoading" class="text-sm text-gray-500">Loading files...</div>

                    <ul x-show="!mediaLoading && mediaFiles.length" class="space-y-1 inline-flex flex-wrap gap-1">
                        <template x-for="(file, i) in mediaFiles" :key="i">
                            <li class="!mt-0">
                                <a class="text-blue-600 hover:text-blue-800 hover:underline" :href="file.url"
                                    target="_blank" rel="noopener">
                                    <span x-text="fileIcon(file.mimeType)"></span>
                                    <span x-text="friendlyMediaName(file)"></span>
                                </a>
                            </li>
                        </template>
                    </ul>

                    <div x-show="!mediaLoading && !mediaFiles.length" class="text-sm text-gray-500"
                        x-text="mediaMessage || 'No files in folder.'"></div>
                </div>

                <!-- NOTES -->
                <div class="mt-3" x-show="selected?.Notes">
                    <div class="text-sm font-medium text-gray-700 mb-1">Notes</div>
                    <div class="text-sm whitespace-pre-wrap" x-text="selected?.Notes"></div>
                </div>

                <!-- LYRICS -->
                <div class="mt-4">
                    <div class="flex items-center justify-between mb-1">
                        <div class="text-sm font-medium text-gray-700">Lyrics</div>
                        <button type="button" class="text-sm underline"
                            @click="copy(selected.Lyrics || selected['Lyrics (PD)'])">Copy</button>
                    </div>
                    <pre class="bg-gray-50 border rounded p-3 overflow-auto max-h-[60vh] whitespace-pre-wrap"
                        x-html="highlightedLyrics()"></pre>
                </div>
            </div>

            <div x-show="!selected" class="text-gray-500">Select a song to preview.</div>
        </div>

    </div>
</div>

<!-- Song editor modal -->
<div x-show="showSongEditor" x-cloak class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40" @click="cancelSongEditor()"></div>
    <div class="relative bg-white rounded-lg shadow-lg max-w-3xl w-[95vw] max-h-[90vh] overflow-y-auto">
        <div class="px-4 py-3 border-b flex items-center justify-between">
            <div class="font-semibold" x-text="songEditorMode === 'edit' ? 'Edit Song' : 'Add Song'"></div>
            <button type="button" class="text-sm text-blue-700 hover:underline"
                @click="cancelSongEditor()">Close</button>
        </div>
        <form class="p-4 space-y-4" @submit.prevent="saveSongEditor()">
            <div class="grid md:grid-cols-2 gap-4">
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Song title</span>
                    <input type="text" class="border rounded px-3 py-2" x-model="songForm.Song" x-ref="songTitle"
                        required>
                </label>
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Leader(s)</span>
                    <input type="text" class="border rounded px-3 py-2" x-model="songForm.Leader"
                        placeholder="Comma separated">
                </label>
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Season</span>
                    <input type="text" class="border rounded px-3 py-2" x-model="songForm.Season">
                </label>
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Usage</span>
                    <input type="text" class="border rounded px-3 py-2" x-model="songForm.Usage">
                </label>
                <label class="text-sm flex flex-col gap-1 md:col-span-2">
                    <span class="font-medium text-gray-700">Themes</span>
                    <input type="text" class="border rounded px-3 py-2" x-model="songForm.Themes"
                        placeholder="Comma separated">
                </label>
                <label class="text-sm flex flex-col gap-1 md:col-span-2">
                    <span class="font-medium text-gray-700">Keywords</span>
                    <input type="text" class="border rounded px-3 py-2" x-model="songForm.Keywords"
                        placeholder="Comma separated">
                </label>
                <label class="text-sm flex flex-col gap-1 md:col-span-2">
                    <span class="font-medium text-gray-700">Scriptures</span>
                    <input type="text" class="border rounded px-3 py-2" x-model="songForm.Scriptures"
                        placeholder="Comma separated">
                </label>
                <label class="text-sm flex flex-col gap-1 md:col-span-2">
                    <span class="font-medium text-gray-700">Link</span>
                    <input type="url" class="border rounded px-3 py-2" x-model="songForm.Link"
                        placeholder="https://...">
                </label>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Notes</span>
                    <textarea class="border rounded px-3 py-2 min-h-[80px]" x-model="songForm.Notes"></textarea>
                </label>
                <label class="text-sm flex flex-col gap-1">
                    <span class="font-medium text-gray-700">Lyrics</span>
                    <textarea class="border rounded px-3 py-2 min-h-[120px]" x-model="songForm.Lyrics"></textarea>
                </label>
            </div>
            <div class="flex items-center gap-4">
                <label class="inline-flex items-center gap-2 text-sm">
                    <input type="checkbox" x-model="songForm.Sp">
                    Spanish
                </label>
                <label class="inline-flex items-center gap-2 text-sm">
                    <input type="checkbox" x-model="songForm.Archive">
                    Archived
                </label>
            </div>
            <div class="text-sm text-rose-600" x-show="songEditorError" x-text="songEditorError"></div>
            <div class="flex justify-end gap-2 pt-2">
                <button type="button" class="px-4 py-2 border rounded hover:bg-gray-50" @click="cancelSongEditor()"
                    :disabled="songEditorSaving">Cancel</button>
                <button type="submit" class="px-4 py-2 rounded bg-emerald-600 text-white disabled:opacity-50"
                    :disabled="songEditorSaving">
                    <span x-show="!songEditorSaving">Save song</span>
                    <span x-show="songEditorSaving">Saving…</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Mobile song list overlay -->
<div class="md:hidden" x-show="mobileListOpen" x-transition.opacity x-cloak>
    <div class="fixed inset-0 bg-black/40 z-40" @click="mobileListOpen = false"></div>
    <div class="fixed inset-y-0 left-0 right-0 z-50 flex">
        <div class="ml-auto h-full w-full max-w-md bg-white shadow-xl border-l flex flex-col">
            <div class="px-4 py-3 border-b flex items-center justify-between">
                <div class="font-semibold">Select a song</div>
                <button type="button" class="text-sm text-blue-600 hover:underline"
                    @click="mobileListOpen = false">Close</button>
            </div>
            <div class="flex-1 overflow-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <template x-for="h in tableHeaders" :key="h">
                                <th class="text-left py-2 cursor-pointer select-none px-3" @click="sort(h)">
                                    <span class="inline-block w-4 text-xs align-middle" x-html="headerIcon(h)"></span>
                                    <span x-text="headerLabel(h)"></span>
                                </th>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(r, i) in filtered" :key="i">
                            <tr class="odd:bg-white even:bg-gray-50 hover:bg-indigo-50 cursor-pointer"
                                :class="selected === r ? 'ring-2 ring-indigo-400' : ''" @click="select(r)">
                                <template x-for="h in tableHeaders" :key="h">
                                    <td class="px-3 py-2" x-text="format(r[h])"></td>
                                </template>
                            </tr>
                        </template>
                        <tr x-show="!filtered.length">
                            <td class="px-3 py-6 text-center text-gray-500" :colspan="tableHeaders.length">
                                No results
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
