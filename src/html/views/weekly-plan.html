<div x-data="weeklyPlanApp()" x-init="init()"
  @use-song.window="applySuggestion(suggestTargetIndex, { name: $event.detail.name }); showSuggestModal=false"
  class="h-full flex flex-col overflow-hidden flex-1 min-h-0">
  <div class="p-3 border-b flex items-center gap-3 bg-blue-800">
    <div class="flex items-center gap-2">
      <label class="text-sm text-white sr-only">Existing Services</label>
      <button class="btn btn--surface"
        :disabled="loadingServices || !selectedServiceId"
        @click="loadSelected()">Load</button>
      <select class="form-control form-control--dense" x-model="selectedServiceId">
        <option value="" disabled selected>Select...</option>
        <template x-for="s in existingServices" :key="s.id || (s.date + s.time)">
          <option :value="s.id"
            x-text="serviceLabel(s)">
          </option>
        </template>
      </select>
      <template x-if="!selectedServiceId && !isGuest">
        <button class="btn btn--accent"
          @click="submit()" x-text="actionLabel()"></button>
      </template>
      <template x-if="!isGuest">
        <button
          class="ml-1 btn btn--surface btn--danger btn--square"
          :disabled="loadingServices || !selectedServiceId"
          title="Delete service"
          @click="selectedServiceId && confirm('Delete this service and all its items?') && deleteSelectedService()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
            <path
              d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166M19.5 5.79 18.16 19.673A2.25 2.25 0 0 1 15.916 21.75H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.455 0c-1.146-.173-2.306-.306-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397M15.75 5.394V4.478c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0C9.16 2.314 8.25 3.299 8.25 4.478v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
          </svg>
        </button>
      </template>
    </div>
    <div class="flex-1"></div>
    <div class="header-flex">
      <span x-cloak x-show="loadingServices"
        class="inline-header-flex text-sm text-blue-800 bg-blue-50 border border-blue-200 px-2 py-1 rounded">
        <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
          stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="9" stroke-opacity=".25"></circle>
          <path d="M21 12a9 9 0 0 1-9 9" stroke-linecap="round"></path>
        </svg>
        <span>Syncing services...</span>
      </span>
      <template x-if="!isGuest">
        <button
          class="btn btn--surface hidden md:block"
          :disabled="loadingServices" @click="openCreateServicesModal()">Add New Services</button>
      </template>
    </div>
  </div>

  <div x-cloak x-show="showCreateServicesModal && !isGuest"
    class="modal-overlay z-30"
    @keydown.escape.window="closeCreateServicesModal()"
    @click.self="closeCreateServicesModal()">
    <div class="modal-panel p-5">
      <h2 class="text-lg font-semibold mb-3">Batch Create Services</h2>
      <p class="text-sm text-gray-600 mb-4">
        We'll create Sunday services at 10:00 AM. Communion is scheduled on the 1st, 3rd, and 5th Sundays;
        Offering on the 2nd and 4th. Defaults: Leader &mdash; Darden, Preacher &mdash; Tom.
      </p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <label class="text-sm text-gray-700">
          Start Sunday
          <input type="date" class="mt-1 w-full form-control form-control--dense"
            x-model="batchStartDate">
        </label>
        <label class="text-sm text-gray-700">
          Weeks to create
          <input type="number" min="1" max="52" class="mt-1 w-full form-control form-control--dense"
            x-model.number="batchWeeks" x-ref="batchWeeks">
        </label>
      </div>
      <div class="text-sm text-rose-600 mb-2" x-text="batchCreateError" x-show="batchCreateError"></div>
      <div class="flex justify-end gap-2">
        <button type="button" class="btn btn--muted"
          @click="closeCreateServicesModal()"
          :disabled="batchCreateLoading">Cancel</button>
        <button type="button"
          class="btn btn--accent"
          :disabled="batchCreateLoading"
          @click="submitBatchCreate()">
          <span x-show="!batchCreateLoading">Create Services</span>
          <span x-show="batchCreateLoading">Creating...</span>
        </button>
      </div>
    </div>
  </div>

  <div class="mx-4 mt-3 mb-0" x-show="loadingServices" x-cloak>
    <div class="alert alert--info">Fetching existing services... please wait.</div>
  </div>

  <div class="bg-gray-100 flex flex-col flex-1 min-h-0 overflow-hidden" x-show="showDetails" x-cloak>
    <div class="p-4">
      <h3 class="text-lg font-semibold mb-3 sr-only">Service Details</h3>
      <div class="flex gap-2 flex-wrap">
        <div class="pr-6">
          <h1 class="font-bold text-lg md:text-2xl" x-html="formattedDateTimeHtml()"></h1>
        </div>
        <div class="flex flex-wrap gap-2">
          <label class="text-sm flex-1">Service Type
            <select class="mt-1 w-full form-control form-control--dense" x-model="form.type" @change="queueSaveDetails()">
              <option value="Communion">Communion</option>
              <option value="Offering">Offering</option>
            </select>
          </label>
          <label class="text-sm flex-1">Leader
            <div class="mt-1">
              <select x-ref="leaderSel" class="form-control form-control--dense w-full" x-model="leaderSelect"
                @change="form.leader = leaderSelect==='__custom' ? '' : leaderSelect; queueSaveDetails()">
                <template x-for="n in leaderChoices" :key="'lead-'+n">
                  <option :value="n" x-text="n"></option>
                </template>
                <option value="__custom">Custom</option>
              </select>
            </div>
            <template x-if="leaderSelect==='__custom'"><input type="text" class="mt-2 w-full form-control form-control--dense"
                placeholder="Type leader name" x-model="form.leader" @input="queueSaveDetails()" /></template>
          </label>
          <label class="text-sm lg:min-w-32 flex-1">Preacher
            <div class="mt-1">
              <select x-ref="preacherSel" class="form-control form-control--dense w-full" x-model="preacherSelect"
                @change="form.preacher = preacherSelect==='__custom' ? '' : preacherSelect; queueSaveDetails()">
                <template x-for="n in preacherChoices" :key="'prech-'+n">
                  <option :value="n" x-text="n"></option>
                </template>
                <option value="__custom">Custom...</option>
              </select>
            </div>
            <template x-if="preacherSelect==='__custom'"><input type="text" class="mt-2 w-full form-control form-control--dense"
                placeholder="Type preacher name" x-model="form.preacher" @input="queueSaveDetails()" /></template>
          </label>
        </div>
      </div>
    </div>

    <div class="mt-6 px-1 pb-1 flex flex-col flex-1 min-h-0 relative">
      <div class="relative">
        <div class="border-b px-2 app-tabs app-tabs--segment z-50 absolute -bottom-[1px]">
          <button type="button"
            class="app-tab"
            :class="activeContentTab==='scripture' ? 'is-active' : ''"
            @click="activeContentTab='scripture'">
            Scripture
          </button>
          <button type="button"
            class="app-tab"
            :class="activeContentTab==='order' ? 'is-active' : ''"
            @click="activeContentTab='order'">
            Order of Worship
          </button>
          <button type="button"
            class="app-tab"
            :class="activeContentTab==='team' ? 'is-active' : ''"
            @click="activeContentTab='team'">
            Team
          </button>
        </div>
      </div>

      <div class="flex-1 min-h-0 flex flex-col" x-show="activeContentTab==='scripture'" x-cloak>
        <div class="border rounded w-full bg-white flex-1 min-h-0 flex flex-col">
          <div class="px-3 flex items-center justify-between">
            <span class="font-medium sr-only">Scripture</span>
            <div class="text-xs text-gray-500" x-show="savingDetails || savedAt">
              <span x-show="savingDetails">Saving…</span>
              <span x-show="!savingDetails && savedAt">Saved</span>
            </div>
          </div>
          <div class="p-3 space-y-3 overflow-auto flex-1">
            <div class="flex flex-wrap items-center gap-2">
              <button class="btn btn--outline btn--sm"
                @click="fetchScripture()">Fetch Text</button>
              <input class="flex-1 form-control form-control--dense min-w-[220px]" type="text" placeholder="e.g., John 3:5-6, 8-10"
                x-model="form.scripture" @input="queueSaveDetails()" />
            </div>
            <textarea class="w-full form-control form-control--dense" rows="6" x-model="scriptureText" @input="queueSaveDetails()"
              placeholder="Scripture text (editable)"></textarea>
            <div class="flex flex-wrap gap-3">
              <label class="text-sm block flex-1 min-w-[160px]">
                <span class="font-medium text-gray-700">Theme</span>
                <input type="text" class="mt-1 w-full form-control form-control--dense" x-model="form.theme"
                  @input="queueSaveDetails(); updateSuggestDefaults()" />
              </label>
              <label class="text-sm block flex-1 min-w-[200px]">
                <span class="font-medium text-gray-700">Keywords</span>
                <input type="text" class="mt-1 w-full form-control form-control--dense"
                  placeholder="Auto from Scripture; comma separated" x-model="form.keywords"
                  @input="queueSaveDetails(); updateSuggestDefaults()" />
              </label>
            </div>
            <label class="text-sm block mt-2">
              <span class="font-medium text-gray-700">Notes</span>
              <textarea class="mt-1 w-full form-control form-control--dense" rows="3" x-model="form.notes"
                @input="queueSaveDetails()"></textarea>
            </label>
            <div class="mt-6 border rounded">
              <div class="flex flex-wrap items-center justify-start gap-2 px-3 py-2">
                <div>
                  <span class="font-medium text-gray-700">Songs Browser</span>
                </div>
                <div class="header-flex text-xs text-gray-600">
                  <button type="button"
                    class="btn btn--outline btn--xs"
                    @click="fetchSongSuggestions()"
                    :disabled="recommendedSongsLoading || !scriptureText.trim() || !form.scripture.trim()">
                    <span x-show="!recommendedSongsLoading">Fetch AI Suggestions</span>
                    <span x-show="recommendedSongsLoading">Fetching...</span>
                  </button>
                  <span x-show="recommendedSongs.length">
                    <strong x-text="recommendedSongs.length"></strong> saved suggestion<span x-text="recommendedSongs.length === 1 ? '' : 's'"></span>
                  </span>
                </div>
              </div>
              <div class="mt-2 h-[620px] flex flex-col">
                <div class="flex-1 flex flex-col"
                  x-data="songsApp('embedded')"
                  x-init="init()"
                  x-ref="embeddedSongsApp">
                  <div x-ref="browserHost" class="flex-1 min-h-0 flex flex-col w-full"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex-1 min-h-0 flex flex-col" x-show="activeContentTab==='order'" x-cloak>
        <div x-show="!showOrder" x-cloak class="border rounded p-4 text-sm text-gray-600">
          Save or load a service to build the order of worship.
        </div>
        <div class="border rounded bg-white p-3 flex-1 min-h-0 flex flex-col" x-show="showOrder" x-cloak>
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <span class="font-medium sr-only">Order of Worship</span>
              <span class="text-xs text-gray-500" x-show="savingOrder">Saving…</span>
              <span class="text-xs text-gray-500" x-show="!savingOrder && savedAt">Saved</span>
            </div>
            <div class="flex gap-2">
              <template x-if="!isGuest">
                <button
                  class="btn btn--outline btn--xs"
                  @click="addOrderRow()">+ Add Row</button>
              </template>
            </div>
          </div>
          <div class="relative flex-1 min-h-0 overflow-auto">
            <div x-cloak x-show="loadingOrder"
              class="absolute inset-0 z-10 flex items-center justify-center bg-white/80 backdrop-blur-sm">
              <div class="inline-header-flex text-sm text-indigo-700">
                <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="12" cy="12" r="9" stroke-opacity=".25"></circle>
                  <path d="M21 12a9 9 0 0 1-9 9" stroke-linecap="round"></path>
                </svg>
                <span>Loading order...</span>
              </div>
            </div>
            <table id="order-of-worship" class="app-table">
              <thead class="bg-gray-50">
                <tr>
                  <th class="border px-1 text-left">#</th>
                  <th class="border text-left">Item</th>
                  <th class="border text-left">Detail</th>
                  <th class="border text-left">Leader</th>
                  <th class="border text-left">Notes</th>
                  <template x-if="!isGuest">
                    <th class="border w-28">Actions</th>
                  </template>
                </tr>
              </thead>
              <tbody>
                <template x-for="(row, i) in orderRows" :key="'ord-'+i">
                  <tr>
                    <td class="border" x-text="i+1"></td>
                    <td class="border">
                      <select class="form-control form-control--dense w-full" x-model="row.itemType" @change="queueSaveOrder(true)"
                        :disabled="isGuest">
                        <option :value="row.itemType" x-text="row.itemType"></option>
                        <template x-for="t in orderItemTypes" :key="t">
                          <option :value="t" x-text="t"></option>
                        </template>
                      </select>
                    </td>
                    <td class="border relative">
                      <div class="flex items-center gap-1 relative">
                        <template x-if="loadingSuggestion && suggestTargetIndex === i">
                          <div class="absolute inset-y-0 right-36 flex items-center text-xs text-indigo-600">
                            <svg class="h-3.5 w-3.5 animate-spin mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                              <circle cx="12" cy="12" r="9" stroke-opacity=".25"></circle>
                              <path d="M21 12a9 9 0 0 1-9 9" stroke-linecap="round"></path>
                            </svg>
                            <span>Thinking...</span>
                          </div>
                        </template>
                        <input class="form-control form-control--dense w-full" x-model="row.detail" @input="queueSaveOrder()"
                          @blur="queueSaveOrder(true)" placeholder="e.g., Song title" :disabled="isGuest" />
                        <button class="btn btn--outline btn--xs"
                          title="Suggest song" aria-label="Suggest song"
                          x-show="!isGuest && /song/i.test(String(row.itemType||''))"
                          :disabled="loadingSuggestion || isGuest"
                          @click.stop="suggestForRow(i)">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                            class="w-4 h-4">
                            <path
                              d="M12 18V12.75M12 12.75c.518 0 1.021-.066 1.5-.189M12 12.75c-.518 0-1.021-.066-1.5-.189M14.25 20.039A9.02 9.02 0 0 1 12 20.25c-.769 0-1.521-.073-2.25-.211M13.5 22.422A14.706 14.706 0 0 1 12 22.5c-.507 0-1.007-.026-1.5-.078M14.25 18v-.192c0-.983.658-1.823 1.508-2.316A7.46 7.46 0 0 0 19.5 9c0-4.142-3.358-7.5-7.5-7.5S4.5 4.858 4.5 9c0 2.773 1.505 5.194 3.742 6.492.85.493 1.508 1.333 1.508 2.316V18" />
                          </svg>
                        </button>
                        <button class="btn btn--outline btn--xs"
                          title="Suggest scripture" aria-label="Suggest scripture"
                          x-show="!isGuest && /call to worship|scripture/i.test(String(row.itemType||''))"
                          :disabled="loadingSuggestion || isGuest"
                          @click.stop="suggestForRow(i)">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                            class="w-4 h-4">
                            <path
                              d="M12 6.042C10.408 4.617 8.305 3.75 6 3.75c-1.052 0-2.062.18-3 .512v14.25c.938-.332 1.948-.512 3-.512 2.305 0 4.408.867 6 2.292m0-14.25C13.592 4.617 15.695 3.75 18 3.75c1.052 0 2.062.18 3 .512v14.25c-.938-.332-1.948-.512-3-.512-2.305 0-4.408.867-6 2.292m0-14.25v14.25" />
                          </svg>
                        </button>
                        <button class="btn btn--ghost-primary btn--xs" title="View Scripture Text"
                          x-show="row.scriptureText"
                          @click.stop="viewRowScripture(i)">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                            <path d="M12 5c-5 0-9 4.5-10 7 1 2.5 5 7 10 7s9-4.5 10-7c-1-2.5-5-7-10-7zm0 11a4 4 0 110-8 4 4 0 010 8z"/>
                          </svg>
                        </button>
                        <div x-show="false"></div>
                      </div>
                    </td>
                    <td class="border"><input class="form-control form-control--dense w-full" x-model="row.leader" @input="queueSaveOrder()" @blur="queueSaveOrder(true)"
                        placeholder="Leader" :disabled="isGuest" /></td>
                    <td class="border"><input class="form-control form-control--dense w-full" x-model="row.notes" @input="queueSaveOrder()" @blur="queueSaveOrder(true)"
                        placeholder="Notes" :disabled="isGuest" /></td>
                    <template x-if="!isGuest">
                      <td class="border">
                      <div class="flex items-center gap-1">
                        <button type="button" aria-label="Move up"
                          class="btn btn--icon btn--secondary"
                          @click="moveOrderRow(i,-1)">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"
                            aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m4.5 15.75 7.5-7.5 7.5 7.5" />
                          </svg>
                        </button>
                        <button type="button" aria-label="Move down"
                          class="btn btn--icon btn--secondary"
                          @click="moveOrderRow(i,1)">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"
                            aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                          </svg>
                        </button>
                        <button type="button" aria-label="Remove"
                          class="btn btn--icon btn--danger"
                          @click="removeOrderRow(i)">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"
                            aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                              d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.455 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                          </svg>
                        </button>
                      </div>
                      </td>
                    </template>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="flex-1 min-h-0 flex flex-col" x-show="activeContentTab==='team'" x-cloak>
        <div class="border rounded p-4 bg-white space-y-4">
          <div x-show="!teamAssignmentsSupported" x-cloak
            class="alert alert--warning"
            x-text="teamAssignmentsUnsupportedReason || 'Team assignments are not available in this environment yet.'">
          </div>
          <div x-show="teamAssignmentsSupported && !selectedServiceId" x-cloak class="text-sm text-gray-600">
            Load or save a service to view team assignments.
          </div>
          <div x-show="teamAssignmentsSupported && selectedServiceId" x-cloak class="space-y-3">
            <div x-show="teamAssignmentsLoading" x-cloak
              class="inline-header-flex text-sm text-indigo-700 bg-indigo-50 border border-indigo-200 px-3 py-1 rounded">
              <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="12" cy="12" r="9" stroke-opacity=".25"></circle>
                <path d="M21 12a9 9 0 0 1-9 9" stroke-linecap="round"></path>
              </svg>
              <span>Loading team assignments…</span>
            </div>
          <div x-show="teamAssignmentsError" x-cloak
            class="text-sm text-rose-600 bg-rose-50 border border-rose-200 px-3 py-2 rounded"
            x-text="teamAssignmentsError"></div>
          <div x-show="!teamAssignmentsLoading && !teamAssignmentsError && (!teamAssignments.length)" x-cloak
            class="text-sm text-gray-600">
            No team assignments have been added for this service yet.
          </div>
          <div class="flex flex-wrap items-center justify-between gap-3" x-show="teamAssignmentsSupported && selectedServiceId && !isGuest">
            <div class="text-sm text-gray-700" x-show="teamAssignmentsDirty">You have unsaved team updates.</div>
            <div class="flex-1"></div>
            <div class="text-xs text-emerald-700" x-show="teamAssignmentsSaveMessage" x-text="teamAssignmentsSaveMessage"></div>
            <div class="text-xs text-rose-600" x-show="teamAssignmentsSaveError" x-text="teamAssignmentsSaveError"></div>
            <div class="flex items-center gap-2">
              <button type="button" class="btn btn--muted btn--xs"
                :disabled="teamAssignmentsSaving"
                @click="loadTeamAssignments(selectedServiceId)">
                Reload
              </button>
              <button type="button" class="btn btn--accent btn--xs"
                :disabled="teamAssignmentsSaving || !teamAssignmentsDirty"
                @click="saveTeamAssignments()">
                <span x-show="!teamAssignmentsSaving">Save Team</span>
                <span x-show="teamAssignmentsSaving">Saving...</span>
              </button>
            </div>
          </div>
          <div class="text-xs text-gray-600" x-show="isGuest">
            Sign in to edit team assignments.
          </div>
          <div class="flex-1 min-h-0 overflow-auto space-y-3">
            <template x-for="team in teamAssignments" :key="team.teamType + '::' + (team.weeklyTeamName || '')">
              <div class="border rounded">
              <div class="px-3 py-2 bg-gray-50 flex items-center justify-between">
                <div>
                    <div class="font-semibold text-gray-800" x-text="team.teamType || 'Team'"></div>
                    <div class="text-xs text-gray-500" x-show="team.weeklyTeamName"
                      x-text="'Weekly team: ' + team.weeklyTeamName"></div>
                  </div>
                  <div class="text-xs text-gray-500" x-show="team.roles && team.roles.length"
                    x-text="team.roles.length + ' roles'"></div>
                </div>
                <div class="divide-y">
                  <template x-for="(role, idx) in team.roles" :key="team.teamType + '-' + idx + '-' + (role.roleName || '')">
                    <div class="px-3 py-2 flex flex-wrap items-center justify-between gap-3">
                      <div class="min-w-[140px]">
                        <div class="text-sm font-medium text-gray-800" x-text="role.roleName || role.roleType || 'Role'"></div>
                        <div class="text-xs text-gray-500" x-show="role.roleType && role.roleType !== role.roleName"
                          x-text="role.roleType"></div>
                      </div>
                      <div class="flex flex-col gap-1 min-w-[220px] w-full sm:w-[280px]">
                        <select class="form-control form-control--dense text-sm"
                          :class="(!role.memberEmail ? 'border-amber-400 bg-amber-50' : '')"
                          :value="role.memberEmail || ''"
                          :disabled="isGuest || teamAssignmentsSaving || !teamMemberLookupLoaded"
                          @change="setTeamRoleMember(team, role, $event.target.value)">
                          <option value="">Open</option>
                          <template x-for="member in memberOptionsForRoleType(role.roleName || role.roleType, role)" :key="member.email + '-' + team.teamType + '-' + (role.roleName || idx)">
                            <option :value="member.email" x-text="member.display"></option>
                          </template>
                        </select>
                        <div class="text-xs text-gray-500" x-show="role.memberEmail" x-text="role.memberEmail"></div>
                        <div class="text-xs text-amber-600" x-show="!teamMemberLookupLoaded">Loading roster...</div>
                        <div class="text-xs text-amber-600" x-show="role.status && role.status.toLowerCase() !== 'assigned'"
                          x-text="role.status"></div>
                      </div>
                    </div>
                  </template>
                  <div class="px-3 py-2 text-sm text-gray-500" x-show="!team.roles || !team.roles.length">
                    No roles assigned in this team yet.
                  </div>
                </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Save button moved to header next to Load -->
  </div>

  <!-- Suggest Songs Modal -->
  <div x-show="showSuggestModal" x-cloak class="modal-overlay z-50"
    @keydown.window.escape.prevent="showSuggestModal=false"
    @click.self="showSuggestModal=false">
    <div class="modal-panel max-w-[95vw] h-[90vh] p-0 flex flex-col">
      <div class="px-4 py-2 border-b flex items-center justify-between">
        <div class="font-semibold">Suggest Songs</div>
        <button class="btn btn--link" @click="showSuggestModal=false">Close</button>
      </div>
      <div class="flex-1 min-h-0">
        <div x-data="songsApp('modal')" x-init="init()" x-ref="suggestApp" class="h-full flex flex-col">
          <div x-ref="browserHost" class="flex-1 min-h-0 flex flex-col w-full"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripture Ideas Modal -->
  <div x-show="showScriptureModal" x-cloak class="modal-overlay z-50" @keydown.window.escape.prevent="showScriptureModal=false"
    @click.self="showScriptureModal=false">
    <div class="modal-panel max-w-[95vw] h-[90vh] p-0 flex flex-col">
      <div class="px-4 py-2 border-b flex items-center justify-between">
        <div class="font-semibold">Scripture Ideas</div>
        <button class="btn btn--link" @click="showScriptureModal=false">Close</button>
      </div>
      <div class="flex-1 min-h-0 p-3">
        <div class="mb-3 grid gap-2 md:grid-cols-[repeat(auto-fit,minmax(180px,1fr))]">
          <label class="text-xs text-gray-600 flex flex-col gap-1">
            Theme
            <input type="text" class="form-control form-control--dense" placeholder="Theme"
              x-model="scriptureSearchTheme" />
          </label>
          <label class="text-xs text-gray-600 flex flex-col gap-1">
            Keywords
            <input type="text" class="form-control form-control--dense" placeholder="Comma separated"
              x-model="scriptureSearchKeywords" />
          </label>
          <div class="flex items-end gap-2">
            <button class="btn btn--outline"
              :disabled="scriptureSearchPending"
              @click="refreshScriptureIdeas('manual')">
              <span x-show="!scriptureSearchPending">Search Ideas</span>
              <span x-show="scriptureSearchPending">Searching…</span>
            </button>
            <div class="text-xs text-rose-600" x-show="scriptureSearchError" x-text="scriptureSearchError"></div>
          </div>
        </div>
        <style>
          .scripture-html sup,
          .scripture-html .verse-num {
            color: #1d4ed8;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.25rem;
          }
          .scripture-html .verse-num sup {
            color: inherit;
            font-size: inherit;
            margin: 0;
          }
          .scripture-ref-main {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
          }
          .scripture-ref-main.is-selected {
            background-color: #fde68a;
            border-left-color: #d97706;
          }
          .scripture-chunk {
            margin-bottom: 1rem;
          }
          .scripture-chunk:last-child {
            margin-bottom: 0;
          }
          .scripture-ref-block {
            font-weight: 600;
            margin: 0.5rem 0 0.25rem;
          }
          .scripture-chunk:first-child .scripture-ref-block {
            margin-top: 0;
          }
        </style>
        <div class="flex gap-3 h-full">
          <div class="w-[250px] flex-shrink-0 h-full overflow-auto border rounded">
            <div class="text-xs text-gray-500 px-2 py-1 border-b">References</div>
            <template x-if="form.scripture">
              <div class="px-2 py-2 border-b border-amber-200 bg-amber-50/70">
                <div class="mb-1">
                  <span class="badge badge--warning">Main Scripture</span>
                </div>
                <button class="block w-full text-left px-2 py-1 rounded scripture-ref-main"
                        :class="selectedScriptureRef === form.scripture ? 'is-selected' : ''"
                        @click="selectedScriptureRef=form.scripture; fetchPassage(form.scripture)">
                  <span x-text="form.scripture"></span>
                </button>
              </div>
            </template>
            <template x-if="scriptureSuggestions.length">
              <div>
                <template x-for="s in scriptureSuggestions" :key="s">
                  <button class="block w-full text-left px-2 py-1 hover:bg-blue-50"
                          :class="selectedScriptureRef===s ? 'bg-blue-50' : ''"
                          @click="selectedScriptureRef=s; fetchPassage(s)">
                    <span x-text="s"></span>
                  </button>
                </template>
              </div>
            </template>
            <div class="text-xs text-gray-500 px-2 py-3" x-show="!scriptureSuggestions.length">
              No AI suggestions yet — enter a reference manually or tweak the search inputs.
            </div>
          </div>
          <div class="w-[500px] h-full overflow-auto border rounded p-3">
            <div class="flex items-center justify-between mb-2 gap-3">
              <div class="header-flex flex-1">
                <input type="text" class="form-control form-control--dense w-full" x-model="selectedScriptureRef" @input="refChanged()" placeholder="e.g., John 1:1-5" />
              </div>
              <div class="header-flex">
                <button class="btn btn--outline btn--xs"
                  @click="toggleScriptureEditing()">
                  <span x-show="!isScriptureEditing">Edit Passage</span>
                  <span x-show="isScriptureEditing">Hide Editor</span>
                </button>
                <button class="btn btn--outline btn--xs" @click="chooseScripture()">Use This Passage</button>
              </div>
            </div>
            <div class="font-medium mb-1" x-text="selectedScriptureRef || 'Select a reference'"></div>
            <div class="text-sm prose max-w-none scripture-html" x-show="selectedScriptureHtml" x-html="selectedScriptureHtml"></div>
            <textarea x-ref="scriptureEditor" class="form-control form-control--dense w-full mt-2 text-sm min-h-[160px] resize-y font-sans"
              :class="isScriptureEditing || !selectedScriptureHtml ? '' : 'hidden'"
              placeholder="Type or paste a scripture reference"
              x-model="selectedScriptureText" @input="customScriptureEdited()"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
