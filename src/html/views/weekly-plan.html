<div
  x-data="{
    showAddService: false,
    leaderChoices: ['Darden','Belinda','Lois'],
    sermonChoices: ['Tom','Darden','Miguel','Alfredo'],
    leaderSelect: 'Darden',
    sermonSelect: 'Tom',
    books: [
      ['Genesis',50],['Exodus',40],['Leviticus',27],['Numbers',36],['Deuteronomy',34],
      ['Joshua',24],['Judges',21],['Ruth',4],['1 Samuel',31],['2 Samuel',24],
      ['1 Kings',22],['2 Kings',25],['1 Chronicles',29],['2 Chronicles',36],['Ezra',10],
      ['Nehemiah',13],['Esther',10],['Job',42],['Psalms',150],['Proverbs',31],
      ['Ecclesiastes',12],['Song of Solomon',8],['Isaiah',66],['Jeremiah',52],['Lamentations',5],
      ['Ezekiel',48],['Daniel',12],['Hosea',14],['Joel',3],['Amos',9],['Obadiah',1],
      ['Jonah',4],['Micah',7],['Nahum',3],['Habakkuk',3],['Zephaniah',3],['Haggai',2],
      ['Zechariah',14],['Malachi',4],
      ['Matthew',28],['Mark',16],['Luke',24],['John',21],['Acts',28],
      ['Romans',16],['1 Corinthians',16],['2 Corinthians',13],['Galatians',6],['Ephesians',6],
      ['Philippians',4],['Colossians',4],['1 Thessalonians',5],['2 Thessalonians',3],['1 Timothy',6],
      ['2 Timothy',4],['Titus',3],['Philemon',1],['Hebrews',13],['James',5],
      ['1 Peter',5],['2 Peter',3],['1 John',5],['2 John',1],['3 John',1],['Jude',1],['Revelation',22]
    ],
    scripture: { book: 'John', chapter: 3, start: '1', end: '' },
    form: { date: '', time: '10:00 AM', type: 'Worship', leader: 'Darden', sermon: 'Tom', scripture: '', theme: '', notes: '' },
    nextSundayISO() {
      const now = new Date();
      const day = now.getDay();
      const add = (7 - day) % 7 || 7; // upcoming Sunday
      const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() + add);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${dd}`;
    },
    open() {
      this.form = { date: this.nextSundayISO(), time: '10:00 AM', type: 'Worship', leader: 'Darden', sermon: 'Tom', scripture: '', theme: '', notes: '' };
      // Ensure lists contain defaults and select them immediately
      this.ensureDefaults();
      // Default scripture and sync selects
      this.scripture = { book: 'John', chapter: 3, start: '1', end: '' };
      this.form.scripture = this.scriptureRef();
      
      this.showAddService = true;
      this.$nextTick(() => {
        if (this.$refs.bookSel) this.$refs.bookSel.value = this.scripture.book;
        if (this.$refs.chapterSel) this.$refs.chapterSel.value = String(this.scripture.chapter);
      });
    },
    async submit() {
      try {
        await callRpc('addService', { ...this.form });
        this.showAddService = false;
        alert('Service added to Services sheet.');
      } catch (e) {
        console.error(e);
        alert('Failed to add service');
      }
    },
    chapterCountFor(bookName) {
      const e = this.books.find(b => b[0] === bookName);
      return e ? e[1] : 50;
    },
    scriptureRef() {
      const b = this.scripture.book;
      const c = this.scripture.chapter;
      const s = String(this.scripture.start || '').trim();
      const e = String(this.scripture.end || '').trim();
      if (!s && !e) return `${b} ${c}`;
      if (s && !e) return `${b} ${c}:${s}`;
      return `${b} ${c}:${s}-${e}`;
    },
    ensureDefaults() {
      // make sure default names exist in lists and are selected
      if (!this.leaderChoices.includes('Darden')) this.leaderChoices = ['Darden', ...this.leaderChoices];
      if (!this.sermonChoices.includes('Tom')) this.sermonChoices = ['Tom', ...this.sermonChoices];
      this.leaderSelect = 'Darden';
      this.sermonSelect = 'Tom';
      this.form.leader = 'Darden';
      this.form.sermon = 'Tom';
      // also force the native selects to display correct choice
      this.$nextTick(() => {
        if (this.$refs.leaderSel) this.$refs.leaderSel.value = 'Darden';
        if (this.$refs.sermonSel) this.$refs.sermonSel.value = 'Tom';
      });
    }
  }"
  x-init="form.date = nextSundayISO(); ensureDefaults();
    (async()=>{ try {
      const r = await callRpc('getServicePeople', null);
      if (r?.leaders) leaderChoices = Array.from(new Set([...leaderChoices, ...r.leaders])).sort((a,b)=>a.localeCompare(b));
      if (r?.preachers) sermonChoices = Array.from(new Set([...sermonChoices, ...r.preachers])).sort((a,b)=>a.localeCompare(b));
      ensureDefaults();
    } catch(e) { ensureDefaults(); } })()"
  class="h-full flex flex-col"
>
  <div class="p-4">
    <h2 class="text-xl font-semibold mb-2">Weekly Plan</h2>
    <p class="text-sm text-gray-600">If you can read this, the plan view is mounted.</p>
  </div>

  <div class="p-3 border-b flex items-center gap-3">
    <div class="flex-1"></div>
    <button class="px-3 py-1 rounded bg-emerald-600 text-white" @click="open()">+ Add Service</button>
  </div>

  <!-- No table/rows on this page for now -->

  <!-- Add Service modal -->
  <div x-show="showAddService" x-cloak class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40" @click="showAddService=false"></div>
    <div class="relative bg-white rounded shadow-lg w-[560px] max-w-[95vw] p-4">
      <h3 class="text-lg font-semibold mb-3">Add Service</h3>
      <div class="flex gap-2">
        <label class="text-sm">Date
          <input type="date" class="mt-1 w-full border rounded px-2 py-1" x-model="form.date">
        </label>
        <label class="text-sm">Time
          <input type="text" class="mt-1 w-full border rounded px-2 py-1" placeholder="10:00 AM" x-model="form.time">
        </label>
        <label class="text-sm">Service Type
          <input type="text" class="mt-1 w-full border rounded px-2 py-1" x-model="form.type">
        </label>
      </div>
      <div class="flex gap-2">
        <label class="text-sm flex-1">Leader
          <div class="mt-1">
            <select x-ref="leaderSel" class="border rounded px-2 py-1 w-full" x-model="leaderSelect" @change="form.leader = leaderSelect==='__custom' ? '' : leaderSelect">
              <template x-for="n in leaderChoices" :key="'lead-'+n">
                <option :value="n" x-text="n"></option>
              </template>
              <option value="__custom">Custom…</option>
            </select>
          </div>
          <template x-if="leaderSelect==='__custom'">
            <input type="text" class="mt-2 w-full border rounded px-2 py-1" placeholder="Type leader name" x-model="form.leader">
          </template>
        </label>
        <label class="text-sm flex-1">Sermon
          <div class="mt-1">
            <select x-ref="sermonSel" class="border rounded px-2 py-1 w-full" x-model="sermonSelect" @change="form.sermon = sermonSelect==='__custom' ? '' : sermonSelect">
              <template x-for="n in sermonChoices" :key="'serm-'+n">
                <option :value="n" x-text="n"></option>
              </template>
              <option value="__custom">Custom…</option>
            </select>
          </div>
          <template x-if="sermonSelect==='__custom'">
            <input type="text" class="mt-2 w-full border rounded px-2 py-1" placeholder="Type preacher name" x-model="form.sermon">
          </template>
        </label>
      </div>
      <div>
        <label class="text-sm col-span-2">Scripture
          <div class="mt-1 grid grid-cols-6 gap-2 items-center">
            <select x-ref="bookSel" class="col-span-3 border rounded px-2 py-1" x-model="scripture.book">
              <template x-for="b in books" :key="b[0]"><option :value="b[0]" x-text="b[0]"></option></template>
            </select>
            <select x-ref="chapterSel" class="col-span-1 border rounded px-2 py-1" x-model.number="scripture.chapter">
              <template x-for="n in chapterCountFor(scripture.book)" :key="'ch-'+n"><option :value="n" x-text="n"></option></template>
            </select>
            <input class="col-span-1 border rounded px-2 py-1" type="number" min="1" placeholder="v" x-model="scripture.start">
            <input class="col-span-1 border rounded px-2 py-1" type="number" min="1" placeholder="to" x-model="scripture.end">
          </div>
          <div class="mt-2 flex items-center gap-2 text-sm text-gray-600">
            <span x-text="scriptureRef()"></span>

          </div>
        </label>
        <label class="text-sm col-span-2">Theme
          <input type="text" class="mt-1 w-full border rounded px-2 py-1" x-model="form.theme">
        </label>
        <label class="text-sm col-span-2">Notes
          <textarea class="mt-1 w-full border rounded px-2 py-1" rows="3" x-model="form.notes"></textarea>
        </label>
      </div>
      
      <div class="mt-4 flex justify-end gap-2">
        <button class="px-3 py-1 rounded border" @click="showAddService=false">Cancel</button>
        <button class="px-3 py-1 rounded bg-emerald-600 text-white" @click="submit()">Add Service</button>
      </div>

      <!-- no datalists; using select + custom field -->
    </div>
  </div>
</div>
