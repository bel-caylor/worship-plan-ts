<div x-data="weeklyPlanApp()" x-init="init()"
  @use-song.window="applySuggestion(suggestTargetIndex, { name: $event.detail.name }); showSuggestModal=false"
  class="min-h-screen flex flex-col overflow-y-auto pt-6 md:pt-8">
  <div class="p-3 border-b flex items-center gap-3">
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-700">Existing Service</label>
      <select class="border rounded px-2 py-1 min-w-[320px]" x-model="selectedServiceId">
        <option value="" disabled selected>Select...</option>
        <template x-for="s in existingServices" :key="s.id || (s.date + s.time)">
          <option :value="s.id"
            x-text="(s.id || ((s.date||'') + (s.time?(' '+s.time):''))) + (s.type?(' - '+s.type):'') + (s.leader?(' ('+s.leader+')'):'')">
          </option>
        </template>
      </select>
      <button class="px-3 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
        @click="loadSelected()">Load</button>
      <button class="px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700"
        @click="submit()" x-text="actionLabel()"></button>
      <button
        class="ml-1 px-2 py-1 rounded bg-rose-50 text-rose-800 border border-rose-300 hover:bg-rose-100 disabled:opacity-50"
        :disabled="!selectedServiceId"
        title="Delete service"
        @click="selectedServiceId && confirm('Delete this service and all its items?') && deleteSelectedService()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
          <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v8h-2V9zm4 0h2v8h-2V9zM7 9h2v8H7V9z"/>
        </svg>
      </button>
    </div>
    <div class="flex-1"></div>
    <div class="flex items-center gap-2">
      <span class="text-sm text-blue-800 bg-blue-50 border border-blue-200 px-2 py-1 rounded"
        x-show="!existingServices.length">Loading services...</span>
      <button
        class="px-3 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100 disabled:opacity-50"
        :disabled="!existingServices.length" @click="newService()">New Service</button>
    </div>
  </div>

  <div class="mx-4 mt-3 mb-0" x-show="!existingServices.length" x-cloak>
    <div class="rounded border border-blue-200 bg-blue-50 text-blue-800 px-3 py-2 text-sm">Fetching existing services...
      please wait.</div>
  </div>

  <div class="p-4" x-show="showDetails" x-cloak>
    <h3 class="text-lg font-semibold mb-3 sr-only">Service Details</h3>
    <div class="flex gap-2 flex-wrap">
      <label class="text-sm flex-1">Date
        <input x-ref="dateInput" type="date" class="mt-1 w-full border rounded px-2 py-1" x-model="form.date" />
      </label>
      <label class="text-sm flex-1">Time
        <input type="text" class="mt-1 w-full border rounded px-2 py-1" placeholder="10:00 AM" x-model="form.time" />
      </label>
      <label class="text-sm flex-1">Service Type
        <select class="mt-1 w-full border rounded px-2 py-1" x-model="form.type">
          <option value="Communion">Communion</option>
          <option value="Offering">Offering</option>
        </select>
      </label>
      <label class="text-sm flex-1">Leader
        <div class="mt-1">
          <select x-ref="leaderSel" class="border rounded px-2 py-1 w-full" x-model="leaderSelect"
            @change="form.leader = leaderSelect==='__custom' ? '' : leaderSelect">
            <template x-for="n in leaderChoices" :key="'lead-'+n">
              <option :value="n" x-text="n"></option>
            </template>
            <option value="__custom">Custom...</option>
          </select>
        </div>
        <template x-if="leaderSelect==='__custom'"><input type="text" class="mt-2 w-full border rounded px-2 py-1"
            placeholder="Type leader name" x-model="form.leader" /></template>
      </label>
      <label class="text-sm min-w-32 flex-1">Preacher
        <div class="mt-1">
          <select x-ref="preacherSel" class="border rounded px-2 py-1 w-full" x-model="preacherSelect"
            @change="form.preacher = preacherSelect==='__custom' ? '' : preacherSelect">
            <template x-for="n in preacherChoices" :key="'prech-'+n">
              <option :value="n" x-text="n"></option>
            </template>
            <option value="__custom">Custom...</option>
          </select>
        </div>
        <template x-if="preacherSelect==='__custom'"><input type="text" class="mt-2 w-full border rounded px-2 py-1"
            placeholder="Type preacher name" x-model="form.preacher" /></template>
      </label>
    </div>

    <div class="pt-2">
      <div class="border rounded w-full">
        <button type="button" class="w-full flex items-center px-3 py-2" @click="showScripture = !showScripture">
          <span class="mr-2 select-none text-3xl text-blue-700" x-text="showScripture ? '▾' : '▸'"></span>
          <span class="font-medium">Scripture</span>
        </button>
        <div class="p-3 border-t" x-show="showScripture" x-cloak>
          <div class="flex items-center gap-2">
            <input class="flex-1 border rounded px-2 py-1" type="text" placeholder="e.g., John 3:5-6, 8-10"
              x-model="form.scripture" />
            <button class="px-2 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
              @click="fetchScripture()">Fetch Text</button>
          </div>
          <textarea class="mt-2 w-full border rounded px-2 py-1" rows="6" x-model="scriptureText"
            placeholder="Scripture text (editable)"></textarea>
            <div class="mt-2 flex">
              <label class="text-sm block">Theme
                <input type="text" class="mt-1 w-full border rounded px-2 py-1" x-model="form.theme" />
              </label>
              <label class="text-sm block flex-1">Keywords
                <input type="text" class="mt-1 w-full border rounded px-2 py-1" placeholder="Auto from Scripture; comma separated" x-model="form.keywords" />
              </label>
            </div>
        </div>
      </div>
    </div>

    <div class="mt-2 border rounded">
      <button type="button" class="w-full flex items-center px-3 py-2" @click="showNotes = !showNotes">
        <span class="mr-2 select-none text-3xl text-blue-700" x-text="showNotes ? '▾' : '▸'"></span>
        <span class="font-medium">Notes</span>
      </button>
      <div class="p-3 border-t" x-show="showNotes" x-cloak>

        <label class="text-sm block mt-2">Notes
          <textarea class="mt-1 w-full border rounded px-2 py-1" rows="3" x-model="form.notes"></textarea>
        </label>
      </div>
    </div>

    <div class="mt-4 border rounded p-3" x-show="showOrder" x-cloak>
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-3">
          <span class="font-medium">Order of Worship</span>
          <span class="text-xs text-gray-500" x-show="savingOrder">Saving…</span>
          <span class="text-xs text-gray-500" x-show="!savingOrder && savedAt">Saved</span>
        </div>
        <div class="flex gap-2"><button
            class="px-2 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
            @click="addOrderRow()">+ Add Row</button></div>
      </div>
      <div class="max-h-[50vh] overflow-auto">
        <table class="min-w-full border text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="border px-2 py-1 w-14 text-left">#</th>
              <th class="border px-2 py-1 text-left">Item</th>
              <th class="border px-2 py-1 text-left">Detail</th>
              <th class="border px-2 py-1 text-left">Leader</th>
              <th class="border px-2 py-1 text-left">Notes</th>
              <th class="border px-2 py-1 w-28">Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(row, i) in orderRows" :key="'ord-'+i">
              <tr>
                <td class="border px-2 py-1" x-text="i+1"></td>
                <td class="border px-2 py-1">
                  <select class="border rounded px-2 py-1 w-full" x-model="row.itemType" @change="queueSaveOrder(true)">
                    <option :value="row.itemType" x-text="row.itemType"></option>
                    <template x-for="t in orderItemTypes" :key="t">
                      <option :value="t" x-text="t"></option>
                    </template>
                  </select>
                </td>
                <td class="border px-2 py-1 relative">
                  <div class="flex items-center gap-2 relative">
                    <input class="border rounded px-2 py-1 w-full" x-model="row.detail" @input="queueSaveOrder()" @blur="queueSaveOrder(true)"
                      placeholder="e.g., Song title" />
                    <!-- Idea button appears only for Song items and Scripture/Call to Worship -->
                    <button class="px-2 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
                      title="Suggest" aria-label="Suggest"
                      x-show="/song\b|call to worship|scripture/i.test(String(row.itemType||''))"
                      @click.stop="suggestForRow(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                        <path d="M12 2a7 7 0 00-4.9 11.9c.37.37.74.92.9 1.49l.23.79h7.34l.23-.79c.16-.57.53-1.12.9-1.49A7 7 0 0012 2zm-3 17.5a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5a.5.5 0 01-.5-.5zm1.5 2a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5z"/>
                      </svg>
                    </button>
                    <!-- Eye button to view stored scripture text -->
                    <button class="px-2 py-1 rounded text-blue-800 hover:bg-blue-50" title="View Scripture Text"
                      x-show="row.scriptureText"
                      @click.stop="viewRowScripture(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                        <path d="M12 5c-5 0-9 4.5-10 7 1 2.5 5 7 10 7s9-4.5 10-7c-1-2.5-5-7-10-7zm0 11a4 4 0 110-8 4 4 0 010 8z"/>
                      </svg>
                    </button>
                  <!-- Inline scripture suggestions dropdown -->
                    <div x-show="false"></div>
                  </div>
                </td>
                <td class="border px-2 py-1"><input class="border rounded px-2 py-1 w-full" x-model="row.leader" @input="queueSaveOrder()" @blur="queueSaveOrder(true)"
                    placeholder="Leader" /></td>
                <td class="border px-2 py-1"><input class="border rounded px-2 py-1 w-full" x-model="row.notes" @input="queueSaveOrder()" @blur="queueSaveOrder(true)"
                    placeholder="Notes" /></td>
                <td class="border px-2 py-1">
                  <div class="flex gap-1">
                    <button aria-label="Move up" class="px-1 py-1 text-3xl text-blue-800" @click="moveOrderRow(i,-1)">▴</button>
                    <button aria-label="Move down" class="px-1 py-1 text-3xl text-blue-800" @click="moveOrderRow(i,1)">▾</button>
                    <button aria-label="Remove" class="px-1 py-1 font-bold text-blue-800" @click="removeOrderRow(i)">✕</button>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Save button moved to header next to Load -->
  </div>

  <!-- Suggest Songs Modal -->
  <div x-show="showSuggestModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center"
    @keydown.window.escape.prevent="showSuggestModal=false">
    <div class="absolute inset-0 bg-black/40" @click="showSuggestModal=false"></div>
    <div class="relative bg-white rounded shadow-lg w-[1000px] max-w-[95vw] h-[80vh] p-0 flex flex-col">
      <div class="px-4 py-2 border-b flex items-center justify-between">
        <div class="font-semibold">Suggest Songs</div>
        <button class="text-sm underline" @click="showSuggestModal=false">Close</button>
      </div>
      <div class="flex-1 min-h-0">
        <div x-data="songsApp()" x-init="init()" x-ref="suggestApp" class="h-full flex flex-col">
          <div class="sticky top-0 z-10 bg-white border-b">
            <div class="p-3 flex flex-wrap items-center gap-3">
              <input type="search" placeholder="Search" class="border rounded px-3 py-1 w-64" x-model.debounce.200ms="q"
                @search="render(true)" />
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" x-model="searchLyrics"
                  @change="render()" /> Lyrics</label>
              <label class="text-sm">Season:
                <select class="border rounded px-2 py-1" x-model="selectedSeason" @change="render()">
                  <option value="">All</option>
                  <template x-for="{key,label} in seasons" :key="key">
                    <option :value="key" x-text="label"></option>
                  </template>
                </select>
              </label>
              <label class="text-sm">Leader:
                <select class="border rounded px-2 py-1" x-model="selectedLeader" @change="render()">
                  <option value="">All</option>
                  <template x-for="name in leaderOptions" :key="name">
                    <option :value="name" x-text="name"></option>
                  </template>
                </select>
              </label>
              <label class="text-sm">Usage:
                <select class="border rounded px-2 py-1" x-model="selectedUsage" @change="render()">
                  <option value="">All</option>
                  <template x-for="u in usageOptions" :key="u">
                    <option :value="u" x-text="u"></option>
                  </template>
                </select>
              </label>
              <span class="text-sm text-gray-700" x-text="filtered.length + ' of ' + rows.length + ' shown'"></span>
            </div>
          </div>
          <div class="flex-1 min-h-0 p-3">
            <div class="flex gap-3 h-full">
              <div class="w-[320px] flex-shrink-0 h-full overflow-auto border rounded">
                <table class="min-w-full">
                  <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr>
                      <th class="text-left px-2 py-1">Song</th>
                      <th class="text-left px-2 py-1">Last Used</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="(r, i) in filtered" :key="i">
                      <tr class="odd:bg-white even:bg-gray-50 hover:bg-indigo-50 cursor-pointer"
                        :class="selected === r ? 'ring-2 ring-indigo-400' : ''" @click="select(r)">
                        <td class="px-2 py-1" x-text="r['Song']"></td>
                        <td class="px-2 py-1" x-text="format(r['Last_Used'])"></td>
                      </tr>
                    </template>
                    <tr x-show="!filtered.length">
                      <td class="px-2 py-6 text-center text-gray-500" colspan="2">No results</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="flex-1 h-full overflow-auto border rounded p-3">
                <div x-show="selected">
                  <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold" x-text="selected?.Song || '(Untitled)'"></h3>
                    <button class="px-2 py-1 border rounded"
                      @click="$dispatch('use-song', { index: $root.suggestTargetIndex, name: selected?.Song || '' })">Use
                      This Song</button>
                  </div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Leader">Leader: <span class="font-medium"
                      x-text="selected?.Leader"></span></div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Season">Season: <span class="font-medium"
                      x-text="selected?.Season"></span></div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Themes">Themes: <span class="font-medium"
                      x-text="selected?.Themes"></span></div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Scriptures">Scriptures: <span
                      class="font-medium" x-text="selected?.Scriptures"></span></div>
                  <div class="mt-3" x-show="selected?.Notes">
                    <div class="text-sm font-medium text-gray-700 mb-1">Notes</div>
                    <div class="text-sm whitespace-pre-wrap" x-text="selected?.Notes"></div>
                  </div>
                  <div class="mt-3">
                    <div class="text-sm font-medium text-gray-700 mb-1">Lyrics</div>
                    <pre class="bg-gray-50 border rounded p-2 max-h-[40vh] overflow-auto whitespace-pre-wrap"
                      x-text="selected?.Lyrics || selected?.['Lyrics (PD)'] || '(No lyrics)'"></pre>
                  </div>
                </div>
                <div x-show="!selected" class="text-gray-500">Select a song to preview.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripture Ideas Modal -->
  <div x-show="showScriptureModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center" @keydown.window.escape.prevent="showScriptureModal=false">
    <div class="absolute inset-0 bg-black/40" @click="showScriptureModal=false"></div>
    <div class="relative bg-white rounded shadow-lg w-[1000px] max-w-[95vw] h-[80vh] p-0 flex flex-col">
      <div class="px-4 py-2 border-b flex items-center justify-between">
        <div class="font-semibold">Scripture Ideas</div>
        <button class="text-sm underline" @click="showScriptureModal=false">Close</button>
      </div>
      <div class="flex-1 min-h-0 p-3">
        <div class="flex gap-3 h-full">
          <div class="w-[280px] flex-shrink-0 h-full overflow-auto border rounded">
            <div class="text-xs text-gray-500 px-2 py-1 border-b">References</div>
            <template x-for="s in scriptureSuggestions" :key="s">
              <button class="block w-full text-left px-2 py-1 hover:bg-blue-50"
                      :class="selectedScriptureRef===s ? 'bg-blue-50' : ''"
                      @click="selectedScriptureRef=s; fetchPassage(s)">
                <span x-text="s"></span>
              </button>
            </template>
          </div>
          <div class="flex-1 h-full overflow-auto border rounded p-3">
            <div class="flex items-center justify-between mb-2 gap-3">
              <div class="flex items-center gap-2 flex-1">
                <input type="text" class="border rounded px-2 py-1 w-full" x-model="selectedScriptureRef" @input="refChanged()" placeholder="e.g., John 1:1-5" />
                <button class="px-2 py-1 border rounded" @click="fetchPassage(selectedScriptureRef)">Fetch</button>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-xs inline-flex items-center gap-1"><input type="checkbox" x-model="setAsMainScripture" /> Set as main Scripture</label>
                <button class="px-2 py-1 border rounded bg-blue-50 text-blue-800 border-blue-300 hover:bg-blue-100" @click="chooseScripture()">Use This Passage</button>
              </div>
            </div>
            <div class="font-medium mb-1" x-text="selectedScriptureRef || 'Select a reference'"></div>
            <div class="text-sm prose max-w-none" x-show="selectedScriptureHtml" x-html="selectedScriptureHtml"></div>
            <pre class="whitespace-pre-wrap text-sm" x-show="!selectedScriptureHtml" x-text="selectedScriptureText || '(No text)'"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
