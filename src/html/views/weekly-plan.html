<div x-data="weeklyPlanApp()" x-init="init()"
  @use-song.window="applySuggestion(suggestTargetIndex, { name: $event.detail.name }); showSuggestModal=false"
  class="min-h-screen flex flex-col overflow-y-auto pt-6 md:pt-8">
  <div class="p-3 border-b flex items-center gap-3 bg-gray-100">
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-700">Existing Service</label>
      <select class="border rounded px-2 py-1 min-w-[320px]" x-model="selectedServiceId">
        <option value="" disabled selected>Select...</option>
        <template x-for="s in existingServices" :key="s.id || (s.date + s.time)">
          <option :value="s.id"
            x-text="(s.id || ((s.date||'') + (s.time?(' '+s.time):''))) + (s.type?(' - '+s.type):'') + (s.leader?(' ('+s.leader+')'):'')">
          </option>
        </template>
      </select>
      <button class="inline-flex items-center justify-center h-9 px-3 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100 disabled:opacity-50"
        :disabled="loadingServices || !selectedServiceId"
        @click="loadSelected()">Load</button>
      <template x-if="!selectedServiceId">
        <button class="inline-flex items-center justify-center h-9 px-3 rounded bg-emerald-600 text-white hover:bg-emerald-700"
          @click="submit()" x-text="actionLabel()"></button>
      </template>
      <button
        class="ml-1 inline-flex items-center justify-center h-9 w-9 rounded bg-rose-50 text-rose-800 border border-rose-300 hover:bg-rose-100 disabled:opacity-50"
        :disabled="loadingServices || !selectedServiceId"
        title="Delete service"
        @click="selectedServiceId && confirm('Delete this service and all its items?') && deleteSelectedService()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
          <path
            d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166M19.5 5.79 18.16 19.673A2.25 2.25 0 0 1 15.916 21.75H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.455 0c-1.146-.173-2.306-.306-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397M15.75 5.394V4.478c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0C9.16 2.314 8.25 3.299 8.25 4.478v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
        </svg>
      </button>
    </div>
    <div class="flex-1"></div>
    <div class="flex items-center gap-2">
      <span x-cloak x-show="loadingServices"
        class="inline-flex items-center gap-2 text-sm text-blue-800 bg-blue-50 border border-blue-200 px-2 py-1 rounded">
        <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
          stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="9" stroke-opacity=".25"></circle>
          <path d="M21 12a9 9 0 0 1-9 9" stroke-linecap="round"></path>
        </svg>
        <span>Syncing services...</span>
      </span>
      <button
        class="inline-flex items-center justify-center h-9 px-3 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100 disabled:opacity-50"
        :disabled="loadingServices" @click="newService()">New Service</button>
    </div>
  </div>

  <div class="mx-4 mt-3 mb-0" x-show="loadingServices" x-cloak>
    <div class="rounded border border-blue-200 bg-blue-50 text-blue-800 px-3 py-2 text-sm">Fetching existing services...
      please wait.</div>
  </div>

  <div class="p-4" x-show="showDetails" x-cloak>
    <h3 class="text-lg font-semibold mb-3 sr-only">Service Details</h3>
    <div class="flex gap-2 flex-wrap">
      <div class="pr-6">
        <h1 class="font-bold text-2xl" x-html="formattedDateTimeHtml()"></h1>
      </div>
      <label class="text-sm flex-1">Service Type
        <select class="mt-1 w-full border rounded px-2 py-1" x-model="form.type" @change="queueSaveDetails()">
          <option value="Communion">Communion</option>
          <option value="Offering">Offering</option>
        </select>
      </label>
      <label class="text-sm flex-1">Leader
        <div class="mt-1">
          <select x-ref="leaderSel" class="border rounded px-2 py-1 w-full" x-model="leaderSelect"
            @change="form.leader = leaderSelect==='__custom' ? '' : leaderSelect; queueSaveDetails()">
            <template x-for="n in leaderChoices" :key="'lead-'+n">
              <option :value="n" x-text="n"></option>
            </template>
            <option value="__custom">Custom...</option>
          </select>
        </div>
        <template x-if="leaderSelect==='__custom'"><input type="text" class="mt-2 w-full border rounded px-2 py-1"
            placeholder="Type leader name" x-model="form.leader" @input="queueSaveDetails()" /></template>
      </label>
      <label class="text-sm min-w-32 flex-1">Preacher
        <div class="mt-1">
          <select x-ref="preacherSel" class="border rounded px-2 py-1 w-full" x-model="preacherSelect"
            @change="form.preacher = preacherSelect==='__custom' ? '' : preacherSelect; queueSaveDetails()">
            <template x-for="n in preacherChoices" :key="'prech-'+n">
              <option :value="n" x-text="n"></option>
            </template>
            <option value="__custom">Custom...</option>
          </select>
        </div>
        <template x-if="preacherSelect==='__custom'"><input type="text" class="mt-2 w-full border rounded px-2 py-1"
            placeholder="Type preacher name" x-model="form.preacher" @input="queueSaveDetails()" /></template>
      </label>
    </div>

    <div class="pt-2">
      <div class="border rounded w-full">
        <button type="button" class="w-full flex items-center px-3 py-2" @click="showScripture = !showScripture">
          <span class="mr-2 select-none text-3xl text-blue-700" x-text="showScripture ? '▾' : '▸'"></span>
          <span class="font-medium">Scripture</span>
        </button>
        <div class="p-3 border-t" x-show="showScripture" x-cloak>
          <div class="flex items-center gap-2">
            <input class="flex-1 border rounded px-2 py-1" type="text" placeholder="e.g., John 3:5-6, 8-10"
              x-model="form.scripture" @input="queueSaveDetails()" />
            <button class="px-2 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
              @click="fetchScripture()">Fetch Text</button>
          </div>
          <textarea class="mt-2 w-full border rounded px-2 py-1" rows="6" x-model="scriptureText" @input="queueSaveDetails()"
            placeholder="Scripture text (editable)"></textarea>
            <div class="mt-2 flex">
              <label class="text-sm block">Theme
                <input type="text" class="mt-1 w-full border rounded px-2 py-1" x-model="form.theme" @input="queueSaveDetails()" />
              </label>
              <label class="text-sm block flex-1">Keywords
                <input type="text" class="mt-1 w-full border rounded px-2 py-1" placeholder="Auto from Scripture; comma separated" x-model="form.keywords" @input="queueSaveDetails()" />
              </label>
            </div>
            <label class="text-sm block mt-2">Notes
              <textarea class="mt-1 w-full border rounded px-2 py-1" rows="3" x-model="form.notes" @input="queueSaveDetails()"></textarea>
            </label>
        </div>
      </div>
    </div>

    <div class="mt-4 border rounded p-3" x-show="showOrder" x-cloak>
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-3">
          <span class="font-medium">Order of Worship</span>
          <span class="text-xs text-gray-500" x-show="savingOrder">Saving…</span>
          <span class="text-xs text-gray-500" x-show="!savingOrder && savedAt">Saved</span>
        </div>
        <div class="flex gap-2"><button
            class="px-2 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
            @click="addOrderRow()">+ Add Row</button></div>
      </div>
      <div class="relative max-h-[50vh] overflow-auto">
        <div x-cloak x-show="loadingOrder"
          class="absolute inset-0 z-10 flex items-center justify-center bg-white/80 backdrop-blur-sm">
          <div class="inline-flex items-center gap-2 text-sm text-indigo-700">
            <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="9" stroke-opacity=".25"></circle>
              <path d="M21 12a9 9 0 0 1-9 9" stroke-linecap="round"></path>
            </svg>
            <span>Loading order...</span>
          </div>
        </div>
        <table class="min-w-full border text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="border px-2 py-1 w-14 text-left">#</th>
              <th class="border px-2 py-1 text-left">Item</th>
              <th class="border px-2 py-1 text-left">Detail</th>
              <th class="border px-2 py-1 text-left">Leader</th>
              <th class="border px-2 py-1 text-left">Notes</th>
              <th class="border px-2 py-1 w-28">Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(row, i) in orderRows" :key="'ord-'+i">
              <tr>
                <td class="border px-2 py-1" x-text="i+1"></td>
                <td class="border px-2 py-1">
                  <select class="border rounded px-2 py-1 w-full" x-model="row.itemType" @change="queueSaveOrder(true)">
                    <option :value="row.itemType" x-text="row.itemType"></option>
                    <template x-for="t in orderItemTypes" :key="t">
                      <option :value="t" x-text="t"></option>
                    </template>
                  </select>
                </td>
                <td class="border px-2 py-1 relative">
                  <div class="flex items-center gap-2 relative">
                    <template x-if="loadingSuggestion && suggestTargetIndex === i">
                      <div class="absolute inset-y-0 right-12 flex items-center text-xs text-indigo-600">
                        <svg class="h-3.5 w-3.5 animate-spin mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <circle cx="12" cy="12" r="9" stroke-opacity=".25"></circle>
                          <path d="M21 12a9 9 0 0 1-9 9" stroke-linecap="round"></path>
                        </svg>
                        <span>Thinking...</span>
                      </div>
                    </template>
                    <input class="border rounded px-2 py-1 w-full" x-model="row.detail" @input="queueSaveOrder()" @blur="queueSaveOrder(true)"
                      placeholder="e.g., Song title" />
                    <!-- Suggest songs -->
                    <button class="px-2 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
                      title="Suggest song" aria-label="Suggest song"
                      x-show="/song/i.test(String(row.itemType||''))"
                      :disabled="loadingSuggestion"
                      @click.stop="suggestForRow(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        class="w-4 h-4">
                        <path
                          d="M12 18V12.75M12 12.75c.518 0 1.021-.066 1.5-.189M12 12.75c-.518 0-1.021-.066-1.5-.189M14.25 20.039A9.02 9.02 0 0 1 12 20.25c-.769 0-1.521-.073-2.25-.211M13.5 22.422A14.706 14.706 0 0 1 12 22.5c-.507 0-1.007-.026-1.5-.078M14.25 18v-.192c0-.983.658-1.823 1.508-2.316A7.46 7.46 0 0 0 19.5 9c0-4.142-3.358-7.5-7.5-7.5S4.5 4.858 4.5 9c0 2.773 1.505 5.194 3.742 6.492.85.493 1.508 1.333 1.508 2.316V18" />
                      </svg>
                    </button>
                    <!-- Suggest scripture -->
                    <button class="px-2 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
                      title="Suggest scripture" aria-label="Suggest scripture"
                      x-show="/call to worship|scripture/i.test(String(row.itemType||''))"
                      :disabled="loadingSuggestion"
                      @click.stop="suggestForRow(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        class="w-4 h-4">
                        <path
                          d="M12 6.042C10.408 4.617 8.305 3.75 6 3.75c-1.052 0-2.062.18-3 .512v14.25c.938-.332 1.948-.512 3-.512 2.305 0 4.408.867 6 2.292m0-14.25C13.592 4.617 15.695 3.75 18 3.75c1.052 0 2.062.18 3 .512v14.25c-.938-.332-1.948-.512-3-.512-2.305 0-4.408.867-6 2.292m0-14.25v14.25" />
                      </svg>
                    </button>
                    <!-- Eye button to view stored scripture text -->
                    <button class="px-2 py-1 rounded text-blue-800 hover:bg-blue-50" title="View Scripture Text"
                      x-show="row.scriptureText"
                      @click.stop="viewRowScripture(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                        <path d="M12 5c-5 0-9 4.5-10 7 1 2.5 5 7 10 7s9-4.5 10-7c-1-2.5-5-7-10-7zm0 11a4 4 0 110-8 4 4 0 010 8z"/>
                      </svg>
                    </button>
                  <!-- Inline scripture suggestions dropdown -->
                    <div x-show="false"></div>
                  </div>
                </td>
                <td class="border px-2 py-1"><input class="border rounded px-2 py-1 w-full" x-model="row.leader" @input="queueSaveOrder()" @blur="queueSaveOrder(true)"
                    placeholder="Leader" /></td>
                <td class="border px-2 py-1"><input class="border rounded px-2 py-1 w-full" x-model="row.notes" @input="queueSaveOrder()" @blur="queueSaveOrder(true)"
                    placeholder="Notes" /></td>
                <td class="border px-2 py-1">
                  <div class="flex items-center gap-1">
                    <button type="button" aria-label="Move up"
                      class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-indigo-200 text-indigo-600 hover:bg-indigo-50 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-0"
                      @click="moveOrderRow(i,-1)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"
                        aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m4.5 15.75 7.5-7.5 7.5 7.5" />
                      </svg>
                    </button>
                    <button type="button" aria-label="Move down"
                      class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-indigo-200 text-indigo-600 hover:bg-indigo-50 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-0"
                      @click="moveOrderRow(i,1)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"
                        aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                      </svg>
                    </button>
                    <button type="button" aria-label="Remove"
                      class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-rose-200 text-rose-600 hover:bg-rose-50 hover:border-rose-300 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-offset-0"
                      @click="removeOrderRow(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"
                        aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.455 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Save button moved to header next to Load -->
  </div>

  <!-- Suggest Songs Modal -->
  <div x-show="showSuggestModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center"
    @keydown.window.escape.prevent="showSuggestModal=false">
    <div class="absolute inset-0 bg-black/40" @click="showSuggestModal=false"></div>
    <div class="relative bg-white rounded shadow-lg max-w-[95vw] h-[80vh] p-0 flex flex-col">
      <div class="px-4 py-2 border-b flex items-center justify-between">
        <div class="font-semibold">Suggest Songs</div>
        <button class="text-sm underline" @click="showSuggestModal=false">Close</button>
      </div>
      <div class="flex-1 min-h-0">
        <div x-data="songsApp()" x-init="init()" x-ref="suggestApp" class="h-full flex flex-col">
          <div class="sticky top-0 z-10 bg-white border-b">
            <div class="p-3 flex flex-wrap items-center gap-3">
              <input type="search" placeholder="Search" class="border rounded px-3 py-1 w-64" x-model.debounce.200ms="q"
                @search="render(true)" />
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" x-model="searchLyrics"
                  @change="render()" /> Lyrics</label>
              <label class="text-sm">Season:
                <select class="border rounded px-2 py-1" x-model="selectedSeason" @change="render()">
                  <option value="">All</option>
                  <template x-for="{key,label} in seasons" :key="key">
                    <option :value="key" x-text="label"></option>
                  </template>
                </select>
              </label>
              <label class="text-sm">Leader:
                <select class="border rounded px-2 py-1" x-model="selectedLeader" @change="render()">
                  <option value="">All</option>
                  <template x-for="name in leaderOptions" :key="name">
                    <option :value="name" x-text="name"></option>
                  </template>
                </select>
              </label>
              <label class="text-sm">Usage:
                <select class="border rounded px-2 py-1" x-model="selectedUsage" @change="render()">
                  <option value="">All</option>
                  <template x-for="u in usageOptions" :key="u">
                    <option :value="u" x-text="u"></option>
                  </template>
                </select>
              </label>
              <span class="text-sm text-gray-700" x-text="filtered.length + ' of ' + rows.length + ' shown'"></span>
            </div>
          </div>
          <div class="flex-1 min-h-0 p-3">
            <div class="flex gap-3 h-full">
              <div class="w-[320px] flex-shrink-0 h-full overflow-auto border rounded">
                <table class="min-w-full">
                  <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr>
                      <template x-for="h in tableHeaders" :key="h">
                        <th class="text-left px-2 py-1 cursor-pointer select-none" @click="sort(h)">
                          <span class="inline-block w-4 text-xs align-middle" x-html="headerIcon(h)"></span>
                          <span x-text="headerLabel(h)"></span>
                        </th>
                      </template>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="(r, i) in filtered" :key="i">
                      <tr class="odd:bg-white even:bg-gray-50 hover:bg-indigo-50 cursor-pointer"
                        :class="selected === r ? 'ring-2 ring-indigo-400' : ''" @click="select(r)">
                        <template x-for="h in tableHeaders" :key="h">
                          <td class="px-2 py-1" x-text="format(r[h])"></td>
                        </template>
                      </tr>
                    </template>
                    <tr x-show="!filtered.length">
                      <td class="px-2 py-6 text-center text-gray-500" :colspan="tableHeaders.length">No results</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="flex-1 h-full overflow-auto border rounded p-3">
                <div x-show="selected">
                  <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold" x-text="selected?.Song || '(Untitled)'"></h3>
                    <button class="px-2 py-1 border rounded"
                      @click="$dispatch('use-song', { index: $root.suggestTargetIndex, name: selected?.Song || '' })">Use
                      This Song</button>
                  </div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Leader">Leader: <span class="font-medium"
                      x-text="selected?.Leader"></span></div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Season">Season: <span class="font-medium"
                      x-text="selected?.Season"></span></div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Themes">Themes: <span class="font-medium"
                      x-text="selected?.Themes"></span></div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Scriptures">Scriptures: <span
                      class="font-medium" x-text="selected?.Scriptures"></span></div>
                  <div class="mt-3" x-show="selected?.Notes">
                    <div class="text-sm font-medium text-gray-700 mb-1">Notes</div>
                    <div class="text-sm whitespace-pre-wrap" x-text="selected?.Notes"></div>
                  </div>
                  <div class="mt-3">
                  <div class="text-sm font-medium text-gray-700 mb-1">Lyrics</div>
                  <div class="bg-gray-50 border rounded p-2 max-h-[40vh] overflow-auto whitespace-pre-wrap"
                    x-html="highlightedLyrics()"></div>
                  </div>
                </div>
                <div x-show="!selected" class="text-gray-500">Select a song to preview.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripture Ideas Modal -->
  <div x-show="showScriptureModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center" @keydown.window.escape.prevent="showScriptureModal=false">
    <div class="absolute inset-0 bg-black/40" @click="showScriptureModal=false"></div>
    <div class="relative bg-white rounded shadow-lg max-w-[95vw] h-[80vh] p-0 flex flex-col">
      <div class="px-4 py-2 border-b flex items-center justify-between">
        <div class="font-semibold">Scripture Ideas</div>
        <button class="text-sm underline" @click="showScriptureModal=false">Close</button>
      </div>
      <div class="flex-1 min-h-0 p-3">
        <div class="mb-3 grid gap-2 md:grid-cols-[repeat(auto-fit,minmax(180px,1fr))]">
          <label class="text-xs text-gray-600 flex flex-col gap-1">
            Theme
            <input type="text" class="border rounded px-2 py-1" placeholder="Theme"
              x-model="scriptureSearchTheme" />
          </label>
          <label class="text-xs text-gray-600 flex flex-col gap-1">
            Keywords
            <input type="text" class="border rounded px-2 py-1" placeholder="Comma separated"
              x-model="scriptureSearchKeywords" />
          </label>
          <div class="flex items-end gap-2">
            <button class="px-3 py-1.5 border rounded bg-blue-50 text-blue-800 border-blue-300 hover:bg-blue-100 disabled:opacity-50"
              :disabled="scriptureSearchPending"
              @click="refreshScriptureIdeas('manual')">
              <span x-show="!scriptureSearchPending">Search Ideas</span>
              <span x-show="scriptureSearchPending">Searching…</span>
            </button>
            <div class="text-xs text-rose-600" x-show="scriptureSearchError" x-text="scriptureSearchError"></div>
          </div>
        </div>
        <style>
          .scripture-html sup,
          .scripture-html .verse-num {
            color: #1d4ed8;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.25rem;
          }
          .scripture-html .verse-num sup {
            color: inherit;
            font-size: inherit;
            margin: 0;
          }
          .scripture-ref-main {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
          }
          .scripture-ref-main.is-selected {
            background-color: #fde68a;
            border-left-color: #d97706;
          }
        </style>
        <div class="flex gap-3 h-full">
          <div class="w-[250px] flex-shrink-0 h-full overflow-auto border rounded">
            <div class="text-xs text-gray-500 px-2 py-1 border-b">References</div>
            <template x-if="form.scripture">
              <div class="px-2 py-2 border-b border-amber-200 bg-amber-50/70">
                <div class="text-[11px] uppercase tracking-wide text-amber-700 font-semibold mb-1">Main Scripture</div>
                <button class="block w-full text-left px-2 py-1 rounded scripture-ref-main"
                        :class="selectedScriptureRef === form.scripture ? 'is-selected' : ''"
                        @click="selectedScriptureRef=form.scripture; fetchPassage(form.scripture)">
                  <span x-text="form.scripture"></span>
                </button>
              </div>
            </template>
            <template x-if="scriptureSuggestions.length">
              <div>
                <template x-for="s in scriptureSuggestions" :key="s">
                  <button class="block w-full text-left px-2 py-1 hover:bg-blue-50"
                          :class="selectedScriptureRef===s ? 'bg-blue-50' : ''"
                          @click="selectedScriptureRef=s; fetchPassage(s)">
                    <span x-text="s"></span>
                  </button>
                </template>
              </div>
            </template>
            <div class="text-xs text-gray-500 px-2 py-3" x-show="!scriptureSuggestions.length">
              No AI suggestions yet — enter a reference manually or tweak the search inputs.
            </div>
          </div>
          <div class="w-[500px] h-full overflow-auto border rounded p-3">
            <div class="flex items-center justify-between mb-2 gap-3">
              <div class="flex items-center gap-2 flex-1">
                <input type="text" class="border rounded px-2 py-1 w-full" x-model="selectedScriptureRef" @input="refChanged()" placeholder="e.g., John 1:1-5" />
              </div>
              <div class="flex items-center gap-2">
                <button class="px-2 py-1 border rounded text-blue-800 bg-blue-50 border-blue-200 hover:bg-blue-100"
                  @click="toggleScriptureEditing()">
                  <span x-show="!isScriptureEditing">Edit Passage</span>
                  <span x-show="isScriptureEditing">Hide Editor</span>
                </button>
                <button class="px-2 py-1 border rounded bg-blue-50 text-blue-800 border-blue-300 hover:bg-blue-100" @click="chooseScripture()">Use This Passage</button>
              </div>
            </div>
            <div class="font-medium mb-1" x-text="selectedScriptureRef || 'Select a reference'"></div>
            <div class="text-sm prose max-w-none scripture-html" x-show="selectedScriptureHtml" x-html="selectedScriptureHtml"></div>
            <textarea x-ref="scriptureEditor" class="border rounded w-full mt-2 px-2 py-2 text-sm min-h-[160px] resize-y font-sans"
              :class="isScriptureEditing || !selectedScriptureHtml ? '' : 'hidden'"
              placeholder="Type or paste a scripture reference"
              x-model="selectedScriptureText" @input="customScriptureEdited()"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



