<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="app-script-base" content="https://worship-plan-proxy.belinda-caylor.workers.dev">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Worship Planner</title>

  <style>*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/*! tailwindcss v3.4.14 | MIT License | https://tailwindcss.com*/*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}.pointer-events-none{pointer-events:none}.visible{visibility:visible}.collapse{visibility:collapse}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.sticky{position:sticky}.inset-0{inset:0}.inset-y-0{top:0;bottom:0}.bottom-0{bottom:0}.bottom-1{bottom:.25rem}.left-0{left:0}.right-0{right:0}.right-12{right:3rem}.right-4{right:1rem}.top-0{top:0}.z-0{z-index:0}.z-10{z-index:10}.z-20{z-index:20}.z-30{z-index:30}.z-40{z-index:40}.z-50{z-index:50}.mx-4{margin-left:1rem;margin-right:1rem}.mx-auto{margin-left:auto;margin-right:auto}.-mb-px{margin-bottom:-1px}.mb-0{margin-bottom:0}.mb-1{margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-5{margin-bottom:1.25rem}.ml-1{margin-left:.25rem}.ml-auto{margin-left:auto}.mr-1{margin-right:.25rem}.mr-2{margin-right:.5rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.contents{display:contents}.hidden{display:none}.h-14{height:3.5rem}.h-3\.5{height:.875rem}.h-4{height:1rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-8{height:2rem}.h-9{height:2.25rem}.h-\[80vh\]{height:80vh}.h-full{height:100%}.max-h-64{max-height:16rem}.max-h-96{max-height:24rem}.max-h-\[40vh\]{max-height:40vh}.max-h-\[50vh\]{max-height:50vh}.max-h-\[60vh\]{max-height:60vh}.max-h-\[90vh\]{max-height:90vh}.min-h-0{min-height:0}.min-h-\[120px\]{min-height:120px}.min-h-\[140px\]{min-height:140px}.min-h-\[160px\]{min-height:160px}.min-h-\[80px\]{min-height:80px}.min-h-\[88px\]{min-height:88px}.min-h-\[calc\(100vh-56px\)\]{min-height:calc(100vh - 56px)}.min-h-full{min-height:100%}.min-h-screen{min-height:100vh}.w-12{width:3rem}.w-14{width:3.5rem}.w-28{width:7rem}.w-3\.5{width:.875rem}.w-4{width:1rem}.w-44{width:11rem}.w-48{width:12rem}.w-5{width:1.25rem}.w-56{width:14rem}.w-6{width:1.5rem}.w-64{width:16rem}.w-8{width:2rem}.w-80{width:20rem}.w-9{width:2.25rem}.w-\[250px\]{width:250px}.w-\[320px\]{width:320px}.w-\[360px\]{width:360px}.w-\[500px\]{width:500px}.w-\[95vw\]{width:95vw}.w-full{width:100%}.min-w-0{min-width:0}.min-w-32{min-width:8rem}.min-w-\[180px\]{min-width:180px}.min-w-\[200px\]{min-width:200px}.min-w-\[320px\]{min-width:320px}.min-w-full{min-width:100%}.max-w-3xl{max-width:48rem}.max-w-4xl{max-width:56rem}.max-w-\[95vw\]{max-width:95vw}.max-w-lg{max-width:32rem}.max-w-md{max-width:28rem}.max-w-none{max-width:none}.max-w-xl{max-width:36rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}@keyframes spin{to{transform:rotate(1turn)}}.animate-spin{animation:spin 1s linear infinite}.cursor-pointer{cursor:pointer}.select-none{-webkit-user-select:none;-moz-user-select:none;user-select:none}.resize-y{resize:vertical}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem*var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.divide-y>:not([hidden])~:not([hidden]){--tw-divide-y-reverse:0;border-top-width:calc(1px*(1 - var(--tw-divide-y-reverse)));border-bottom-width:calc(1px*var(--tw-divide-y-reverse))}.self-start{align-self:flex-start}.overflow-auto{overflow:auto}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.whitespace-pre-wrap{white-space:pre-wrap}.break-all{word-break:break-all}.rounded{border-radius:.25rem}.rounded-lg{border-radius:.5rem}.rounded-md{border-radius:.375rem}.rounded-t-md{border-top-left-radius:.375rem;border-top-right-radius:.375rem}.rounded-t-xl{border-top-left-radius:.75rem;border-top-right-radius:.75rem}.border{border-width:1px}.border-x{border-left-width:1px;border-right-width:1px}.border-b{border-bottom-width:1px}.border-b-2{border-bottom-width:2px}.border-l{border-left-width:1px}.border-l-4{border-left-width:4px}.border-r{border-right-width:1px}.border-t{border-top-width:1px}.border-amber-200{--tw-border-opacity:1;border-color:rgb(253 230 138/var(--tw-border-opacity))}.border-amber-400{--tw-border-opacity:1;border-color:rgb(251 191 36/var(--tw-border-opacity))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity))}.border-blue-300{--tw-border-opacity:1;border-color:rgb(147 197 253/var(--tw-border-opacity))}.border-blue-400{--tw-border-opacity:1;border-color:rgb(96 165 250/var(--tw-border-opacity))}.border-blue-600{--tw-border-opacity:1;border-color:rgb(37 99 235/var(--tw-border-opacity))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219/var(--tw-border-opacity))}.border-indigo-200{--tw-border-opacity:1;border-color:rgb(199 210 254/var(--tw-border-opacity))}.border-rose-200{--tw-border-opacity:1;border-color:rgb(254 205 211/var(--tw-border-opacity))}.border-rose-300{--tw-border-opacity:1;border-color:rgb(253 164 175/var(--tw-border-opacity))}.border-slate-200{--tw-border-opacity:1;border-color:rgb(226 232 240/var(--tw-border-opacity))}.border-transparent{border-color:transparent}.border-white\/40{border-color:hsla(0,0%,100%,.4)}.bg-amber-50{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity))}.bg-amber-50\/70{background-color:rgba(255,251,235,.7)}.bg-black\/40{background-color:rgba(0,0,0,.4)}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity))}.bg-blue-900{--tw-bg-opacity:1;background-color:rgb(30 58 138/var(--tw-bg-opacity))}.bg-emerald-50{--tw-bg-opacity:1;background-color:rgb(236 253 245/var(--tw-bg-opacity))}.bg-emerald-600{--tw-bg-opacity:1;background-color:rgb(5 150 105/var(--tw-bg-opacity))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity))}.bg-rose-50{--tw-bg-opacity:1;background-color:rgb(255 241 242/var(--tw-bg-opacity))}.bg-slate-100{--tw-bg-opacity:1;background-color:rgb(241 245 249/var(--tw-bg-opacity))}.bg-slate-50{--tw-bg-opacity:1;background-color:rgb(248 250 252/var(--tw-bg-opacity))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity))}.bg-white\/80{background-color:hsla(0,0%,100%,.8)}.bg-white\/95{background-color:hsla(0,0%,100%,.95)}.p-0{padding:0}.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\.5{padding-top:.375rem;padding-bottom:.375rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.pb-4{padding-bottom:1rem}.pl-3{padding-left:.75rem}.pl-9{padding-left:2.25rem}.pr-6{padding-right:1.5rem}.pt-2{padding-top:.5rem}.pt-3{padding-top:.75rem}.pt-4{padding-top:1rem}.pt-6{padding-top:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.align-top{vertical-align:top}.align-middle{vertical-align:middle}.font-sans{font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-\[11px\]{font-size:11px}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.lowercase{text-transform:lowercase}.italic{font-style:italic}.ordinal{--tw-ordinal:ordinal;font-variant-numeric:var(--tw-ordinal) var(--tw-slashed-zero) var(--tw-numeric-figure) var(--tw-numeric-spacing) var(--tw-numeric-fraction)}.tracking-wide{letter-spacing:.025em}.text-amber-200{--tw-text-opacity:1;color:rgb(253 230 138/var(--tw-text-opacity))}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity))}.text-blue-100{--tw-text-opacity:1;color:rgb(219 234 254/var(--tw-text-opacity))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity))}.text-blue-800{--tw-text-opacity:1;color:rgb(30 64 175/var(--tw-text-opacity))}.text-blue-900{--tw-text-opacity:1;color:rgb(30 58 138/var(--tw-text-opacity))}.text-emerald-700{--tw-text-opacity:1;color:rgb(4 120 87/var(--tw-text-opacity))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61/var(--tw-text-opacity))}.text-indigo-600{--tw-text-opacity:1;color:rgb(79 70 229/var(--tw-text-opacity))}.text-indigo-700{--tw-text-opacity:1;color:rgb(67 56 202/var(--tw-text-opacity))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38/var(--tw-text-opacity))}.text-rose-600{--tw-text-opacity:1;color:rgb(225 29 72/var(--tw-text-opacity))}.text-rose-800{--tw-text-opacity:1;color:rgb(159 18 57/var(--tw-text-opacity))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity))}.underline{text-decoration-line:underline}.shadow{--tw-shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px -1px rgba(0,0,0,.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color),0 1px 2px -1px var(--tw-shadow-color)}.shadow,.shadow-lg{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.shadow-sm,.shadow-xl{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 8px 10px -6px rgba(0,0,0,.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color),0 8px 10px -6px var(--tw-shadow-color)}.ring-2{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.ring-indigo-400{--tw-ring-opacity:1;--tw-ring-color:rgb(129 140 248/var(--tw-ring-opacity))}.\!filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)!important}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-blur{--tw-backdrop-blur:blur(8px)}.backdrop-blur,.backdrop-blur-sm{backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.backdrop-blur-sm{--tw-backdrop-blur:blur(4px)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}table td,table th{font-size:.875rem;line-height:1.25rem}input[type=search]{width:20rem;border-radius:.25rem;border-width:1px;padding:.5rem .75rem}[x-cloak]{display:none!important}.odd\:bg-white:nth-child(odd){--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity))}.even\:bg-gray-50:nth-child(2n){--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity))}.hover\:border-indigo-300:hover{--tw-border-opacity:1;border-color:rgb(165 180 252/var(--tw-border-opacity))}.hover\:border-rose-300:hover{--tw-border-opacity:1;border-color:rgb(253 164 175/var(--tw-border-opacity))}.hover\:bg-blue-100:hover{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity))}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity))}.hover\:bg-emerald-100:hover{--tw-bg-opacity:1;background-color:rgb(209 250 229/var(--tw-bg-opacity))}.hover\:bg-emerald-700:hover{--tw-bg-opacity:1;background-color:rgb(4 120 87/var(--tw-bg-opacity))}.hover\:bg-gray-100:hover{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity))}.hover\:bg-indigo-50:hover{--tw-bg-opacity:1;background-color:rgb(238 242 255/var(--tw-bg-opacity))}.hover\:bg-rose-100:hover{--tw-bg-opacity:1;background-color:rgb(255 228 230/var(--tw-bg-opacity))}.hover\:bg-rose-50:hover{--tw-bg-opacity:1;background-color:rgb(255 241 242/var(--tw-bg-opacity))}.hover\:bg-white\/10:hover{background-color:hsla(0,0%,100%,.1)}.hover\:text-blue-700:hover{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity))}.hover\:text-blue-800:hover{--tw-text-opacity:1;color:rgb(30 64 175/var(--tw-text-opacity))}.hover\:text-gray-800:hover{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity))}.hover\:text-rose-800:hover{--tw-text-opacity:1;color:rgb(159 18 57/var(--tw-text-opacity))}.hover\:underline:hover{text-decoration-line:underline}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.focus\:ring-indigo-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(99 102 241/var(--tw-ring-opacity))}.focus\:ring-rose-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(244 63 94/var(--tw-ring-opacity))}.focus\:ring-offset-0:focus{--tw-ring-offset-width:0px}.disabled\:text-gray-300:disabled{--tw-text-opacity:1;color:rgb(209 213 219/var(--tw-text-opacity))}.disabled\:opacity-50:disabled{opacity:.5}.disabled\:opacity-60:disabled{opacity:.6}@media (min-width:640px){.sm\:mt-6{margin-top:1.5rem}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:768px){.md\:col-span-2{grid-column:span 2/span 2}.md\:block{display:block}.md\:flex{display:flex}.md\:hidden{display:none}.md\:w-\[360px\]{width:360px}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-\[repeat\(auto-fit\2c minmax\(180px\2c 1fr\)\)\]{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}.md\:flex-row{flex-direction:row}.md\:items-center{align-items:center}.md\:justify-between{justify-content:space-between}.md\:pt-8{padding-top:2rem}}@media (min-width:1280px){.xl\:block{display:block}.xl\:inline{display:inline}.xl\:flex{display:flex}.xl\:hidden{display:none}}</style>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <script id="rows-json" type="application/json">
    <?!= JSON.stringify(rowsData).replace(/<\//g, '<\\/') ?>
  </script>
  <script id="services-json" type="application/json">
    <?!= JSON.stringify((servicesData && servicesData.items) ? servicesData.items : []).replace(/<\//g, '<\\/') ?>
  </script>
  <script>
    const parseJsonFallback = (text, fallback) => {
      if (!text || /<\?!=/.test(text)) return fallback;
      try { return JSON.parse(text); } catch (_) { return fallback; }
    };

    const rowsEl = document.getElementById('rows-json');
    const servicesEl = document.getElementById('services-json');
    const existingRows = Array.isArray(window.__ROWS__) ? window.__ROWS__ : [];
    const existingServices = Array.isArray(window.__SERVICES__) ? window.__SERVICES__ : [];
    window.__ROWS__ = parseJsonFallback(rowsEl && rowsEl.textContent, existingRows);
    window.__SERVICES__ = parseJsonFallback(servicesEl && servicesEl.textContent, existingServices);

    const baseTemplate = `<?!= JSON.stringify(typeof baseUrl !== 'undefined' ? baseUrl : '') ?>`;
    const guestTemplate = `<?!= JSON.stringify(typeof guestMode !== 'undefined' ? !!guestMode : false) ?>`;
    const parseTemplateString = (raw, fallback) => {
      if (!raw || /<\?!=/.test(raw)) return fallback;
      try { return JSON.parse(raw); } catch (_) { return fallback; }
    };

    const baseFromServer = parseTemplateString(baseTemplate, '');
    const guestFromServer = parseTemplateString(guestTemplate, false);
    // Prefer server-provided Web App URL; fallback to current location
    window.__BASE__ = baseFromServer || (location.origin + location.pathname);
    // Guest mode injected by server (via ?mode=guest)
    window.__GUEST__ = guestFromServer;
  </script>
  <script>
    (function ensureRpcBase() {
      if (window.__BASE__ && window.__BASE__ !== (location.origin + location.pathname)) return;
      if (window.APP_RPC_BASE) {
        window.__BASE__ = window.APP_RPC_BASE;
        return;
      }
      try {
        const meta = document.querySelector('meta[name="app-script-base"]');
        if (meta && meta.content) window.__BASE__ = meta.content;
      } catch (_) {}
    })();
  </script>
  <script>
  function callRpc(method, payload) {
    return new Promise((resolve, reject) => {
      const runner = (window.google && google.script && google.script.run) || null;
      if (runner && runner.rpc) {
        runner
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .rpc({ method, payload });
        return;
      }

      const base = String(window.__BASE__ || '').replace(/\/+$/, '');
      if (!base) {
        reject(new Error('RPC endpoint is not configured.'));
        return;
      }

      const headers = Object.assign(
        { 'Content-Type': 'text/plain;charset=utf-8' },
        window.__RPC_HEADERS__ && typeof window.__RPC_HEADERS__ === 'object'
          ? window.__RPC_HEADERS__
          : {}
      );

      fetch(`${base}/exec`, {
        method: 'POST',
        mode: 'cors',
        credentials: 'omit',
        headers,
        body: JSON.stringify({ method, payload })
      })
        .then(async (res) => {
          let data = null;
          try { data = await res.json(); }
          catch (_) { throw new Error('Invalid RPC response'); }

          if (data && typeof data === 'object' && 'ok' in data) {
            if (data.ok) return data.data;
            throw new Error(data.error || 'RPC request failed');
          }
          return data;
        })
        .then(resolve)
        .catch((err) => reject(err));
    });
  }

  // Minimal toast-style notifier for consistent UX (client-only)
  function notify(message, type = 'info', ms = 2200) {
    try {
      const root = document.createElement('div');
      root.textContent = String(message ?? '');
      root.style.position = 'fixed';
      root.style.right = '12px';
      root.style.bottom = '12px';
      root.style.zIndex = '9999';
      root.style.maxWidth = '70vw';
      root.style.padding = '8px 12px';
      root.style.borderRadius = '6px';
      root.style.color = '#111827';
      root.style.background = type === 'error' ? '#fecaca' : type === 'success' ? '#bbf7d0' : '#e5e7eb';
      root.style.boxShadow = '0 4px 14px rgba(0,0,0,0.2)';
      document.body.appendChild(root);
      setTimeout(() => root.remove(), ms);
    } catch (_) {
      try { alert(String(message ?? '')); } catch(_) {}
    }
  }
</script>

  <script>
  // Client-only context: central place for UI constants and defaults
  window.APP_CTX = {
    defaults: {
      leader: 'Darden',
      preacher: 'Tom',
      serviceType: 'Worship',
      time: '10:00 AM'
    },
    leaderChoices: ['Darden','Belinda','Lois'],
    sermonChoices: ['Tom','Darden','Miguel','Alfredo'],
    preacherChoices: ['Tom','Darden','Miguel','Alfredo'],
    orderItemTypes: [
      'Pre-Service','Welcome','Opening Song','Call to Worship','Song 1','Prayer of Invocation','Song 2','2nd Scripture','Song 3','Prayer of Illumination','Announcements','Children\'s Chat','Sermon','Communion','Communion Song','Closing Song','Benediction','Post Services','Note','Song 4','Offering','Offering Song'
    ],
    usageFilterChoices: ['Call to Worship','Song2','Song3'],
    orderTemplates: {
      communion: [
        { itemType: 'Pre-Service' },
        { itemType: 'Welcome', leader: '{leader}' },
        { itemType: 'Opening Song' },
        { itemType: 'Call to Worship' },
        { itemType: 'Song 1' },
        { itemType: 'Prayer of Invocation' },
        { itemType: 'Song 2' },
        { itemType: '2nd Scripture' },
        { itemType: 'Song 3' },
        { itemType: 'Prayer of Illumination' },
        { itemType: 'Announcements' },
        { itemType: 'Children\'s Chat' },
        { itemType: 'Sermon', leader: '{preacher}' },
        { itemType: 'Communion', leader: '{preacher}' },
        { itemType: 'Communion Song' },
        { itemType: 'Closing Song' },
        { itemType: 'Benediction', leader: '{preacher}' },
        { itemType: 'Post Services' }
      ],
      offering: [
        { itemType: 'Pre-Service' },
        { itemType: 'Welcome', leader: '{leader}' },
        { itemType: 'Opening Song' },
        { itemType: 'Call to Worship' },
        { itemType: 'Song 1' },
        { itemType: 'Prayer of Invocation' },
        { itemType: 'Song 2' },
        { itemType: '2nd Scripture' },
        { itemType: 'Song 3' },
        { itemType: 'Note' },
        { itemType: 'Song 4' },
        { itemType: 'Prayer of Illumination' },
        { itemType: 'Announcements' },
        { itemType: 'Children\'s Chat' },
        { itemType: 'Sermon', leader: '{preacher}' },
        { itemType: 'Offering' },
        { itemType: 'Offering Song' },
        { itemType: 'Closing Song' },
        { itemType: 'Benediction', leader: '{preacher}' },
        { itemType: 'Post Services' }
      ]
    },
    bibleBooks: [
      ['Genesis',50],['Exodus',40],['Leviticus',27],['Numbers',36],['Deuteronomy',34],
      ['Joshua',24],['Judges',21],['Ruth',4],['1 Samuel',31],['2 Samuel',24],
      ['1 Kings',22],['2 Kings',25],['1 Chronicles',29],['2 Chronicles',36],['Ezra',10],
      ['Nehemiah',13],['Esther',10],['Job',42],['Psalms',150],['Proverbs',31],
      ['Ecclesiastes',12],['Song of Solomon',8],['Isaiah',66],['Jeremiah',52],['Lamentations',5],
      ['Ezekiel',48],['Daniel',12],['Hosea',14],['Joel',3],['Amos',9],['Obadiah',1],
      ['Jonah',4],['Micah',7],['Nahum',3],['Habakkuk',3],['Zephaniah',3],['Haggai',2],
      ['Zechariah',14],['Malachi',4],
      ['Matthew',28],['Mark',16],['Luke',24],['John',21],['Acts',28],
      ['Romans',16],['1 Corinthians',16],['2 Corinthians',13],['Galatians',6],['Ephesians',6],
      ['Philippians',4],['Colossians',4],['1 Thessalonians',5],['2 Thessalonians',3],['1 Timothy',6],
      ['2 Timothy',4],['Titus',3],['Philemon',1],['Hebrews',13],['James',5],
      ['1 Peter',5],['2 Peter',3],['1 John',5],['2 John',1],['3 John',1],['Jude',1],['Revelation',22]
    ]
  };
</script>

  <script>
  function songsApp(mode = 'default') {
    const IS_GUEST = !!(window.__GUEST__);
    const normalizedMode = String(mode || '').toLowerCase();
    const isModal = normalizedMode === 'modal';
    const audioExts = new Set(['mp3','m4a','wav','aac','flac','ogg','wma','aiff','mid','midi']);
    const docRules = [
      { label: 'Guitar', patterns: [/gdoc\b/i, /\bguitar\b/i, /(^|[\s_-])g($|[\s_-])/i] },
      { label: 'Lyrics', patterns: [/wdoc\b/i, /\blyrics?\b/i, /(^|[\s_-])w($|[\s_-])/i] },
      { label: 'Bass', patterns: [/bdoc\b/i, /\bbass\b/i, /(^|[\s_-])b($|[\s_-])/i] }
    ];

    const splitSeasons = (val) => String(val ?? '').split(/[\/ ,;|]/g).map(s => s.trim()).filter(Boolean);
    const norm = (s) => String(s || '').toLowerCase();
    const title = (s) => String(s || '').replace(/\w\S*/g, w => w[0].toUpperCase() + w.slice(1).toLowerCase());
    const usageKey = (s) => String(s || '').toLowerCase().replace(/[^a-z0-9]+/g, '');
    const truthyFlag = (val) => /^y(es)?|true|1$/i.test(String(val ?? '').trim());
    const isFlagOn = (value) => {
      const normalized = String(value ?? '').trim().toLowerCase();
      return normalized === 'y' || normalized === 'yes' || normalized === 'true' || normalized === '1';
    };

    const makeSongForm = (row = {}) => ({
      Song: String(row?.Song || ''),
      Leader: String(row?.Leader || ''),
      Season: String(row?.Season || ''),
      Usage: String(row?.Usage || ''),
      Themes: String(row?.Themes || ''),
      Keywords: String(row?.Keywords || ''),
      Scriptures: String(row?.Scriptures || ''),
      Notes: String(row?.Notes || ''),
      Lyrics: String(row?.Lyrics || row?.['Lyrics (PD)'] || ''),
      Link: String(row?.Link || row?.link || ''),
      Sp: isFlagOn(row?.Sp ?? row?.sp ?? row?.Spanish ?? ''),
      Archive: isFlagOn(row?.Archive ?? row?.archive ?? row?.ARCHIVE ?? row?.Archived ?? '')
    });

    return {
      isGuest: IS_GUEST,
      isModalContext: isModal,
      mobileListOpen: false,
      filtersOpen: false,
      rows: window.__ROWS__ || [],
      filtered: [],
      selected: null,
      tableHeaders: ['Song','Last_Used'],

      seasons: [],
      selectedSeason: '',
      leaderOptions: [],
      selectedLeader: '',
      usageOptions: [],
      selectedUsage: '',

      opts: { allowChristmas: true },

      q: '',
      searchLyrics: true,
      spanishOnly: false,
      showArchived: false,
      sortKey: 'Last_Used',
      sortDir: 1,

      loading: false,
      error: '',

      mediaFiles: [],
      mediaLoading: false,
      mediaMessage: '',

      _defaultsTs: 0,
      showSongEditor: false,
      songEditorMode: 'create',
      songEditorError: '',
      songEditorSaving: false,
      songForm: makeSongForm(),
      editorOriginalName: '',

      async init() {
        if (!Array.isArray(this.rows) || !this.rows.length) {
          this.loading = true;
          try {
            const r = await callRpc('getSongsForView', null);
            if (Array.isArray(r)) this.rows = r;
          } catch (e) {
            this.error = this.isGuest ? '' : 'Failed to load songs';
          } finally {
            this.loading = false;
          }
        }

        this.buildFilters();
        if (typeof window !== 'undefined' && window.innerWidth < 768) {
          this.mobileListOpen = true;
        }

        this.$watch('q', () => this.render(true));
        this.$watch('selectedSeason', () => this.render(true));
        this.$watch('selectedLeader', () => this.render(true));
        this.$watch('searchLyrics', () => this.render(true));
        this.$watch('spanishOnly', () => this.render(true));
        this.$watch('showArchived', () => this.render(true));
        this.$watch('selectedUsage', () => this.render(true));
        this.render(true);

        this.syncDefaults(true);
        try {
          this.$watch(
            () => {
              try {
                return window.Alpine && typeof window.Alpine.store === 'function'
                  ? (window.Alpine.store('suggestDefaults')?.updatedAt || 0)
                  : 0;
              } catch (_) {
                return 0;
              }
            },
            () => this.syncDefaults()
          );
        } catch (_) {}
      },

      buildFilters() {
        const bucket = new Map();
        for (const r of (this.rows || [])) {
          for (const tok of splitSeasons(r['Season'])) {
            const k = norm(tok); if (k) bucket.set(k, title(tok));
          }
        }
        if ((this.rows || []).some(r => !String(r['Season'] || '').trim())) bucket.set('__uncat__', 'Uncategorized');
        this.seasons = Array.from(bucket.entries()).sort((a,b)=>a[1].localeCompare(b[1])).map(([key,label])=>({key,label}));

        const leaderSet = new Set();
        for (const r of (this.rows || [])) {
          const L = Array.isArray(r._leaders) ? r._leaders : [];
          for (const name of L) leaderSet.add(name);
        }
        this.leaderOptions = Array.from(leaderSet).sort((a,b)=>a.localeCompare(b));

        const ctx = (window.APP_CTX || {});
        const preferred = Array.isArray(ctx.usageFilterChoices) ? ctx.usageFilterChoices : [];
        const seen = new Map();
        const add = (label) => {
          const k = usageKey(label);
          if (k && !seen.has(k)) seen.set(k, label);
        };
        for (const lab of preferred) add(lab);
        for (const r of (this.rows || [])) {
          const parts = String(r['Usage'] ?? '')
            .split(',')
            .map(s => s.trim())
            .filter(Boolean);
          for (const p of parts) add(p);
        }
        this.usageOptions = Array.from(seen.values());
      },

      async select(row) {
        this.selected = row;
        this.mediaFiles = [];
        this.mediaMessage = '';
        if (!row) return;
        const url = String((row && row._folderUrl) || '').trim();
        if (!url) {
          this.mediaMessage = 'No folder link available.';
          return;
        }
        await this.loadMediaForUrl(url);
        if (!this.isModalContext) {
          this.mobileListOpen = false;
        }
      },

      async loadMediaForUrl(url) {
        if (!url) {
          this.mediaFiles = [];
          this.mediaMessage = 'No folder link available.';
          return;
        }
        this.mediaLoading = true;
        try {
          const files = await callRpc('getFilesForFolderUrl', url);
          this.mediaFiles = Array.isArray(files) ? files : [];
          this.mediaMessage = this.mediaFiles.length ? '' : 'No files in folder.';
        } catch (e) {
          console.error(e);
          this.mediaFiles = [];
          this.mediaMessage = (e && e.message) ? e.message : 'Failed to load files.';
        } finally {
          this.mediaLoading = false;
        }
      },

      sort(h) {
        this.sortKey === h ? this.sortDir *= -1 : (this.sortKey = h, this.sortDir = 1);
        this.render(true);
      },

      headerLabel(key) {
        return key === 'Last_Used' ? 'Last Used' : key;
      },

      headerIcon(key) {
        if (this.sortKey !== key) return '&#8597;';
        return this.sortDir === 1 ? '&#9650;' : '&#9660;';
      },

      isSpanish(row) {
        if (!row || typeof row !== 'object') return false;
        const raw = row.Sp ?? row.sp ?? row['SP'] ?? row['Spanish'] ?? '';
        const val = String(raw || '').trim().toLowerCase();
        if (!val) return false;
        return val === 'y' || val === 'yes' || val === 'spanish' || val === 'true' || val === '1';
      },

      isArchived(row) {
        if (!row || typeof row !== 'object') return false;
        const raw = row.Archive ?? row.archive ?? row['ARCHIVE'] ?? row.Archived ?? row.archived ?? '';
        const val = String(raw || '').trim().toLowerCase();
        if (!val) return false;
        return val === 'y' || val === 'yes' || val === 'true' || val === '1';
      },

      render(resetSelection = false) {
        const wantLeader = (this.selectedLeader || '').trim();
        const wantUsage = (this.selectedUsage || '').trim();
        const q = (this.q || '').toLowerCase().trim();
        const tokens = q ? q.split(/[,\s]+/).map(t => t.trim()).filter(Boolean) : [];
        const want = this.selectedSeason;
        const baseFields = ['Song','Themes','Season','Keywords','Scriptures','Notes'];
        const fields = this.searchLyrics ? [...baseFields, 'Lyrics','Lyrics (PD)'] : baseFields;

        let out = (this.rows || []).filter(r => {
          if (want) {
            const toks = splitSeasons(r['Season']).map(norm);
            const ok = want === '__uncat__' ? toks.length === 0 : toks.includes(want);
            if (!ok) return false;
          }
          if (this.opts && this.opts.allowChristmas === false) {
            const seasonText = String(r['Season'] || '').toLowerCase();
            if (/(christ|advent)/.test(seasonText)) return false;
          }
          if (wantLeader) {
            const L = Array.isArray(r._leaders) ? r._leaders : [];
            if (!L.includes(wantLeader)) return false;
          }
          if (this.spanishOnly && !this.isSpanish(r)) return false;
          if (!this.showArchived && this.isArchived(r)) return false;
          if (wantUsage) {
            const want = usageKey(wantUsage);
            const toks = String(r['Usage'] ?? '')
              .split(',')
              .map(t => usageKey(t))
              .filter(Boolean);
            if (!toks.includes(want)) return false;
          }
          if (!tokens.length) return true;
          for (const f of fields) {
            const v = r[f];
            if (v != null) {
              const val = String(v).toLowerCase();
              for (const tok of tokens) {
                if (val.includes(tok)) return true;
              }
            }
          }
          return false;
        });

        if (this.sortKey) {
          const k = this.sortKey, d = this.sortDir;
          const toTime = (v) => {
            if (v instanceof Date) return v.getTime();
            const s = String(v || '').trim();
            const d1 = new Date(s);
            return isNaN(d1.getTime()) ? Number.POSITIVE_INFINITY : d1.getTime();
          };
          out = out.slice().sort((a,b) => {
            if (k === 'Last_Used') {
              const at = toTime(a[k]);
              const bt = toTime(b[k]);
              return (at - bt) * d;
            }
            const av = (a[k] ?? '').toString().toLowerCase();
            const bv = (b[k] ?? '').toString().toLowerCase();
            return av < bv ? -1 * d : av > bv ? 1 * d : 0;
          });
        }

        this.filtered = out;
        if (resetSelection || !this.selected || !out.includes(this.selected)) this.selected = out[0] || null;
      },

      format(v) {
        if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(v)) {
          const d = new Date(v);
          return d.toLocaleDateString();
        }
        return v ?? '';
      },

      friendlyMediaName(file) {
        const raw = String(file?.name || '').trim();
        if (!raw) return 'File';
        const withoutSong = this.stripSongTitle(raw);
        const base = this.removeExtension(withoutSong);
        const trimmed = this.trimDelimiters(base);
        if (!trimmed) return raw;
        if (this.isAudioFile(file)) return this.audioLabelFrom(trimmed);
        const doc = this.docLabelFrom(trimmed);
        if (doc) return doc;
        return this.normalizeResidual(trimmed) || raw;
      },

      stripSongTitle(name) {
        const song = String(this.selected?.Song || '').trim();
        if (!song) return name;
        const escaped = song.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const rx = new RegExp(`^${escaped}[\\s._-]*`, 'i');
        return name.replace(rx, '');
      },

      removeExtension(name) {
        return name.replace(/\.[^.]+$/, '');
      },

      trimDelimiters(str) {
        return String(str || '').replace(/^[\s._-]+/, '').replace(/[\s._-]+$/, '');
      },

      normalizeResidual(str) {
        let out = String(str || '');
        out = out.replace(/[_]+/g, ' ');
        out = out.replace(/\s{2,}/g, ' ');
        out = out.replace(/\s*\(/g, ' (').replace(/\s*\)/g, ')');
        return out.trim();
      },

      docLabelFrom(str) {
        for (const rule of docRules) {
          for (const rx of rule.patterns) {
            if (rx.test(str)) {
              const detail = this.normalizeResidual(str.replace(rx, ' '));
              return detail ? `${rule.label} ${detail}` : rule.label;
            }
          }
        }
        return '';
      },

      isAudioFile(file) {
        const mime = String(file?.mimeType || '').toLowerCase();
        if (mime.startsWith('audio/')) return true;
        const name = String(file?.name || '');
        const ext = (name.split('.').pop() || '').toLowerCase();
        return audioExts.has(ext);
      },

      audioLabelFrom(str) {
        const parts = this.extractAudioParts(str);
        if (parts.date && parts.detail) return `${parts.date} - ${parts.detail}`;
        if (parts.date) return parts.date;
        return parts.detail || 'Audio';
      },

      extractAudioParts(str) {
        let working = String(str || '');
        let date = '';
        const paren = /\(([^)]+)\)\s*$/.exec(working);
        if (paren) {
          date = paren[1].trim();
          working = `${working.slice(0, paren.index)}${working.slice(paren.index + paren[0].length)}`;
        }
        if (!date) {
          const compact = /(\d{1,2}[A-Za-z]{3}\d{2,4})/.exec(working);
          if (compact) {
            date = compact[1];
            working = working.replace(compact[0], ' ');
          }
        }
        if (!date) {
          const monthYear = /([A-Za-z]{3,9}\s?\d{2,4})/.exec(working);
          if (monthYear) {
            date = monthYear[1].trim();
            working = working.replace(monthYear[0], ' ');
          }
        }
        const detail = this.normalizeResidual(working);
        return { date: date.trim(), detail };
      },

      async copy(text) { try { await navigator.clipboard.writeText(String(text ?? '')); } catch { } },

      applySuggestion(index, payload) {
        try {
          const name = (payload && payload.name) ? String(payload.name) : String(this.selected?.Song || '');
          const ev = new CustomEvent('use-song', { detail: { index, name }, bubbles: true });
          this.$el.dispatchEvent(ev);
        } catch (_) { }
      },

      fileIcon(mimeType) {
        const type = String(mimeType || '').toLowerCase();
        if (!type) return '\uD83D\uDCC4'; // page facing up
        if (type.startsWith('audio/')) return '\uD83C\uDFB5'; // musical note
        if (type.startsWith('video/')) return '\uD83C\uDFA5'; // movie camera
        if (type.includes('pdf')) return '\uD83D\uDCC4';
        if (type.includes('presentation')) return '\uD83D\uDCCB'; // clipboard
        if (type.includes('spreadsheet') || type.includes('excel')) return '\uD83D\uDCC8'; // chart with upwards trend
        if (type.includes('word') || type.includes('document')) return '\uD83D\uDCC3'; // page with curl
        return '\uD83D\uDCC4';
      },

      searchTokens() {
        return Array.from(
          new Set(
            String(this.q || '')
              .split(/[,\s]+/)
              .map(t => t.trim())
              .filter(Boolean)
              .map(t => t.toLowerCase())
          )
        );
      },

      escapeHtml(str) {
        return String(str || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      },

      highlightedLyrics() {
        const base = this.selected?.Lyrics || this.selected?.['Lyrics (PD)'] || '';
        if (!base) return this.escapeHtml('(No lyrics)');
        const tokens = this.searchTokens();
        let html = this.escapeHtml(base);
        if (tokens.length) {
          const parts = tokens
            .map(tok => tok.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'))
            .filter(Boolean);
          if (parts.length) {
            const rx = new RegExp(`(${parts.join('|')})`, 'gi');
            html = html.replace(rx, '<mark>$1</mark>');
          }
        }
        return html;
      },

      findSongByName(name) {
        const needle = String(name || '').trim().toLowerCase();
        if (!needle) return null;
        return (this.rows || []).find(r => String(r?.Song || '').trim().toLowerCase() === needle) || null;
      },

      openSongEditor(mode = 'create') {
        console.log(mode);
        if (this.isGuest) {
          this.error = 'View only mode. Sign in to edit songs.';
          return;
        }
        const nextMode = mode === 'edit' ? 'edit' : 'create';
        if (nextMode === 'edit' && !this.selected) {
          this.error = 'Select a song to edit first.';
          return;
        }
        this.songEditorMode = nextMode;
        this.songEditorError = '';
        this.songForm = nextMode === 'edit' ? makeSongForm(this.selected || {}) : makeSongForm();
        this.editorOriginalName = nextMode === 'edit' ? String(this.selected?.Song || '') : '';
        this.showSongEditor = true;
        this.$nextTick(() => {
          try { this.$refs?.songTitle?.focus(); } catch (_) {}
        });
      },

      cancelSongEditor() {
        if (this.songEditorSaving) return;
        this.showSongEditor = false;
        this.songEditorError = '';
      },

      buildSongPayload() {
        const form = this.songForm || {};
        return {
          Song: String(form.Song || '').trim(),
          Leader: String(form.Leader || '').trim(),
          Season: String(form.Season || '').trim(),
          Usage: String(form.Usage || '').trim(),
          Themes: String(form.Themes || '').trim(),
          Keywords: String(form.Keywords || '').trim(),
          Scriptures: String(form.Scriptures || '').trim(),
          Notes: String(form.Notes || '').trim(),
          Lyrics: String(form.Lyrics || ''),
          Link: String(form.Link || '').trim(),
          Sp: form.Sp ? 'Y' : '',
          Archive: form.Archive ? 'Y' : ''
        };
      },

      async saveSongEditor() {
        if (this.isGuest) {
          this.songEditorError = 'View only mode. Sign in to edit songs.';
          return;
        }
        if (this.songEditorSaving) return;
        const payload = this.buildSongPayload();
        if (!payload.Song) {
          this.songEditorError = 'Song title is required.';
          return;
        }
        this.songEditorSaving = true;
        this.songEditorError = '';
        try {
          const res = await callRpc('saveSongEntry', {
            originalName: this.songEditorMode === 'edit' ? this.editorOriginalName : '',
            data: payload
          });
          if (Array.isArray(res?.items)) {
            this.rows = res.items;
            this.buildFilters();
            this.render(true);
            const match = this.findSongByName(payload.Song);
            if (match) await this.select(match);
          }
          this.showSongEditor = false;
        } catch (e) {
          console.error(e);
          this.songEditorError = (e && e.message) ? e.message : 'Unable to save song.';
        } finally {
          this.songEditorSaving = false;
        }
      },

      applyDefaults(payload = {}) {
        const data = (payload && typeof payload === 'object') ? payload : {};
        const has = (k) => Object.prototype.hasOwnProperty.call(data, k);
        const normalize = (v) => typeof v === 'string' ? v : '';
        const ensureOption = (list, value) => {
          if (!value) return Array.isArray(list) ? list : [];
          const arr = Array.isArray(list) ? list.slice() : [];
          if (!arr.includes(value)) arr.unshift(value);
          return arr;
        };

        let shouldRender = false;

        if (has('allowChristmas')) {
          const flag = !!data.allowChristmas;
          if (!this.opts || this.opts.allowChristmas !== flag) {
            this.opts = Object.assign({}, this.opts || {}, { allowChristmas: flag });
            shouldRender = true;
          }
        } else if (data.options && typeof data.options === 'object') {
          this.opts = Object.assign({}, this.opts || {}, data.options);
          shouldRender = true;
        }

        if (has('seed')) {
          const next = normalize(data.seed);
          if (this.q !== next) this.q = next;
        }

        if (has('leader')) {
          const leader = normalize(data.leader);
          this.leaderOptions = ensureOption(this.leaderOptions, leader);
          if (this.selectedLeader !== leader) this.selectedLeader = leader;
        }

        if (has('usage')) {
          const usage = normalize(data.usage);
          this.usageOptions = ensureOption(this.usageOptions, usage);
          if (this.selectedUsage !== usage) this.selectedUsage = usage;
        }

        if (shouldRender) this.render(true);
      },

      syncDefaults(force = false) {
        try {
          if (!window.Alpine || typeof window.Alpine.store !== 'function') return;
          const store = window.Alpine.store('suggestDefaults');
          if (!store) return;
          const ts = Number(store.updatedAt || 0);
          if (!force && ts === this._defaultsTs) return;
          this._defaultsTs = ts;
          this.applyDefaults({
            seed: store.seed ?? '',
            leader: store.leader ?? '',
            usage: store.usage ?? '',
            allowChristmas: store.allowChristmas
          });
        } catch (_) {}
      }
    }
  }
</script>

  <script>
  const TEAM_ROLE_PRESETS = {
    Worship: ['Leader', 'Guitar', 'Bass', 'Other', 'Keyboard', 'Drums', 'Vocal', 'Projection', 'Sound', 'Communion', 'Offering'],
    Kids: ['Preschool Teacher', 'Toddler Teacher', 'Preschool Helper', 'Toddler Helper', 'Kids Teacher', 'Kids Helper'],
    Hospitality: ['Greeter', 'Security']
  };
  const TEAM_TYPE_PRIORITY = ['Worship'];
  const WEEKLY_COLUMN_LABELS = ['1st Sunday', '2nd Sunday', '3rd Sunday', '4th Sunday', '5th Sunday'];

  function teamApp() {
    return {
      activeTab: 'schedule',
      loading: true,
      error: '',
      roles: [],
      teamOptions: [],
      permissionsOptions: ['subscriber', 'editor', 'administrator'],
      search: '',
      teamFilter: '',
      selectedEmail: '',
      editTeam: '',
      rolePresets: TEAM_ROLE_PRESETS,
      roleSelections: {},
      teamSelections: {},
      editPermissions: '',
      spanishChecked: false,
      saving: false,
      savedAt: 0,
      presetLookup: {},
      showNewMemberModal: false,
      newMemberSaving: false,
      newMemberError: '',
      newMember: {
        email: '',
        first: '',
        last: '',
        permissions: 'subscriber'
      },
      weeklyTeamsLoading: false,
      weeklyTeamsError: '',
      weeklyTeams: [],
      weeklyTeamFilter: '',
      selectedWeeklyTeamId: '',
      weeklyTeamDraft: {
        team: '',
        teamName: '',
        description: ''
      },
      weeklyTeamRolesDraft: [],
      weeklyTeamRoleIdCounter: 0,
      weeklyTeamShowAllRoles: false,
      weeklyTeamSaving: false,
      weeklyTeamSaveError: '',
      weeklyTeamSavedAt: 0,
      weeklyTeamBaseline: null,
      showNewWeeklyTeamModal: false,
      newWeeklyTeamSaving: false,
      newWeeklyTeamError: '',
      newWeeklyTeam: {
        team: '',
        teamName: '',
        description: ''
      },
        memberLookup: {},
        weeklyTeamDefaults: {},
        weeklyTeamLayouts: [],
      weeklyTeamDirtyFlags: {},
      teamDirtyVersions: {},
      teamSaveTimers: {},
      savingTeams: {},
        weeklyTeamsSaving: false,
        weeklyTeamsSaveError: '',
        weeklyTeamsSaveMessage: '',
        weeklyTeamEditorOpen: false,
        showRoleDefaultsModal: false,
        roleDefaultsTeamType: '',
        roleDefaultsDraft: [],
        roleDefaultsSaving: false,
        roleDefaultsError: '',
        scheduleLoading: false,
        scheduleError: '',
        scheduleServices: [],
        scheduleServiceLookup: {},
        scheduleUnavailableMap: {},
        scheduleAssignmentBaseline: {},
        scheduleAssignmentMap: {},
        scheduleTemplateOverrides: {},
        scheduleLayouts: [],
        scheduleDirtyKeys: {},
        scheduleDirty: false,
        scheduleSaving: false,
        scheduleSaveMessage: '',
        scheduleSaveError: '',
        scheduleServiceLimit: 6,

      init() {
        this.computePresetLookup();
        this.resetNewWeeklyTeamForm();
        this.refresh();
      },

      computePresetLookup() {
        const map = {};
        Object.values(this.rolePresets).forEach(list => {
          list.forEach(role => {
            map[this.normalize(role)] = role;
          });
        });
        this.presetLookup = map;
      },

      normalize(value) {
        return String(value || '').trim().toLowerCase();
      },

      canonicalRoleKey(value) {
        let base = this.normalize(value);
        if (!base) return '';
        base = base.replace(/\s*(\d+)$/, '').trim();
        base = base.replace(/\s+(sp|special)$/i, '').trim();
        return base;
      },

      splitList(value) {
        return String(value || '')
          .split(/[,;|]/)
          .map(s => s.trim())
          .filter(Boolean);
      },

      normalizeList(value) {
        const arr = this.splitList(value);
        arr.sort((a, b) => a.localeCompare(b));
        return arr.join('||');
      },

      teamKey(value) {
        return this.normalize(value);
      },

      teamList() {
        const lookup = new Map();
        const add = (value) => {
          const key = this.teamKey(value);
          if (!key) return;
          if (!lookup.has(key)) {
            lookup.set(key, String(value || '').trim());
          }
        };
        (Array.isArray(this.teamOptions) ? this.teamOptions : []).forEach(add);
        Object.keys(this.rolePresets || {}).forEach(add);
        (Array.isArray(this.roles) ? this.roles : []).forEach(row => {
          this.splitList(row?.teamRaw || '').forEach(add);
        });
        return Array.from(lookup.values()).sort((a, b) => a.localeCompare(b));
      },

      buildRoleString() {
        const pick = [];
        Object.entries(this.roleSelections || {}).forEach(([role, checked]) => {
          if (checked) pick.push(role);
        });
        
        const map = new Map();
        [...pick].forEach(role => {
          if (!role) return;
          map.set(role.toLowerCase(), role.trim());
        });
        const result = Array.from(map.values()).sort((a, b) => a.localeCompare(b));
        return result.join(', ');
      },

      buildTeamString() {
        return this.selectedTeams().join(', ');
      },

      get selected() {
        return this.roles.find(r => r.email === this.selectedEmail) || null;
      },

      get dirty() {
        const sel = this.selected;
        if (!sel) return false;
        const rolesChanged = this.normalizeList(sel.role || '') !== this.normalizeList(this.buildRoleString());
        const teamsChanged = this.normalizeList(sel.teamRaw || '') !== this.normalizeList(this.buildTeamString());
        const permsChanged = (sel.permissions || '').trim() !== this.editPermissions.trim();
        const spanishChanged = (String(sel.spanish || '').trim().toUpperCase() === 'Y') !== this.spanishChecked;
        return rolesChanged || teamsChanged || permsChanged || spanishChanged;
      },

      filteredRoles() {
        const q = this.search.trim().toLowerCase();
        const team = this.teamFilter.trim().toLowerCase();
        return this.roles.filter(r => {
          const matchesTeam = !team || r.teams.some(t => t.toLowerCase() === team);
          if (!matchesTeam) return false;
          if (!q) return true;
          const haystack = [
            r.first,
            r.last,
            r.email,
            r.role,
            r.teamRaw,
            r.permissions
          ]
            .join(' ')
            .toLowerCase();
          return haystack.includes(q);
        });
      },

      async refresh() {
        await this.loadRoles();
        await this.loadWeeklyTeams();
        await this.loadSchedule();
      },

      ensurePermissionOption(value) {
        const val = String(value || '').trim();
        if (!val) return;
        const exists = this.permissionsOptions.some(opt => opt.toLowerCase() === val.toLowerCase());
        if (!exists) {
          this.permissionsOptions = [...this.permissionsOptions, val].sort((a, b) => a.localeCompare(b));
        }
      },

      async loadRoles() {
        this.loading = true;
        this.error = '';
        try {
          const res = await callRpc('listRoles', null);
          this.roles = Array.isArray(res?.items) ? res.items : [];
          this.teamOptions = Array.isArray(res?.teams) ? res.teams : [];
          this.memberLookup = this.buildMemberLookup(this.roles);

          const permMap = new Map();
          ['subscriber', 'editor', 'administrator'].forEach(p => permMap.set(p.toLowerCase(), p));
          this.roles.forEach(r => {
            const val = String(r.permissions || '').trim();
            if (val) permMap.set(val.toLowerCase(), val);
          });
          this.permissionsOptions = Array.from(permMap.values()).sort((a, b) => a.localeCompare(b));

          if (this.selectedEmail) {
            this.select(this.selectedEmail);
          }
        } catch (e) {
          console.error(e);
          this.error = (e && e.message) ? e.message : 'Failed to load team.';
        } finally {
          this.loading = false;
        }
      },

      buildMemberLookup(rows) {
        const map = {};
        (Array.isArray(rows) ? rows : []).forEach(row => {
          const email = String(row?.email || '').trim();
          if (!email) return;
          const first = String(row?.first || '').trim();
          const last = String(row?.last || '').trim();
          const label = [first, last].filter(Boolean).join(' ') || email;
          const roles = this.parseRoleList(row?.role);
          map[email.toLowerCase()] = {
            email,
            first,
            last,
            label: `${label} (${email})`.trim(),
            shortLabel: first || label.split(' ')[0] || email,
            roles,
            rolesNormalized: roles.map(r => this.normalize(r)),
            roleCanonicalKeys: roles.map(r => this.canonicalRoleKey(r)).filter(Boolean)
          };
        });
        return map;
      },

      async loadWeeklyTeams() {
        this.weeklyTeamsLoading = true;
        this.weeklyTeamsError = '';
        try {
          const res = await callRpc('listWeeklyTeams', null);
          const items = Array.isArray(res?.items) ? res.items : [];
          this.weeklyTeamDefaults = this.normalizeWeeklyTeamDefaults(res?.defaults);
          this.weeklyTeams = items.map(item => this.normalizeWeeklyTeam(item));
          if (this.selectedWeeklyTeamId) {
            this.selectWeeklyTeam(this.selectedWeeklyTeamId);
          }
          await this.ensureDefaultWeeklyTeams();
          this.weeklyTeamDirtyFlags = {};
          this.weeklyTeamsSaveError = '';
          if (!this.weeklyTeamsSaving) {
            this.weeklyTeamsSaveMessage = '';
          }
          this.rebuildWeeklyTeamLayouts();
        } catch (e) {
          console.error(e);
          this.weeklyTeamsError = (e && e.message) ? e.message : 'Weekly teams are not available yet.';
        } finally {
          this.weeklyTeamsLoading = false;
        }
      },

      async loadSchedule() {
        this.scheduleLoading = true;
        this.scheduleError = '';
        try {
          const payload = { limit: this.scheduleServiceLimit };
          const res = await callRpc('getTeamScheduleSnapshot', payload);
          const services = this.normalizeScheduleServices(res?.services);
          this.scheduleServices = services;
          this.buildScheduleServiceLookup(services);
          this.scheduleUnavailableMap = this.normalizeScheduleUnavailable(res?.unavailable);
          this.scheduleTemplateOverrides = this.buildScheduleTemplateOverrides(res?.assignments);
          const baseline = this.normalizeScheduleAssignments(res?.assignments);
          this.scheduleAssignmentBaseline = baseline;
          this.scheduleAssignmentMap = { ...baseline };
          this.recomputeScheduleDirty();
          this.buildScheduleLayouts();
          if (!this.scheduleDirty) {
            this.scheduleSaveMessage = '';
          }
          this.scheduleSaveError = '';
        } catch (e) {
          console.error(e);
          this.scheduleError = (e && e.message) ? e.message : 'Failed to load schedule.';
        } finally {
          this.scheduleLoading = false;
        }
      },

      normalizeScheduleServices(raw) {
        const list = Array.isArray(raw) ? raw : [];
        const services = [];
        list.forEach(item => {
          const id = String(item?.id || '').trim();
          if (!id) return;
          const date = String(item?.date || '').trim();
          const weekday = String(item?.weekday || '') || this.formatScheduleDate(date, { weekday: 'long' }) || '';
          services.push({
            id,
            date,
            time: String(item?.time || '').trim(),
            type: String(item?.type || '').trim(),
            label: String(item?.label || '') || this.formatScheduleDate(date, { weekday: 'short', month: 'short', day: 'numeric' }) || date,
            shortLabel: String(item?.shortLabel || '') || this.formatScheduleDate(date, { month: 'short', day: 'numeric' }) || date,
            ordinalLabel: String(item?.ordinalLabel || '') || this.computeOrdinalLabel(date, weekday),
            weekday
          });
        });
        return services;
      },

      buildScheduleServiceLookup(services) {
        const lookup = {};
        (Array.isArray(services) ? services : []).forEach(service => {
          if (service?.id) lookup[service.id] = service;
        });
        this.scheduleServiceLookup = lookup;
      },

      normalizeScheduleUnavailable(raw) {
        const map = {};
        if (!raw || typeof raw !== 'object') return map;
        Object.entries(raw).forEach(([serviceId, list]) => {
          const id = String(serviceId || '').trim();
          if (!id) return;
          const set = new Set();
          (Array.isArray(list) ? list : []).forEach(email => {
            const key = String(email || '').trim().toLowerCase();
            if (key) set.add(key);
          });
          map[id] = set;
        });
        return map;
      },

      buildScheduleTemplateOverrides(assignments) {
        const overrides = {};
        (Array.isArray(assignments) ? assignments : []).forEach(entry => {
          const serviceId = String(entry?.serviceId || '').trim();
          const teamKey = this.normalize(entry?.teamType);
          const weeklyTeamName = String(entry?.weeklyTeamName || '').trim();
          if (!serviceId || !teamKey || !weeklyTeamName) return;
          if (!overrides[serviceId]) overrides[serviceId] = {};
          overrides[serviceId][teamKey] = weeklyTeamName;
        });
        return overrides;
      },

      normalizeScheduleAssignments(assignments) {
        const map = {};
        (Array.isArray(assignments) ? assignments : []).forEach(entry => {
          const serviceId = String(entry?.serviceId || '').trim();
          const teamType = String(entry?.teamType || '').trim();
          const roleName = String(entry?.roleName || '').trim();
          if (!serviceId || !teamType || !roleName) return;
          const key = this.scheduleCellKey(serviceId, teamType, roleName);
          map[key] = {
            serviceId,
            teamType,
            roleName,
            weeklyTeamName: String(entry?.weeklyTeamName || '').trim(),
            memberEmail: String(entry?.memberEmail || '').trim(),
            memberName: String(entry?.memberName || '').trim(),
            roleType: String(entry?.roleType || '').trim()
          };
        });
        return map;
      },

      scheduleCellKey(serviceId, teamType, roleName) {
        return [
          String(serviceId || '').trim().toLowerCase(),
          this.normalize(teamType),
          this.normalize(roleName)
        ].join('::');
      },

      resolveScheduleService(serviceOrId) {
        if (!serviceOrId) return null;
        if (typeof serviceOrId === 'object') return serviceOrId;
        const key = String(serviceOrId || '').trim();
        if (!key) return null;
        return this.scheduleServiceLookup?.[key] || null;
      },

      scheduleWeeklyTeamNameForService(teamType, serviceOrId) {
        const service = this.resolveScheduleService(serviceOrId);
        if (!service) return '';
        const serviceOverrides = this.scheduleTemplateOverrides?.[service.id];
        const teamKey = this.normalize(teamType);
        if (serviceOverrides && serviceOverrides[teamKey]) {
          return serviceOverrides[teamKey];
        }
        return service.ordinalLabel || this.computeOrdinalLabel(service.date, service.weekday);
      },

      resolveWeeklyTeamForService(teamType, serviceOrId) {
        const service = this.resolveScheduleService(serviceOrId);
        if (!service) return null;
        const preferredName = this.scheduleWeeklyTeamNameForService(teamType, service);
        if (preferredName) {
          const match = this.findWeeklyTeamByName(teamType, preferredName);
          if (match) return match;
        }
        if (service.ordinalLabel) {
          const match = this.findWeeklyTeamByName(teamType, service.ordinalLabel);
          if (match) return match;
        }
        const teams = this.weeklyTeamsByType(teamType);
        return teams.length ? teams[0] : null;
      },

      lookupWeeklyTemplateAssignment(teamType, serviceOrId, roleLabel) {
        const weeklyTeam = this.resolveWeeklyTeamForService(teamType, serviceOrId);
        if (!weeklyTeam) return null;
        const normalizedRole = this.normalize(roleLabel);
        const roles = Array.isArray(weeklyTeam.roles) ? weeklyTeam.roles : [];
        const match = roles.find(role =>
          this.normalize(role?.roleName || role?.roleType) === normalizedRole
        );
        if (!match) {
          return {
            weeklyTeamName: weeklyTeam.teamName || '',
            roleType: roleLabel,
            memberEmail: '',
            memberName: ''
          };
        }
        return {
          weeklyTeamName: weeklyTeam.teamName || '',
          roleType: match.roleType || match.roleName || roleLabel,
          memberEmail: String(match.memberEmail || '').trim(),
          memberName: String(match.memberName || '').trim()
        };
      },

      isMemberUnavailable(email, serviceId) {
        const serviceKey = String(serviceId || '').trim();
        if (!serviceKey) return false;
        const blocked = this.scheduleUnavailableMap?.[serviceKey];
        if (!blocked || !blocked.size) return false;
        const key = String(email || '').trim().toLowerCase();
        if (!key) return false;
        return blocked.has(key);
      },

      effectiveScheduleAssignment(serviceId, teamType, roleName) {
        const key = this.scheduleCellKey(serviceId, teamType, roleName);
        const explicit = this.scheduleAssignmentMap?.[key];
        const service = this.resolveScheduleService(serviceId);
        const fallbackTeamName = this.scheduleWeeklyTeamNameForService(teamType, service);
        if (explicit) {
          const memberEmail = String(explicit.memberEmail || '').trim();
          const unavailable = memberEmail && this.isMemberUnavailable(memberEmail, serviceId);
          if (unavailable) {
            return {
              serviceId,
              teamType,
              roleName,
              memberEmail: '',
              memberName: '',
              weeklyTeamName: fallbackTeamName || explicit.weeklyTeamName || '',
              roleType: explicit.roleType || roleName,
              source: 'saved'
            };
          }
          const memberName = memberEmail ? (explicit.memberName || this.memberNameByEmail(memberEmail) || '') : '';
          return {
            serviceId,
            teamType,
            roleName,
            memberEmail,
            memberName,
            weeklyTeamName: fallbackTeamName || explicit.weeklyTeamName || '',
            roleType: explicit.roleType || roleName,
            source: 'saved'
          };
        }
        const template = this.lookupWeeklyTemplateAssignment(teamType, service, roleName);
        if (template && template.memberEmail && this.isMemberUnavailable(template.memberEmail, serviceId)) {
          template.memberEmail = '';
          template.memberName = '';
        }
        return {
          serviceId,
          teamType,
          roleName,
          memberEmail: template?.memberEmail || '',
          memberName: template?.memberName || '',
          weeklyTeamName: template?.weeklyTeamName || fallbackTeamName || '',
          roleType: template?.roleType || roleName,
          source: template ? 'template' : 'open'
        };
      },

      buildScheduleLayouts() {
        const services = Array.isArray(this.scheduleServices) ? this.scheduleServices : [];
        if (!services.length) {
          this.scheduleLayouts = [];
          return;
        }
        const teamTypes = this.weeklyTeamTypes();
        const layouts = [];
        teamTypes.forEach(teamType => {
          const roles = this.deriveRoleNamesForTeamType(teamType);
          if (!roles.length) return;
          const columns = services.map(service => ({
            id: service.id,
            service,
            teamLabel: this.scheduleWeeklyTeamNameForService(teamType, service)
          }));
          const rows = roles.map(roleName => {
            const cells = {};
            columns.forEach(column => {
              cells[column.id] = this.effectiveScheduleAssignment(column.id, teamType, roleName);
            });
            return {
              key: `${teamType}::${roleName}`,
              label: roleName,
              cells
            };
          });
          layouts.push({ teamType, columns, rows });
        });
        this.scheduleLayouts = layouts;
      },

      recomputeScheduleDirty() {
        const dirty = {};
        const services = Array.isArray(this.scheduleServices) ? this.scheduleServices : [];
        if (!services.length) {
          this.scheduleDirtyKeys = {};
          this.scheduleDirty = false;
          return;
        }
        const teamTypes = this.weeklyTeamTypes();
        teamTypes.forEach(teamType => {
          const roles = this.deriveRoleNamesForTeamType(teamType);
          if (!roles.length) return;
          services.forEach(service => {
            roles.forEach(roleName => {
              const key = this.scheduleCellKey(service.id, teamType, roleName);
              const baseline = this.scheduleAssignmentBaseline?.[key]?.memberEmail || '';
              const current = this.effectiveScheduleAssignment(service.id, teamType, roleName)?.memberEmail || '';
              if (baseline !== current) {
                dirty[key] = true;
              }
            });
          });
        });
        this.scheduleDirtyKeys = dirty;
        this.scheduleDirty = Object.keys(dirty).length > 0;
      },

      setScheduleAssignment(serviceId, teamType, roleName, memberEmail) {
        const key = this.scheduleCellKey(serviceId, teamType, roleName);
        const normalizedEmail = String(memberEmail || '').trim();
        const entry = {
          serviceId,
          teamType: String(teamType || '').trim(),
          roleName,
          weeklyTeamName: this.scheduleWeeklyTeamNameForService(teamType, serviceId),
          memberEmail: normalizedEmail,
          memberName: normalizedEmail ? this.memberNameByEmail(normalizedEmail) : '',
          roleType: roleName
        };
        const next = { ...(this.scheduleAssignmentMap || {}) };
        next[key] = entry;
        this.scheduleAssignmentMap = next;
        this.scheduleSaveMessage = '';
        this.recomputeScheduleDirty();
        this.buildScheduleLayouts();
      },

      formatScheduleDate(dateStr, options) {
        if (!dateStr) return '';
        const date = new Date(`${dateStr}T00:00:00`);
        if (Number.isNaN(date.getTime())) return dateStr;
        try {
          return new Intl.DateTimeFormat('en-US', options).format(date);
        } catch (_) {
          return dateStr;
        }
      },

      computeOrdinalLabel(dateStr, weekdayLabel = '') {
        if (!dateStr) return '';
        const date = new Date(`${dateStr}T00:00:00`);
        if (Number.isNaN(date.getTime())) return '';
        const day = date.getDate();
        const ordinalIndex = Math.floor((day - 1) / 7) + 1;
        const suffix = (() => {
          if (ordinalIndex % 10 === 1 && ordinalIndex % 100 !== 11) return 'st';
          if (ordinalIndex % 10 === 2 && ordinalIndex % 100 !== 12) return 'nd';
          if (ordinalIndex % 10 === 3 && ordinalIndex % 100 !== 13) return 'rd';
          return 'th';
        })();
        let weekday = weekdayLabel;
        if (!weekday) {
          try {
            weekday = new Intl.DateTimeFormat('en-US', { weekday: 'long' }).format(date);
          } catch (_) {
            weekday = '';
          }
        }
        return `${ordinalIndex}${suffix} ${weekday || ''}`.trim();
      },

      async saveSchedule() {
        if (this.scheduleSaving) return;
        const layouts = Array.isArray(this.scheduleLayouts) ? this.scheduleLayouts : [];
        if (!layouts.length) return;
        const assignments = [];
        layouts.forEach(layout => {
          (Array.isArray(layout?.rows) ? layout.rows : []).forEach(row => {
            (Array.isArray(layout?.columns) ? layout.columns : []).forEach(column => {
              const assignment = this.effectiveScheduleAssignment(column.id, layout.teamType, row.label) || {};
              assignments.push({
                serviceId: column.id,
                serviceDate: column.service?.date || '',
                serviceType: column.service?.type || '',
                teamType: layout.teamType,
                weeklyTeamName: this.scheduleWeeklyTeamNameForService(layout.teamType, column.service),
                roleName: row.label,
                roleType: assignment.roleType || row.label,
                memberEmail: assignment.memberEmail || '',
                memberName: assignment.memberEmail
                  ? (this.memberNameByEmail(assignment.memberEmail) || assignment.memberName || '')
                  : '',
                status: assignment.memberEmail ? 'Assigned' : 'Open'
              });
            });
          });
        });
        this.scheduleSaving = true;
        this.scheduleSaveError = '';
        this.scheduleSaveMessage = '';
        try {
          await callRpc('saveServiceTeamAssignments', { assignments });
          this.scheduleSaveMessage = 'Schedule saved.';
          await this.loadSchedule();
        } catch (e) {
          console.error(e);
          this.scheduleSaveError = (e && e.message) ? e.message : 'Failed to save schedule.';
        } finally {
          this.scheduleSaving = false;
        }
      },

      normalizeWeeklyTeam(raw) {
        const team = String(raw?.team || '').trim() || '';
        const teamName = String(raw?.teamName || '').trim();
        const description = String(raw?.description || '').trim();
        const roles = Array.isArray(raw?.roles)
          ? raw.roles
              .map(role => ({
                roleName: String(role?.roleName || role?.role || '').trim(),
                roleType: String(role?.roleType || '').trim(),
                memberEmail: String(role?.memberEmail || '').trim(),
                memberName: String(role?.memberName || '').trim()
              }))
              .filter(role => role.roleName)
          : [];
        return {
          id: this.makeWeeklyTeamId(team, teamName),
          team,
          teamName,
          description,
          roles
        };
      },

      normalizeWeeklyTeamDefaults(raw) {
        const result = {};
        if (!raw || typeof raw !== 'object') return result;
        Object.entries(raw).forEach(([teamType, list]) => {
          const entries = Array.isArray(list) ? list : [];
          const normalized = entries
            .map(entry => ({
              roleName: String(entry?.roleName || entry?.role || '').trim(),
              order: Number(entry?.order) || 0
            }))
            .filter(entry => entry.roleName);
          normalized.sort((a, b) => a.order - b.order);
          if (normalized.length) {
            result[String(teamType || '').trim()] = normalized;
          }
        });
        return result;
      },

      weeklyTeamsByType(type) {
        const key = this.normalize(type);
        return (Array.isArray(this.weeklyTeams) ? this.weeklyTeams : [])
          .filter(item => this.normalize(item?.team) === key)
          .sort((a, b) => String(a.teamName || '').localeCompare(String(b.teamName || '')));
      },

      findWeeklyTeamByName(teamType, teamName) {
        const typeKey = this.normalize(teamType);
        const nameKey = this.normalize(teamName);
        return (Array.isArray(this.weeklyTeams) ? this.weeklyTeams : []).find(team =>
          this.normalize(team?.team) === typeKey && this.normalize(team?.teamName) === nameKey
        );
      },

      async ensureDefaultWeeklyTeams() {
        // Skip auto-creation to avoid lock contention; rely on existing teams.
        return false;
      },

      rebuildWeeklyTeamLayouts() {
        const layouts = [];
        const types = this.weeklyTeamTypes();
        types.forEach(type => {
          const layout = this.buildWeeklyTeamLayout(type);
          if (layout) layouts.push(layout);
        });
        layouts.sort((a, b) => String(a.teamType || '').localeCompare(String(b.teamType || '')));
        this.weeklyTeamLayouts = layouts;
        this.buildScheduleLayouts();
        this.recomputeScheduleDirty();
      },

      buildWeeklyTeamLayout(teamType) {
        const teams = this.weeklyTeamsByType(teamType);
        if (!teams.length) return null;
        const normalizedByName = new Map();
        teams.forEach(team => {
          const key = this.normalize(team.teamName);
          if (key && !normalizedByName.has(key)) normalizedByName.set(key, team);
        });
        const usedIds = new Set();
        const orderedColumns = WEEKLY_COLUMN_LABELS.map(label => {
          const match = normalizedByName.get(this.normalize(label));
          if (match) {
            usedIds.add(match.id);
            return {
              id: match.id,
              key: match.id,
              teamName: match.teamName || label,
              description: match.description || '',
              team: match.team || '',
              dirty: this.isWeeklyTeamDirty(match.id),
              roles: match.roles || []
            };
          }
          return {
            id: null,
            key: `placeholder:${teamType}:${label}`,
            teamName: label,
            description: '',
            team: teamType,
            dirty: false,
            roles: [],
            placeholder: true
          };
        });
        const extraColumns = teams
          .filter(team => !usedIds.has(team.id))
          .map(team => ({
            id: team.id,
            key: team.id,
            teamName: team.teamName || '(untitled team)',
            description: team.description || '',
            team: team.team || '',
            dirty: this.isWeeklyTeamDirty(team.id),
            roles: team.roles || []
          }));
        const columns = [...orderedColumns, ...extraColumns];

        const roleNames = [];
        const seen = new Set();
        const addRoleName = (value) => {
          const label = String(value || '').trim();
          if (!label) return;
          const key = this.normalize(label);
          if (seen.has(key)) return;
          seen.add(key);
          roleNames.push(label);
        };

        const defaults = Array.isArray(this.weeklyTeamDefaults?.[teamType])
          ? this.weeklyTeamDefaults[teamType]
          : [];
        defaults.forEach(entry => addRoleName(entry.roleName));

        teams.forEach(team => {
          (Array.isArray(team.roles) ? team.roles : []).forEach(role => {
            addRoleName(role?.roleName || role?.roleType || '(Role)');
          });
        });

        if (!roleNames.length) roleNames.push('Role');

        const roles = roleNames.map(name => {
          const cells = {};
          const normalized = this.normalize(name);
          columns.forEach(column => {
            const assignment = column.id
              ? (Array.isArray(column.roles) ? column.roles : []).find(r =>
                  this.normalize(r?.roleName || r?.roleType) === normalized
                )
              : null;
            const memberEmail = assignment ? String(assignment.memberEmail || '').trim() : '';
            cells[column.key] = {
              memberEmail,
              memberName: memberEmail ? (assignment?.memberName || this.memberNameByEmail(memberEmail) || '') : ''
            };
          });
          return {
            key: `${teamType}::${name}`,
            label: name,
            cells
          };
        });

        return { teamType, teams: columns, roles };
      },

      deriveRoleNamesForTeamType(teamType) {
        const names = [];
        const seen = new Set();
        const pushName = (name) => {
          const clean = String(name || '').trim();
          if (!clean) return;
          const key = this.normalize(clean);
          if (seen.has(key)) return;
          seen.add(key);
          names.push(clean);
        };
        this.weeklyTeamsByType(teamType).forEach(team => {
          (Array.isArray(team.roles) ? team.roles : []).forEach(role => {
            pushName(role?.roleName || role?.roleType);
          });
        });
        if (!names.length && Array.isArray(this.rolePresets?.[teamType])) {
          this.rolePresets[teamType].forEach(pushName);
        }
        return names;
      },

      openRoleDefaults(teamType) {
        this.roleDefaultsTeamType = teamType;
        const existing = Array.isArray(this.weeklyTeamDefaults?.[teamType])
          ? this.weeklyTeamDefaults[teamType].map(entry => entry.roleName)
          : [];
        const fallback = existing.length ? existing : this.deriveRoleNamesForTeamType(teamType);
        this.roleDefaultsDraft = (fallback.length ? fallback : ['']).map(name => String(name || ''));
        this.roleDefaultsError = '';
        this.showRoleDefaultsModal = true;
        this.$nextTick(() => {
          try {
            const first = this.$el?.querySelector('[data-role-default-input]');
            if (first) first.focus();
          } catch (_) {}
        });
      },

      closeRoleDefaults() {
        if (this.roleDefaultsSaving) return;
        this.showRoleDefaultsModal = false;
      },

      addRoleDefault() {
        this.roleDefaultsDraft = [...(this.roleDefaultsDraft || []), ''];
        this.$nextTick(() => {
          try {
            const inputs = this.$el?.querySelectorAll('[data-role-default-input]');
            if (inputs && inputs.length) inputs[inputs.length - 1].focus();
          } catch (_) {}
        });
      },

      removeRoleDefault(index) {
        const list = Array.isArray(this.roleDefaultsDraft) ? [...this.roleDefaultsDraft] : [];
        if (list.length <= 1) {
          list[0] = '';
        } else {
          list.splice(index, 1);
        }
        this.roleDefaultsDraft = list;
      },

      moveRoleDefault(index, delta) {
        const list = Array.isArray(this.roleDefaultsDraft) ? [...this.roleDefaultsDraft] : [];
        const target = index + delta;
        if (target < 0 || target >= list.length) return;
        const [item] = list.splice(index, 1);
        list.splice(target, 0, item);
        this.roleDefaultsDraft = list;
      },

      async saveRoleDefaults() {
        if (this.roleDefaultsSaving) return;
        const team = String(this.roleDefaultsTeamType || '').trim();
        if (!team) {
          this.roleDefaultsError = 'Select a team type.';
          return;
        }
        const roles = (Array.isArray(this.roleDefaultsDraft) ? this.roleDefaultsDraft : [])
          .map(role => String(role || '').trim())
          .filter(Boolean);
        if (!roles.length) {
          this.roleDefaultsError = 'Add at least one role name.';
          return;
        }
        this.roleDefaultsSaving = true;
        this.roleDefaultsError = '';
        try {
          const res = await callRpc('saveWeeklyTeamDefaults', { team, roles });
          if (res?.defaults) {
            this.weeklyTeamDefaults = this.normalizeWeeklyTeamDefaults(res.defaults);
          }
          if (Array.isArray(res?.items)) {
            this.weeklyTeams = res.items.map(item => this.normalizeWeeklyTeam(item));
          }
          this.showRoleDefaultsModal = false;
          this.rebuildWeeklyTeamLayouts();
        } catch (e) {
          console.error(e);
          this.roleDefaultsError = (e && e.message) ? e.message : 'Failed to save default roles.';
        } finally {
          this.roleDefaultsSaving = false;
        }
      },

      setWeeklyTeamMember(teamId, roleLabel, email) {
        const team = (Array.isArray(this.weeklyTeams) ? this.weeklyTeams : []).find(item => item.id === teamId);
        if (!team || !teamId) return;
        this.weeklyTeamsSaveMessage = '';
        this.weeklyTeamsSaveError = '';
        const roleName = String(roleLabel || '').trim();
        if (!roleName) return;
        const roles = Array.isArray(team.roles) ? team.roles : [];
        const normalizedRoleName = this.normalize(roleName);
        let entry = roles.find(r => this.normalize(r?.roleName || r?.roleType) === normalizedRoleName);
        if (!entry) {
          entry = {
            roleName,
            roleType: roleName,
            memberEmail: '',
            memberName: ''
          };
          roles.push(entry);
          team.roles = roles;
        }
        entry.roleName = roleName;
        entry.roleType = entry.roleType || roleName;
        const trimmed = String(email || '').trim();
        entry.memberEmail = trimmed;
        entry.memberName = trimmed ? (this.memberNameByEmail(trimmed) || entry.memberName || '') : '';
        if (!trimmed) {
          entry.memberName = '';
        }
        const version = this.markWeeklyTeamDirty(teamId);
        this.rebuildWeeklyTeamLayouts();
        this.queueTeamSave(teamId, version);
      },

      markWeeklyTeamDirty(teamId) {
        if (!teamId) return 0;
        const nextVersion = (this.teamDirtyVersions?.[teamId] || 0) + 1;
        this.teamDirtyVersions = { ...(this.teamDirtyVersions || {}), [teamId]: nextVersion };
        this.weeklyTeamDirtyFlags = {
          ...this.weeklyTeamDirtyFlags,
          [teamId]: true
        };
        return nextVersion;
      },

      clearWeeklyTeamDirtyFlag(teamId) {
        if (!teamId) return;
        const next = { ...this.weeklyTeamDirtyFlags };
        delete next[teamId];
        this.weeklyTeamDirtyFlags = next;
        const versions = { ...(this.teamDirtyVersions || {}) };
        delete versions[teamId];
        this.teamDirtyVersions = versions;
        if (this.teamSaveTimers?.[teamId]) {
          clearTimeout(this.teamSaveTimers[teamId]);
          const timers = { ...(this.teamSaveTimers || {}) };
          delete timers[teamId];
          this.teamSaveTimers = timers;
        }
      },

      isWeeklyTeamDirty(teamId) {
        return Boolean(teamId && this.weeklyTeamDirtyFlags && this.weeklyTeamDirtyFlags[teamId]);
      },

      hasDirtyWeeklyTeams() {
        return Object.values(this.weeklyTeamDirtyFlags || {}).some(Boolean);
      },

      groupDirtyIds(group) {
        if (!group || !Array.isArray(group.teams)) return [];
        return group.teams
          .map(team => team && team.id)
          .filter(id => this.isWeeklyTeamDirty(id));
      },

      queueTeamSave(teamId, version) {
        if (!teamId) return;
        if (this.teamSaveTimers?.[teamId]) {
          clearTimeout(this.teamSaveTimers[teamId]);
        }
        const timers = { ...(this.teamSaveTimers || {}) };
        timers[teamId] = setTimeout(() => {
          const currentTimers = { ...(this.teamSaveTimers || {}) };
          delete currentTimers[teamId];
          this.teamSaveTimers = currentTimers;
          this.saveDirtyWeeklyTeams([teamId], { [teamId]: version }).catch(err => console.error(err));
        }, 400);
        this.teamSaveTimers = timers;
      },

      async saveDirtyWeeklyTeams(targetIds = null, expectedVersions = null) {
        const targeted = Array.isArray(targetIds) && targetIds.length;
        const idsToSave = targeted
          ? targetIds.filter(Boolean)
          : Object.entries(this.weeklyTeamDirtyFlags || {})
              .filter(([, flag]) => flag)
              .map(([id]) => id);
        if (!idsToSave.length) return;
        if (!targeted && this.weeklyTeamsSaving) return;
        if (!targeted && !this.hasDirtyWeeklyTeams()) return;
        if (!targeted) this.weeklyTeamsSaving = true;
        this.weeklyTeamsSaveError = '';
        if (!targeted) this.weeklyTeamsSaveMessage = '';
        try {
          for (const id of idsToSave) {
            if (!id) continue;
            if (targeted && this.savingTeams?.[id]) continue;
            if (targeted) {
              this.savingTeams = { ...(this.savingTeams || {}), [id]: true };
            }
            const team = (Array.isArray(this.weeklyTeams) ? this.weeklyTeams : []).find(item => item.id === id);
            if (!team) {
              if (targeted) {
                const next = { ...(this.savingTeams || {}) };
                delete next[id];
                this.savingTeams = next;
              }
              continue;
            }
            const payload = {
              team: team.team,
              teamName: team.teamName,
              description: team.description,
              roles: (Array.isArray(team.roles) ? team.roles : []).map(role => ({
                roleName: String(role?.roleName || '').trim(),
                roleType: String(role?.roleType || '').trim(),
                memberEmail: String(role?.memberEmail || '').trim(),
                memberName: String(role?.memberName || '').trim()
              }))
            };
            const expected = targeted ? (expectedVersions?.[id] ?? this.teamDirtyVersions?.[id] ?? null) : null;
            try {
              const res = await callRpc('saveWeeklyTeam', payload);
              if (!targeted && res?.items) {
                this.weeklyTeams = res.items.map(item => this.normalizeWeeklyTeam(item));
                if (res?.defaults) {
                  this.weeklyTeamDefaults = this.normalizeWeeklyTeamDefaults(res.defaults);
                }
              }
              if (!expected || this.teamDirtyVersions?.[id] === expected) {
                this.clearWeeklyTeamDirtyFlag(id);
              }
            } catch (err) {
              const message = (err && err.message) ? err.message : String(err || '');
              if (targeted && /lock/i.test(message)) {
                if (this.teamSaveTimers?.[id]) {
                  clearTimeout(this.teamSaveTimers[id]);
                }
                const timers = { ...(this.teamSaveTimers || {}) };
                timers[id] = setTimeout(() => {
                  const currentVersion = this.teamDirtyVersions?.[id] || expected || 0;
                  this.saveDirtyWeeklyTeams([id], { [id]: currentVersion }).catch(() => {});
                }, 600);
                this.teamSaveTimers = timers;
                const next = { ...(this.savingTeams || {}) };
                delete next[id];
                this.savingTeams = next;
                continue;
              }
              throw err;
            }
            if (targeted) {
              const next = { ...(this.savingTeams || {}) };
              delete next[id];
              this.savingTeams = next;
              const currentVersion = this.teamDirtyVersions?.[id];
              if (this.weeklyTeamDirtyFlags?.[id] && currentVersion && (!expected || currentVersion > expected)) {
                this.saveDirtyWeeklyTeams([id], { [id]: currentVersion }).catch(() => {});
              }
            }
          }
          if (!targeted) {
            await this.loadWeeklyTeams();
            this.weeklyTeamsSaveMessage = idsToSave.length === 1 ? 'Weekly team saved.' : 'Weekly teams saved.';
          } else {
            this.rebuildWeeklyTeamLayouts();
          }
        } catch (e) {
          console.error(e);
          this.weeklyTeamsSaveError = (e && e.message) ? e.message : 'Failed to save weekly teams.';
        } finally {
          if (!targeted) {
            this.weeklyTeamsSaving = false;
            this.rebuildWeeklyTeamLayouts();
          }
        }
      },

      openWeeklyTeamEditor(id) {
        this.selectWeeklyTeam(id);
        if (this.selectedWeeklyTeamId) {
          this.weeklyTeamEditorOpen = true;
        }
      },

      closeWeeklyTeamEditor() {
        if (this.weeklyTeamSaving) return;
        this.weeklyTeamEditorOpen = false;
        this.selectedWeeklyTeamId = '';
      },

      makeWeeklyTeamId(team, teamName) {
        const t = String(team || '').trim().toLowerCase();
        const n = String(teamName || '').trim().toLowerCase();
        return `${t}::${n}`;
      },

      weeklyTeamTypes() {
        const lookup = new Map();
        const add = (value) => {
          const val = String(value || '').trim();
          if (!val) return;
          const key = val.toLowerCase();
          if (!lookup.has(key)) {
            lookup.set(key, val);
          }
        };
        Object.keys(this.rolePresets || {}).forEach(add);
        (Array.isArray(this.weeklyTeams) ? this.weeklyTeams : []).forEach(item => add(item.team));
        const priorityIndex = value => {
          const key = String(value || '').trim().toLowerCase();
          const idx = TEAM_TYPE_PRIORITY.findIndex(name => name.toLowerCase() === key);
          return idx >= 0 ? idx : TEAM_TYPE_PRIORITY.length;
        };
        return Array.from(lookup.values()).sort((a, b) => {
          const pa = priorityIndex(a);
          const pb = priorityIndex(b);
          if (pa !== pb) return pa - pb;
          return a.localeCompare(b);
        });
      },

      filteredWeeklyTeams() {
        const filter = String(this.weeklyTeamFilter || '').trim().toLowerCase();
        const list = Array.isArray(this.weeklyTeams) ? this.weeklyTeams : [];
        return list
          .filter(item => !filter || String(item.team || '').trim().toLowerCase() === filter)
          .sort((a, b) => {
            const teamA = String(a.team || '').toLowerCase();
            const teamB = String(b.team || '').toLowerCase();
            if (teamA !== teamB) return teamA.localeCompare(teamB);
            const nameA = String(a.teamName || '');
            const nameB = String(b.teamName || '');
            return nameA.localeCompare(nameB);
          });
      },

      roleTypeOptions() {
        const teamType = String(this.weeklyTeamDraft?.team || '').trim();
        const includeExtra = this.weeklyTeamShowAllRoles;
        const map = new Map();
        const add = (value) => {
          const val = String(value || '').trim();
          if (!val) return;
          const key = val.toLowerCase();
          if (!map.has(key)) {
            map.set(key, val);
          }
        };
        const presetList = Array.isArray(this.rolePresets?.[teamType]) ? this.rolePresets[teamType] : [];
        presetList.forEach(add);
        (Array.isArray(this.weeklyTeamRolesDraft) ? this.weeklyTeamRolesDraft : []).forEach(role => {
          add(role.roleType || role.roleName);
        });
        if (includeExtra) {
          (Array.isArray(this.weeklyTeams) ? this.weeklyTeams : []).forEach(item => {
            if (teamType && String(item.team || '').trim() !== teamType) return;
            (Array.isArray(item.roles) ? item.roles : []).forEach(role => {
              add(role.roleType || role.roleName);
            });
          });
          Object.values(this.memberLookup || {}).forEach(member => {
            (Array.isArray(member.roles) ? member.roles : []).forEach(add);
          });
        }
        return Array.from(map.values()).sort((a, b) => a.localeCompare(b));
      },

      canonicalRoleTypeValue(value, fallback = '') {
        const raw = String(value || '').trim() || String(fallback || '').trim();
        if (!raw) return '';
        const lower = raw.toLowerCase();
        const match = this.roleTypeOptions().find(opt => opt.toLowerCase() === lower);
        return match || raw;
      },

      canonicalMemberEmail(value) {
        const email = String(value || '').trim();
        if (!email) return '';
        const key = email.toLowerCase();
        const info = this.memberLookup?.[key];
        return info?.email || email;
      },

      syncWeeklyRoleSelections() {
        this.$nextTick(() => {
          const rows = Array.isArray(this.weeklyTeamRolesDraft) ? this.weeklyTeamRolesDraft : [];
          rows.forEach(role => {
            if (!role) return;
            const canonicalType = this.canonicalRoleTypeValue(role.roleType, role.roleName);
            if (canonicalType !== undefined) {
              role.roleType = canonicalType;
            }
            const canonicalEmail = this.canonicalMemberEmail(role.memberEmail);
            role.memberEmail = canonicalEmail;
            if (canonicalEmail) {
              role.memberName = this.memberNameByEmail(canonicalEmail) || role.memberName || '';
            }
            const typeEl = this.$el?.querySelector(`[data-role-type-select="${role.id}"]`);
            if (typeEl && typeEl.value !== role.roleType) {
              typeEl.value = role.roleType || '';
            }
            const memberEl = this.$el?.querySelector(`[data-role-member-select="${role.id}"]`);
            if (memberEl && memberEl.value !== role.memberEmail) {
              memberEl.value = role.memberEmail || '';
            }
          });
        });
      },

      roleTypeOptionsForRole(role) {
        const current = role && (role.roleType || role.roleName);
        const opts = this.roleTypeOptions();
        if (current) {
          const val = String(current).trim();
          if (val) {
            const match = opts.find(o => o.toLowerCase() === val.toLowerCase());
            if (match) {
              if (role && role.roleType !== match) {
                role.roleType = match;
              }
            } else {
              opts.push(val);
              opts.sort((a, b) => a.localeCompare(b));
              if (role && role.roleType !== val) {
                role.roleType = val;
              }
            }
          }
        }
        return opts;
      },

      formatWeeklyTeamSummary(team) {
        const roles = Array.isArray(team?.roles) ? team.roles : [];
        if (!roles.length) return 'No roles defined';
        const filled = roles.filter(item => String(item?.memberEmail || '').trim());
        if (!filled.length) return `${roles.length} roles, all unassigned`;
        return `${filled.length} of ${roles.length} roles assigned`;
      },

      nextWeeklyRoleId() {
        this.weeklyTeamRoleIdCounter += 1;
        return `role-${Date.now()}-${this.weeklyTeamRoleIdCounter}`;
      },

      makeWeeklyTeamRoleDraft(role = {}) {
        const roleName = String(role?.roleName || role?.role || '').trim();
        const roleTypeRaw = String(role?.roleType || '').trim();
        const memberEmailRaw = String(role?.memberEmail || '').trim();
        const canonicalEmail = this.canonicalMemberEmail(memberEmailRaw);
        return {
          id: this.nextWeeklyRoleId(),
          roleName,
          roleType: this.canonicalRoleTypeValue(roleTypeRaw, roleName),
          memberEmail: canonicalEmail,
          memberName: this.memberNameByEmail(canonicalEmail) || String(role?.memberName || '').trim()
        };
      },

      cloneWeeklyTeamRoles(list) {
        const arr = [];
        (Array.isArray(list) ? list : []).forEach(role => {
          arr.push(this.makeWeeklyTeamRoleDraft(role));
        });
        return arr;
      },

      addWeeklyTeamRole(roleType = '') {
        const types = this.roleTypeOptions();
        const chosenType = String(roleType || (types.length ? types[0] : '') || '').trim();
        const entry = this.makeWeeklyTeamRoleDraft({
          roleType: chosenType,
          roleName: ''
        });
        this.weeklyTeamRolesDraft = [
          ...(Array.isArray(this.weeklyTeamRolesDraft) ? this.weeklyTeamRolesDraft : []),
          entry
        ];
        this.syncWeeklyRoleSelections();
      },

      removeWeeklyTeamRole(id) {
        const list = Array.isArray(this.weeklyTeamRolesDraft) ? this.weeklyTeamRolesDraft : [];
        this.weeklyTeamRolesDraft = list.filter(role => role.id !== id);
        this.syncWeeklyRoleSelections();
      },

      selectWeeklyTeam(id) {
        const row = (Array.isArray(this.weeklyTeams) ? this.weeklyTeams : []).find(item => item.id === id);
        if (!row) return;
        this.selectedWeeklyTeamId = row.id;
        this.weeklyTeamDraft = {
          team: row.team || '',
          teamName: row.teamName || '',
          description: row.description || ''
        };
        this.weeklyTeamRoleIdCounter = 0;
        this.weeklyTeamRolesDraft = this.cloneWeeklyTeamRoles(row.roles || []);
        this.weeklyTeamShowAllRoles = false;
        this.weeklyTeamSaveError = '';
        this.weeklyTeamSavedAt = 0;
        this.updateWeeklyTeamBaseline();
        this.syncWeeklyRoleSelections();
      },

      updateWeeklyTeamBaseline() {
        this.weeklyTeamBaseline = this.captureWeeklyTeamDraft();
      },

      captureWeeklyTeamDraft() {
        const roles = [];
        (Array.isArray(this.weeklyTeamRolesDraft) ? this.weeklyTeamRolesDraft : []).forEach(role => {
          const roleName = String(role?.roleName || '').trim();
          if (!roleName) return;
          roles.push({
            roleName,
            roleType: String(role?.roleType || '').trim(),
            memberEmail: String(role?.memberEmail || '').trim(),
            memberName: String(role?.memberName || '').trim()
          });
        });
        return {
          team: String(this.weeklyTeamDraft?.team || '').trim(),
          teamName: String(this.weeklyTeamDraft?.teamName || '').trim(),
          description: String(this.weeklyTeamDraft?.description || '').trim(),
          roles
        };
      },

      compareWeeklyTeamDraft(a, b) {
        if (!a || !b) return false;
        const normalize = (data) => {
          const roles = Array.isArray(data.roles) ? data.roles : [];
          return {
            team: String(data.team || '').trim(),
            teamName: String(data.teamName || '').trim(),
            description: String(data.description || '').trim(),
            roles: roles.map(role => ({
              roleName: String(role?.roleName || '').trim(),
              roleType: String(role?.roleType || '').trim(),
              memberEmail: String(role?.memberEmail || '').trim()
            }))
          };
        };
        const left = normalize(a);
        const right = normalize(b);
        if (left.team !== right.team) return false;
        if (left.teamName !== right.teamName) return false;
        if (left.description !== right.description) return false;
        if (left.roles.length !== right.roles.length) return false;
        for (let i = 0; i < left.roles.length; i += 1) {
          const l = left.roles[i];
          const r = right.roles[i];
          if (l.roleName !== r.roleName) return false;
          if (l.roleType !== r.roleType) return false;
          if (l.memberEmail !== r.memberEmail) return false;
        }
        return true;
      },

      resetWeeklyTeamEdits() {
        if (!this.weeklyTeamBaseline) return;
        this.weeklyTeamDraft = {
          team: this.weeklyTeamBaseline.team,
          teamName: this.weeklyTeamBaseline.teamName,
          description: this.weeklyTeamBaseline.description
        };
        this.weeklyTeamRoleIdCounter = 0;
        this.weeklyTeamRolesDraft = this.cloneWeeklyTeamRoles(this.weeklyTeamBaseline.roles || []);
        this.syncWeeklyRoleSelections();
      },

      toggleShowAllRoles() {
        this.weeklyTeamShowAllRoles = !this.weeklyTeamShowAllRoles;
      },

      handleWeeklyTeamTypeChange() {
        // Ensure we keep baseline updated after manual changes.
      },

      parseRoleList(value) {
        return String(value || '')
          .split(/[,;|]/)
          .map(v => v.trim())
          .filter(Boolean);
      },

      memberOptions() {
        const list = Object.values(this.memberLookup || {});
        return list.sort((a, b) => a.label.localeCompare(b.label));
      },

      memberOptionsForRoleType(roleType, role = null, opts = null) {
        const normalizedType = this.normalize(roleType) || this.normalize(role?.roleName);
        const options = this.memberOptions();
        const canonicalType = this.canonicalRoleKey(roleType) || this.canonicalRoleKey(role?.roleName);
        let filtered = normalizedType
          ? options.filter(opt => Array.isArray(opt.rolesNormalized) && opt.rolesNormalized.includes(normalizedType))
          : options;
        if (canonicalType) {
          const canonicalFiltered = options.filter(opt =>
            Array.isArray(opt.roleCanonicalKeys) && opt.roleCanonicalKeys.includes(canonicalType)
          );
          if (canonicalFiltered.length) {
            filtered = canonicalFiltered;
          }
        }
        if (!filtered.length) {
          filtered = options;
        }
        const serviceId = opts && opts.serviceId ? String(opts.serviceId || '').trim() : '';
        let blocked = null;
        if (serviceId) {
          blocked = this.scheduleUnavailableMap?.[serviceId];
          if (blocked && blocked.size) {
            filtered = filtered.filter(opt => !blocked.has(String(opt.email || '').trim().toLowerCase()));
          }
        }
        const assignedEmailRaw = role ? String(role.memberEmail || '').trim() : '';
        if (assignedEmailRaw) {
          const assignedEmail = assignedEmailRaw.toLowerCase();
          const exists = filtered.some(opt => String(opt.email || '').trim().toLowerCase() === assignedEmail);
          const isBlocked = blocked && blocked.has(assignedEmail);
          if (!exists && !isBlocked) {
            const label = role?.memberName || this.memberLabel(assignedEmailRaw) || assignedEmailRaw;
            filtered = [
              { email: assignedEmailRaw, label: `${label} (not in roster)` },
              ...filtered
            ];
          }
        }
        return filtered.map(opt => ({
          ...opt,
          display: opt.shortLabel || opt.label || opt.email
        }));
      },

      memberLabel(email, fallback = '') {
        const key = String(email || '').trim().toLowerCase();
        if (!key) return fallback || '';
        return this.memberLookup?.[key]?.label || fallback || email || '';
      },

      memberNameByEmail(email) {
        const key = String(email || '').trim().toLowerCase();
        if (!key) return '';
        const info = this.memberLookup?.[key];
        const first = String(info?.first || '').trim();
        const last = String(info?.last || '').trim();
        const name = [first, last].filter(Boolean).join(' ');
        return name || info?.label || email || '';
      },

      get selectedWeeklyTeam() {
        return (Array.isArray(this.weeklyTeams) ? this.weeklyTeams : []).find(item => item.id === this.selectedWeeklyTeamId) || null;
      },

      get weeklyTeamDirty() {
        if (!this.selectedWeeklyTeam) return false;
        if (!this.weeklyTeamBaseline) return false;
        const draft = this.captureWeeklyTeamDraft();
        return !this.compareWeeklyTeamDraft(draft, this.weeklyTeamBaseline);
      },

      async saveWeeklyTeam() {
        if (!this.selectedWeeklyTeam || this.weeklyTeamSaving || !this.weeklyTeamDirty) return;
        const draft = this.captureWeeklyTeamDraft();
        if (!Array.isArray(draft.roles) || !draft.roles.length) {
          this.weeklyTeamSaveError = 'Add at least one role name before saving.';
          this.weeklyTeamSavedAt = 0;
          return;
        }
        this.weeklyTeamSaving = true;
        this.weeklyTeamSaveError = '';
        try {
          const payload = {
            team: draft.team,
            teamName: draft.teamName,
            description: draft.description,
            roles: (Array.isArray(draft.roles) ? draft.roles : []).map(role => ({
              roleName: role.roleName,
              roleType: role.roleType,
              memberEmail: role.memberEmail,
              memberName: this.memberNameByEmail(role.memberEmail) || role.memberName
            })),
            original: {
              team: this.weeklyTeamBaseline.team,
              teamName: this.weeklyTeamBaseline.teamName
            }
          };
          const res = await callRpc('saveWeeklyTeam', payload);
          const items = Array.isArray(res?.items) ? res.items : null;
          if (items) {
            this.weeklyTeams = items.map(item => this.normalizeWeeklyTeam(item));
          } else {
            this.upsertWeeklyTeamLocal(draft, this.weeklyTeamBaseline);
          }
          const newId = this.makeWeeklyTeamId(draft.team, draft.teamName);
          this.clearWeeklyTeamDirtyFlag(this.selectedWeeklyTeamId);
          this.clearWeeklyTeamDirtyFlag(newId);
          this.rebuildWeeklyTeamLayouts();
          this.selectWeeklyTeam(newId);
          this.weeklyTeamSavedAt = Date.now();
        } catch (e) {
          console.error(e);
          this.weeklyTeamSaveError = (e && e.message) ? e.message : 'Failed to save weekly team.';
        } finally {
          this.weeklyTeamSaving = false;
        }
      },

      upsertWeeklyTeamLocal(draft, baseline) {
        const list = Array.isArray(this.weeklyTeams) ? [...this.weeklyTeams] : [];
        const next = {
          id: this.makeWeeklyTeamId(draft.team, draft.teamName),
          team: draft.team,
          teamName: draft.teamName,
          description: draft.description,
          roles: []
        };
        (Array.isArray(draft.roles) ? draft.roles : []).forEach(role => {
          const roleName = String(role?.roleName || '').trim();
          if (!roleName) return;
          const memberEmail = String(role?.memberEmail || '').trim();
          next.roles.push({
            roleName,
            roleType: String(role?.roleType || '').trim(),
            memberEmail,
            memberName: role?.memberName || this.memberNameByEmail(memberEmail)
          });
        });
        let index = list.findIndex(item => item.id === next.id);
        if (index === -1 && baseline) {
          const baselineId = this.makeWeeklyTeamId(baseline.team, baseline.teamName);
          index = list.findIndex(item => item.id === baselineId);
        }
        if (index === -1) {
          list.push(next);
        } else {
          list[index] = next;
        }
        this.weeklyTeams = list;
      },

      resetNewWeeklyTeamForm() {
        this.newWeeklyTeamError = '';
        const defaultTeam = this.defaultWeeklyTeamType();
        this.newWeeklyTeam = {
          team: defaultTeam,
          teamName: '',
          description: ''
        };
      },

      defaultWeeklyTeamType() {
        const list = this.weeklyTeamTypes();
        return list.length ? list[0] : '';
      },

      openNewWeeklyTeam(teamType = '') {
        this.resetNewWeeklyTeamForm();
        if (teamType) {
          this.newWeeklyTeam.team = teamType;
        }
        this.showNewWeeklyTeamModal = true;
      },

      closeNewWeeklyTeam() {
        if (this.newWeeklyTeamSaving) return;
        this.showNewWeeklyTeamModal = false;
      },

      async createWeeklyTeam() {
        if (this.newWeeklyTeamSaving) return;
        const team = String(this.newWeeklyTeam.team || '').trim();
        const teamName = String(this.newWeeklyTeam.teamName || '').trim();
        if (!team) { this.newWeeklyTeamError = 'Team type is required.'; return; }
        if (!teamName) { this.newWeeklyTeamError = 'Team name is required.'; return; }
        this.newWeeklyTeamSaving = true;
        this.newWeeklyTeamError = '';
        try {
          const payload = {
            team,
            teamName,
            description: String(this.newWeeklyTeam.description || '').trim()
          };
          const res = await callRpc('createWeeklyTeam', payload);
          const items = Array.isArray(res?.items) ? res.items : null;
          if (items) {
            this.weeklyTeams = items.map(item => this.normalizeWeeklyTeam(item));
          } else {
            this.upsertWeeklyTeamLocal({
              team: payload.team,
              teamName: payload.teamName,
              description: payload.description,
              roles: []
            });
          }
          const newId = this.makeWeeklyTeamId(payload.team, payload.teamName);
          this.showNewWeeklyTeamModal = false;
          this.selectWeeklyTeam(newId);
        } catch (e) {
          console.error(e);
          this.newWeeklyTeamError = (e && e.message) ? e.message : 'Failed to create weekly team.';
        } finally {
          this.newWeeklyTeamSaving = false;
        }
      },

      select(email) {
        const row = this.roles.find(r => r.email === email);
        if (!row) return;
        this.selectedEmail = row.email;
        this.editTeam = row.teamRaw || '';
        const teamSelections = {};
        this.splitList(row.teamRaw || '').forEach(team => {
          if (!team) return;
          const key = this.teamKey(team);
          if (!key) return;
          teamSelections[key] = team.trim();
        });
        this.teamSelections = teamSelections;
        this.editTeam = this.buildTeamString();
        const roleSelections = {};
        const leftovers = [];
        this.splitList(row.role || '').forEach(role => {
          const canonical = this.presetLookup[this.normalize(role)];
          if (canonical) {
            roleSelections[canonical] = true;
          } else {
            leftovers.push(role);
          }
        });
        this.roleSelections = roleSelections;
        
        this.editPermissions = (row.permissions || '').trim();
        this.ensurePermissionOption(this.editPermissions);
        this.spanishChecked = String(row.spanish || '').trim().toUpperCase() === 'Y';
        this.savedAt = 0;
      },

      resetEdits() {
        if (this.selectedEmail) this.select(this.selectedEmail);
      },

      setRole(role, checked) {
        const next = { ...this.roleSelections };
        if (checked) next[role] = true;
        else delete next[role];
        this.roleSelections = next;
      },

      toggleTeam(team, checked) {
        const next = { ...this.teamSelections };
        const key = this.teamKey(team);
        if (!key) return;
        if (checked) next[key] = String(team || '').trim();
        else delete next[key];
        this.teamSelections = next;
        this.editTeam = this.buildTeamString();
      },

      selectedTeams() {
        return Object.values(this.teamSelections || {}).sort((a, b) => a.localeCompare(b));
      },

      isTeamSelected(team) {
        const key = this.teamKey(team);
        if (!key) return false;
        return Boolean(this.teamSelections && this.teamSelections[key]);
      },

      async save() {
        const sel = this.selected;
        if (!sel || this.saving || !this.dirty) return;
        this.saving = true;
        this.error = '';
        try {
          const payload = {
            email: sel.email,
            team: this.buildTeamString(),
            role: this.buildRoleString(),
            permissions: this.editPermissions.trim(),
            spanish: this.spanishChecked ? 'Y' : ''
          };
          const res = await callRpc('updateRoleEntry', payload);
          this.roles = Array.isArray(res?.items) ? res.items : this.roles;
          this.teamOptions = Array.isArray(res?.teams) ? res.teams : this.teamOptions;
          this.permissionsOptions = (() => {
            const permMap = new Map();
            ['subscriber', 'editor', 'administrator'].forEach(p => permMap.set(p.toLowerCase(), p));
            this.roles.forEach(r => {
              const val = String(r.permissions || '').trim();
              if (val) permMap.set(val.toLowerCase(), val);
            });
            return Array.from(permMap.values()).sort((a, b) => a.localeCompare(b));
          })();
          this.select(sel.email);
          this.savedAt = Date.now();
        } catch (e) {
          console.error(e);
          this.error = (e && e.message) ? e.message : 'Failed to save changes.';
        } finally {
          this.saving = false;
        }
      },

      formatPermission(p) {
        if (!p) return '(none)';
        return p.replace(/\b\w/g, c => c.toUpperCase());
      },

      timeAgo(ts) {
        if (!ts) return '';
        const diff = Math.max(0, Date.now() - ts);
        if (diff < 1000) return 'just now';
        const minutes = Math.floor(diff / 60000);
        if (minutes < 1) return 'just now';
        if (minutes < 60) return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;
        const days = Math.floor(hours / 24);
        return `${days} day${days === 1 ? '' : 's'} ago`;
      },

      openNewMember() {
        this.newMember = { email: '', first: '', last: '', permissions: 'subscriber' };
        this.newMemberError = '';
        this.teamSelections = {};
        this.editTeam = '';
        this.showNewMemberModal = true;
        this.$nextTick(() => {
          try { this.$refs?.newMemberEmail?.focus(); } catch (_) {}
        });
      },

      closeNewMember() {
        if (this.newMemberSaving) return;
        this.showNewMemberModal = false;
      },

      async createMember() {
        if (this.newMemberSaving) return;
        const email = String(this.newMember.email || '').trim();
        const first = String(this.newMember.first || '').trim();
        const last = String(this.newMember.last || '').trim();
        if (!email) { this.newMemberError = 'Email is required.'; return; }
        if (!first) { this.newMemberError = 'First name is required.'; return; }
        if (!last) { this.newMemberError = 'Last name is required.'; return; }
        this.newMemberSaving = true;
        this.newMemberError = '';
        try {
          const payload = {
            email,
            first,
            last,
            permissions: this.newMember.permissions || '',
            team: '',
            role: '',
            spanish: ''
          };
          const res = await callRpc('addRoleEntry', payload);
          this.roles = Array.isArray(res?.items) ? res.items : this.roles;
          this.teamOptions = Array.isArray(res?.teams) ? res.teams : this.teamOptions;
          this.permissionsOptions = (() => {
            const permMap = new Map();
            ['subscriber', 'editor', 'administrator'].forEach(p => permMap.set(p.toLowerCase(), p));
            this.roles.forEach(r => {
              const val = String(r.permissions || '').trim();
              if (val) permMap.set(val.toLowerCase(), val);
            });
            return Array.from(permMap.values()).sort((a, b) => a.localeCompare(b));
          })();
          this.showNewMemberModal = false;
          this.select(email);
          this.savedAt = Date.now();
        } catch (e) {
          console.error(e);
          this.newMemberError = (e && e.message) ? e.message : 'Failed to add member.';
        } finally {
          this.newMemberSaving = false;
        }
      }
    };
  }
</script>

  <script>
  function weeklyPlanApp() {
    const IS_GUEST = !!(window.__GUEST__);
    return {
      isGuest: IS_GUEST,
      showDetails: false,
      showOrder: false,
      showScripture: true,
      loadingServices: true,
      loadingOrder: false,
      // cache + persistence
      loadedOnce: false,
      existingServices: [],
      selectedServiceId: '',
      leaderChoices: [],
      preacherChoices: [],
      leaderSelect: '',
      preacherSelect: '',
      books: [],
      scripture: { book: 'John', chapter: 3, start: '1', end: '' },
      scriptureText: '',
      orderItemTypes: [],
      orderRows: [],
      // service detail autosave
      savingDetails: false,
      saveDetailsTimer: null,
      detailsError: '',
      detailsDirty: false,
      // order autosave state
      savingOrder: false,
      saveOrderTimer: null,
      saveOrderError: '',
      savedAt: 0,
      suggestOpenIndex: -1,
      suggestions: [],
      // for scripture suggestions inline dropdown
      scriptureSuggestIndex: -1,
      scriptureSuggestions: [],
      showScriptureModal: false,
      selectedScriptureRef: '',
      selectedScriptureText: '',
      selectedScriptureHtml: '',
      _passageCache: {},
      isScriptureEditing: false,
      isScriptureEditing: false,
      scriptureSearchTheme: '',
      scriptureSearchKeywords: '',
      scriptureSearchPrimary: '',
      scriptureSearchPending: false,
      scriptureSearchError: '',
      _refTimer: null,
      showSuggestModal: false,
      suggestTargetIndex: -1,
      loadingSuggestion: false,
      form: { id: '', date: '', time: '', type: '', leader: '', preacher: '', scripture: '', theme: '', keywords: '', notes: '' },
      showCreateServicesModal: false,
      batchStartDate: '',
      batchWeeks: 12,
      batchCreateLoading: false,
      batchCreateError: '',

      init() {
        const ctx = (window.APP_CTX || {});
        const defs = ctx.defaults || {};
        this.books = Array.isArray(ctx.bibleBooks) ? ctx.bibleBooks : [];
        this.orderItemTypes = Array.isArray(ctx.orderItemTypes) ? ctx.orderItemTypes : ['Welcome', 'Call To Worship', 'Song', 'Sermon', 'Communion', 'Offering', 'Announcements', 'Benediction'];
        this.leaderChoices = Array.isArray(ctx.leaderChoices) ? ctx.leaderChoices.slice() : ['Darden', 'Belinda', 'Lois'];
        const ctxPreacherChoices = Array.isArray(ctx.preacherChoices) ? ctx.preacherChoices : ctx.sermonChoices;
        this.preacherChoices = Array.isArray(ctxPreacherChoices) ? ctxPreacherChoices.slice() : ['Tom', 'Darden', 'Miguel', 'Alfredo'];

        this.form.date = this.nextSundayISO();
        this.form.time = defs.time || '10:00 AM';
        this.form.type = defs.serviceType || 'Worship';
        this.form.leader = defs.leader || 'Darden';
        this.form.preacher = defs.sermon || defs.preacher || 'Tom';
        this.leaderSelect = this.form.leader;
        this.preacherSelect = this.form.preacher;
        this.ensureSuggestStore();
        this.loadingServices = true;
        // Restore previously selected service id if present
        try { this.selectedServiceId = localStorage.getItem('wp.selectedServiceId') || ''; } catch (_) { }

        (async () => {
          try {
            const r = await callRpc('getServicePeople', null);
            if (r?.leaders) this.leaderChoices = Array.from(new Set([...this.leaderChoices, ...r.leaders])).sort((a, b) => a.localeCompare(b));
            if (r?.preachers) this.preacherChoices = Array.from(new Set([...this.preacherChoices, ...r.preachers])).sort((a, b) => a.localeCompare(b));
          } catch (e) { /* ignore */ }
          try {
            // Use server-injected services immediately, else localStorage cache
            if (Array.isArray(window.__SERVICES__) && window.__SERVICES__.length) {
              this.existingServices = window.__SERVICES__;
            } else {
              let cached = null; try { cached = JSON.parse(localStorage.getItem('wp.servicesCache') || 'null'); } catch (_) { }
              if (cached && Array.isArray(cached.items) && (Date.now() - (cached.ts || 0) < 300000)) { // 5 min TTL
                this.existingServices = cached.items;
              }
            }
            let loadedViaRpc = false;
            try {
              const s = await callRpc('listServices', null);
              if (Array.isArray(s?.items)) {
                this.existingServices = s.items;
                loadedViaRpc = true;
              }
            } catch (_) {
              // Guest mode or RPC unavailable: keep injected/cache data
            }
            if (!Array.isArray(this.existingServices) || !this.existingServices.length) {
              this.newService();
            } else if (this.selectedServiceId && !this.detailsDirty) {
              const refreshed = this.existingServices.find(svc => svc && svc.id === this.selectedServiceId);
              if (refreshed) this.applyServiceDetails(refreshed, { force: true, focus: false });
            }
            if (loadedViaRpc) {
              try { localStorage.setItem('wp.servicesCache', JSON.stringify({ ts: Date.now(), items: this.existingServices })); } catch (_) { }
            }
          } catch (_) { /* ignore */ }
          this.ensureDefaults();
          // Normalize any "Custom" labels in dropdowns (in case of encoding artifacts)
          this.$nextTick(() => {
            try { document.querySelectorAll('option[value="__custom"]').forEach(o => o.textContent = 'CustomG'); } catch (_) { }
          });
          // Auto-load previously selected service if available
          this.$nextTick(() => {
            try {
              if (!this.selectedServiceId) {
                // nothing selected yet; stay blank
                return;
              }
              // Ensure the selected ID actually exists before loading; otherwise clear it.
              const existsNow = Array.isArray(this.existingServices) && this.existingServices.some(svc => svc?.id === this.selectedServiceId);
              if (existsNow) {
                this.loadSelected();
              } else {
                this.selectedServiceId = '';
                try { localStorage.removeItem('wp.selectedServiceId'); } catch (_) { }
              }
            } catch (_) { }
          });
        })().finally(() => { this.loadingServices = false; });
      },

      ensureSuggestStore() {
        try {
          if (!window.Alpine || typeof window.Alpine.store !== 'function') return;
          if (!window.Alpine.store('suggestDefaults')) {
            window.Alpine.store('suggestDefaults', {
              seed: '',
              leader: '',
              usage: '',
              allowChristmas: true,
              updatedAt: 0
            });
          }
        } catch (_) { }
      },

      updateSuggestDefaults(index = this.suggestTargetIndex) {
        try {
          if (!window.Alpine || typeof window.Alpine.store !== 'function') return;
          if (!window.Alpine.store('suggestDefaults')) this.ensureSuggestStore();
          const store = window.Alpine.store('suggestDefaults');
          if (!store) return;
          const seed = [this.form.theme || '', this.form.keywords || '']
            .map(s => String(s || '').trim())
            .filter(Boolean)
            .join(', ');
          const row = index != null && index >= 0 ? this.orderRows[index] : null;
          const payload = {
            seed,
            leader: String(this.form.leader || ''),
            usage: this.usageFromItemType(String(row?.itemType || '')),
            allowChristmas: this.isAdventChristmas(this.form.date),
            updatedAt: Date.now()
          };
          Object.assign(store, payload);
        } catch (_) { }
      },

      nextSundayISO() {
        const now = new Date();
        const day = now.getDay();
        const add = (7 - day) % 7 || 7; // upcoming Sunday
        const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() + add);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${dd}`;
      },

      // Find the last service date in the Services sheet and return the following Sunday (ISO)
      nextServiceDateFromExistingISO() {
        try {
          if (!Array.isArray(this.existingServices) || this.existingServices.length === 0) return this.nextSundayISO();
          // existingServices are sorted by ServiceID desc; try first with a valid date
          let latest = null;
          for (const s of this.existingServices) {
            const ds = String(s?.date || '').trim();
            if (!/^\d{4}-\d{2}-\d{2}$/.test(ds)) continue;
            const [y, m, d] = ds.split('-').map(Number);
            const dt = new Date(y, m - 1, d);
            if (!latest || dt > latest) latest = dt;
          }
          if (!latest) return this.nextSundayISO();
          // add 7 days to get the next Sunday after the latest
          const nxt = new Date(latest.getFullYear(), latest.getMonth(), latest.getDate() + 7);
          const y = nxt.getFullYear();
          const m = String(nxt.getMonth() + 1).padStart(2, '0');
          const dd = String(nxt.getDate()).padStart(2, '0');
          return `${y}-${m}-${dd}`;
        } catch (_) {
          return this.nextSundayISO();
        }
      },

      // Determine default service type from an ISO date string.
      // Communion on 1st, 3rd, 5th Sundays; Offering on 2nd and 4th.
      defaultServiceTypeForDateISO(iso) {
        try {
          if (!/^\d{4}-\d{2}-\d{2}$/.test(String(iso))) return 'Offering';
          const [y, m, d] = String(iso).split('-').map(Number);
          const dt = new Date(y, m - 1, d);
          // nth week index within the month (1..5)
          const nth = Math.floor((dt.getDate() - 1) / 7) + 1;
          return (nth === 1 || nth === 3 || nth === 5) ? 'Communion' : 'Offering';
        } catch (_) {
          return 'Offering';
        }
      },

      openCreateServicesModal() {
        this.batchCreateError = '';
        const next = this.nextServiceDateFromExistingISO();
        this.batchStartDate = /^\d{4}-\d{2}-\d{2}$/.test(String(this.batchStartDate || '')) ? this.batchStartDate : next;
        if (!this.batchStartDate) this.batchStartDate = next;
        if (!this.batchWeeks || this.batchWeeks < 1) this.batchWeeks = 12;
        this.showCreateServicesModal = true;
        this.$nextTick(() => {
          try { this.$refs.batchWeeks?.focus(); } catch (_) { }
        });
      },

      closeCreateServicesModal() {
        if (this.batchCreateLoading) return;
        this.showCreateServicesModal = false;
      },

      async submitBatchCreate() {
        const start = String(this.batchStartDate || '').trim();
        const weeks = Number(this.batchWeeks) || 0;
        if (!/^\d{4}-\d{2}-\d{2}$/.test(start)) {
          this.batchCreateError = 'Select a valid start Sunday (YYYY-MM-DD).';
          return;
        }
        if (weeks < 1) {
          this.batchCreateError = 'Enter how many weeks to create.';
          return;
        }
        this.batchCreateLoading = true;
        this.batchCreateError = '';
        try {
          const res = await callRpc('createServicesBatch', { startDate: start, weeks });
          const created = Array.isArray(res?.created) ? res.created : [];
          if (created.length) {
            notify(`Created ${created.length} new service${created.length === 1 ? '' : 's'}.`, 'success');
          } else {
            notify('All requested services already exist.', 'info');
          }
          await this.refreshServices();
          this.showCreateServicesModal = false;
        } catch (e) {
          console.error(e);
          const msg = (e && e.message) ? e.message : 'Unable to create services';
          this.batchCreateError = msg;
          notify(msg, 'error');
        } finally {
          this.batchCreateLoading = false;
        }
      },

      async refreshServices() {
        this.loadingServices = true;
        try {
          const s = await callRpc('listServices', null);
          this.existingServices = Array.isArray(s?.items) ? s.items : [];
          try { localStorage.setItem('wp.servicesCache', JSON.stringify({ ts: Date.now(), items: this.existingServices })); } catch (_) { }
        } catch (err) {
          console.error(err);
        } finally {
          this.loadingServices = false;
        }
      },

      newService() {
        const ctx = (window.APP_CTX || {}); const d = ctx.defaults || {};
        try {
          if (this.saveDetailsTimer) {
            clearTimeout(this.saveDetailsTimer);
            this.saveDetailsTimer = null;
          }
        } catch (_) { }
        this.detailsDirty = false;
        this.detailsError = '';
        this.savingDetails = false;
        this.selectedServiceId = '';
        const nextDate = this.nextServiceDateFromExistingISO();
        const defType = this.defaultServiceTypeForDateISO(nextDate);
        this.form = { id: '', date: nextDate, time: (d.time || '10:00 AM'), type: defType, leader: (d.leader || 'Darden'), preacher: (d.preacher || d.sermon || 'Tom'), scripture: '', theme: '', keywords: '', notes: '' };
        this.ensureDefaults();
        this.scripture = { book: 'John', chapter: 3, start: '1', end: '' };
        this.form.scripture = '';
        this.scriptureText = '';
        this.orderRows = [];
        this.showOrder = false;
        this.showScripture = true;
        this.showDetails = true;
        this.$nextTick(() => {
          if (this.$refs.dateInput) try { this.$refs.dateInput.focus(); } catch (_) { }
        });
      },

      async deleteSelectedService() {
        try {
          const id = String(this.selectedServiceId || '').trim();
          if (!id) { notify('Select a service first', 'info'); return; }
          if (!confirm('Delete this service and its order?')) return;
          await callRpc('deleteService', { id });
          // Refresh list
          this.loadingServices = true;
          try {
            const s = await callRpc('listServices', null);
            this.existingServices = Array.isArray(s?.items) ? s.items : this.existingServices;
          } catch (_) { /* ignore */ } finally {
            this.loadingServices = false;
          }
          // Clear current form
          this.selectedServiceId = '';
          this.form = { id: '', date: this.nextSundayISO(), time: (window.APP_CTX?.defaults?.time || '10:00 AM'), type: (window.APP_CTX?.defaults?.serviceType || 'Worship'), leader: (window.APP_CTX?.defaults?.leader || ''), preacher: (window.APP_CTX?.defaults?.preacher || window.APP_CTX?.defaults?.sermon || ''), scripture: '', theme: '', keywords: '', notes: '' };
          this.orderRows = [];
          this.showOrder = false;
          notify('Service deleted.', 'success');
        } catch (e) {
          console.error(e);
          notify('Failed to delete service', 'error');
        }
      },

      async submit() {
        try {
          const isEdit = !!this.selectedServiceId;
          const payload = { ...this.form, scriptureText: this.scriptureText };
          if (isEdit) payload.id = this.selectedServiceId;
          const res = await callRpc(isEdit ? 'saveService' : 'addService', payload);
          const newId = (res && res.id) ? res.id : '';
          notify(isEdit ? 'Service saved.' : 'Service added.', 'success');
          this.loadingServices = true;
          try {
            const s = await callRpc('listServices', null);
            this.existingServices = Array.isArray(s?.items) ? s.items : this.existingServices;
          } catch (_) { /* ignore */ } finally {
            this.loadingServices = false;
          }
          if (newId) this.selectedServiceId = newId;
          this.detailsDirty = false;
          this.detailsError = '';
          if (!this.orderRows || this.orderRows.length === 0) {
            this.orderRows = this.defaultOrderFor(this.form.type);
            this.ensureOrderOptionsFromRows();
            this.showOrder = true;
            this.showScripture = false;
            // Persist initial default order to ServiceItems immediately
            this.queueSaveOrder(true);
          } else {
            try {
              const sid = this.selectedServiceId || newId;
              if (sid) await callRpc('saveOrder', { serviceId: sid, items: this.serializedOrder() });
            } catch (e2) { console.error(e2); notify('Saved service, but failed to save order.', 'error'); }
          }
        } catch (e) {
          console.error(e);
          const msg = (e && e.message) ? e.message : 'Failed to save service';
          notify(msg, 'error');
        }
      },

      applyServiceDetails(svc, opts = {}) {
        if (!svc) return;
        const { force = false, focus = false, resetDirty = false } = opts || {};
        if (!force && this.detailsDirty) return;
        const defaults = (window.APP_CTX && window.APP_CTX.defaults) || {};
        const fallbackTime = defaults.time || '10:00 AM';
        const fallbackType = defaults.serviceType || 'Worship';
        const fallbackLeader = defaults.leader || 'Darden';
        const fallbackPreacher = defaults.preacher || defaults.sermon || 'Tom';
        this.form.id = svc.id || '';
        this.form.date = svc.date || this.nextSundayISO();
        this.form.time = svc.time || fallbackTime;
        this.form.type = svc.type || fallbackType;
        this.form.leader = svc.leader || fallbackLeader;
        this.form.preacher = svc.preacher || fallbackPreacher;
        this.form.scripture = svc.scripture || '';
        this.scriptureText = svc.scriptureText || '';
        this.form.theme = svc.theme || '';
        this.form.keywords = svc.keywords || '';
        this.form.notes = svc.notes || '';
        this.leaderSelect = this.leaderChoices.includes(this.form.leader) ? this.form.leader : '__custom';
        this.preacherSelect = this.preacherChoices.includes(this.form.preacher) ? this.form.preacher : '__custom';
        if (resetDirty) this.detailsDirty = false;
        this.$nextTick(() => {
          try {
            if (focus && this.$refs.dateInput) this.$refs.dateInput.focus();
          } catch (_) { }
          if (this.$refs.leaderSel) this.$refs.leaderSel.value = this.leaderSelect;
          if (this.$refs.preacherSel) this.$refs.preacherSel.value = this.preacherSelect;
        });
      },

      loadSelected() {
        try {
          if (this.saveDetailsTimer) {
            clearTimeout(this.saveDetailsTimer);
            this.saveDetailsTimer = null;
          }
        } catch (_) { }
        this.detailsDirty = false;
        this.detailsError = '';
        this.savingDetails = false;
        const svc = this.existingServices.find(s => s.id === this.selectedServiceId);
        if (!svc) return notify('Select a service first', 'info');
        this.applyServiceDetails(svc, { force: true, focus: true, resetDirty: true });
        this.loadingOrder = true;
        (async () => {
          try {
            const r = await callRpc('getOrder', this.selectedServiceId);
            this.orderRows = Array.isArray(r?.items) && r.items.length ? r.items : this.defaultOrderFor(this.form.type);
          } catch (_) {
            this.orderRows = this.defaultOrderFor(this.form.type);
          }
          this.ensureOrderOptionsFromRows();
          this.showOrder = true;
        })().finally(() => { this.loadingOrder = false; });
        try { localStorage.setItem('wp.selectedServiceId', this.selectedServiceId || ''); } catch (_) { }
        this.showDetails = true;
        // Hide scripture section when loading an existing service
        this.showScripture = false;
      },

      chapterCountFor(bookName) {
        const e = this.books.find(b => b[0] === bookName);
        return e ? e[1] : 50;
      },

      scriptureRef() {
        const b = this.scripture.book;
        const c = this.scripture.chapter;
        const s = String(this.scripture.start || '').trim();
        const e = String(this.scripture.end || '').trim();
        if (!s && !e) return `${b} ${c}`;
        if (s && !e) return `${b} ${c}:${s}`;
        return `${b} ${c}:${s}-${e}`;
      },

      ensureDefaults() {
        const d = (window.APP_CTX && window.APP_CTX.defaults) || {};
        const defLeader = d.leader || 'Darden';
        const defPreacher = d.preacher || d.sermon || 'Tom';
        if (!this.leaderChoices.includes(defLeader)) this.leaderChoices = [defLeader, ...this.leaderChoices];
        if (!this.preacherChoices.includes(defPreacher)) this.preacherChoices = [defPreacher, ...this.preacherChoices];
        this.leaderSelect = defLeader;
        this.preacherSelect = defPreacher;
        this.form.leader = defLeader;
        this.form.preacher = defPreacher;
        this.$nextTick(() => {
          if (this.$refs.leaderSel) this.$refs.leaderSel.value = defLeader;
          if (this.$refs.preacherSel) this.$refs.preacherSel.value = defPreacher;
        });
      },

      async fetchScripture() {
        try {
          const ref = String(this.form.scripture || '').trim();
          if (!ref) { this.scriptureText = ''; return; }
          const prev = this.scriptureText;
          const r = await callRpc('esvPassage', { reference: ref });
          if (r && r.error) {
            notify(String(r.error), 'error', 3200);
            this.scriptureText = prev; // preserve existing text
            return;
          }
          const txt = (r && r.text) ? String(r.text) : '';
          if (!txt.trim()) {
            notify('No passage found - check the reference.', 'error', 2600);
            this.scriptureText = prev;
          } else {
            this.scriptureText = txt;
            // Auto-generate keywords from scripture text
            try { this.form.keywords = this.extractKeywords(txt); } catch (_) { }
            this.queueSaveDetails(true);
          }
        } catch (e) {
          console.error(e);
          const msg = (e && e.message) ? e.message : 'Failed to fetch scripture text';
          notify(msg, 'error', 3200);
        }
      },

      // Create a comma-separated keyword list from passage text
      extractKeywords(text) {
        const s = String(text || '').toLowerCase();
        if (!s) return '';
        // Tokenize words
        const tokens = s.replace(/[^a-z\s']/g, ' ').split(/\s+/).map(t => t.replace(/^'+|'+$/g, '')).filter(Boolean);
        if (!tokens.length) return '';
        // Stop words (expanded with pronouns/prepositions like him, whoever, into)
        const stop = new Set([
          'the', 'and', 'of', 'to', 'in', 'that', 'it', 'is', 'for', 'on', 'with', 'as', 'at', 'by', 'be', 'he', 'she', 'they', 'we', 'you', 'i', 'a', 'an', 'from', 'this', 'these', 'those', 'are', 'was', 'were', 'his', 'her', 'their', 'our', 'your', 'but', 'not', 'so', 'or', 'if', 'then', 'there', 'here', 'who', 'whom', 'which', 'what', 'when', 'where', 'why', 'how', 'have', 'has', 'had', 'do', 'did', 'does', 'will', 'would', 'shall', 'should', 'can', 'could', 'may', 'might', 'let', 'us',
          'him', 'them', 'me', 'my', 'mine', 'yours', 'ours', 'hers', 'theirs', 'whoever', 'whosoever', 'whomever', 'whose', 'into', 'unto', 'onto', 'upon', 'within', 'without', 'among', 'between', 'before', 'after', 'above', 'below', 'over', 'under', 'again', 'also', 'all', 'any', 'each', 'every', 'some', 'no', 'nor', 'one', 'thing', 'things', 'because'
        ]);
        // Lemmatization + grouping without truncation
        const lemma = (w) => {
          if (!w) return '';
          // groups
          if (/^bright(?:ness)?$/.test(w) || /^shine(?:s|r|rs|d|ing)?$/.test(w)) return 'light';
          if (/^light(?:s|er|est|ness)?$/.test(w)) return 'light';
          if (/^dark(?:ness|er|est|s)?$/.test(w)) return 'darkness';
          if (/^judg(?:e|es|ed|ing|ment|ments)$/.test(w) || /^condemn(?:ed|s|ing|ation|ations)?$/.test(w)) return 'judgment';
          if (/^believ(?:e|es|ed|ing|er|ers)?$/.test(w)) return 'believe';
          if (/^baptiz(?:e|es|ed|ing)?$/.test(w) || /^baptism(?:s)?$/.test(w) || /^baptist(?:s)?$/.test(w)) return 'baptism';
          if (/^come(?:s|r|rs|ing)?$/.test(w) || w === 'came') return 'come';
          // Gentle plural handling
          if (w.length > 4 && /s$/.test(w)) return w.replace(/s$/, '');
          return w;
        };
        const counts = new Map();
        for (const t of tokens) {
          if (stop.has(t) || t.length < 3) continue;
          const k = lemma(t);
          if (!k || stop.has(k) || k.length < 3) continue;
          counts.set(k, (counts.get(k) || 0) + 1);
        }
        const top = Array.from(counts.entries()).sort((a, b) => b[1] - a[1]).slice(0, 12).map(([k]) => k);
        // Pretty case
        const pretty = (w) => w.replace(/^\w/, c => c.toUpperCase());
        return top.map(pretty).join(', ');
      },

      formattedDateTime() {
        const dateStr = String(this.form?.date || '').trim();
        const timeStr = String(this.form?.time || '').trim();
        const idStr = String(this.form?.id || '').trim();
        let prettyDate = '';
        let prettyTime = '';

        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          try {
            const [y, m, d] = dateStr.split('-').map(Number);
            prettyDate = new Intl.DateTimeFormat('en-US', {
              month: 'long',
              day: 'numeric',
              year: 'numeric'
            }).format(new Date(y, m - 1, d));
          } catch (_) {
            prettyDate = dateStr;
          }
        } else {
          prettyDate = dateStr;
        }

        if (timeStr) {
          const match = timeStr.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/i);
          if (match) {
            const minutes = match[2] || '00';
            const meridiem = match[3].toUpperCase();
            const hour = parseInt(match[1], 10);
            prettyTime = minutes !== '00' ? `${hour}:${minutes} ${meridiem}` : `${hour} ${meridiem}`;
          } else {
            prettyTime = timeStr;
          }
        }

        const idTime = (() => {
          if (!idStr) return '';
          const m = idStr.match(/_(\d{1,2})(?::?(\d{2}))?(am|pm)\b/i);
          if (!m) return '';
          const hour = parseInt(m[1], 10);
          const minutes = m[2] || '';
          const meridiem = m[3].toUpperCase();
          return minutes ? `${hour}:${minutes} ${meridiem}` : `${hour} ${meridiem}`;
        })();

        const normalize = (s) => String(s || '').replace(/[^0-9a-z]/gi, '').toLowerCase();
        if (!prettyTime && idTime) {
          prettyTime = idTime;
        } else if (prettyTime && idTime && normalize(prettyTime) !== normalize(idTime)) {
          prettyTime = idTime;
        }

        return { date: prettyDate, time: prettyTime };
      },

      formattedDateTimeHtml() {
        const { date, time } = this.formattedDateTime();
        return [date, time].filter(Boolean).join('<br>');
      },

      formattedDateTimePlain() {
        const { date, time } = this.formattedDateTime();
        return [date, time].filter(Boolean).join(' ');
      },


      // Order helpers
      defaultOrderFor(serviceType) {
        const t = String(serviceType || '').toLowerCase();
        const tmpl = (window.APP_CTX && window.APP_CTX.orderTemplates) || {};
        const src = t.includes('communion') ? tmpl.communion : t.includes('offering') ? tmpl.offering : (tmpl.offering || []);
        const arr = Array.isArray(src) ? src : [];
        const leaderName = this.form?.leader || '';
        const preacherName = this.form?.preacher || '';
        const sub = (s) => {
          const v = String(s || '');
          if (!v) return '';
          return v.replace('{leader}', leaderName).replace('{preacher}', preacherName);
        };
        return arr.map((it, idx) => ({
          order: idx + 1,
          itemType: String(it.itemType || ''),
          detail: it.detail || '',
          leader: sub(it.leader),
          notes: it.notes || ''
        }));
      },
      addOrderRow() {
        const n = this.orderRows.length + 1;
        this.orderRows.push({ order: n, itemType: '', detail: '', leader: '', notes: '' });
        this.queueSaveOrder(true);
      },
      removeOrderRow(i) {
        this.orderRows.splice(i, 1);
        this.orderRows.forEach((r, idx) => (r.order = idx + 1));
        this.queueSaveOrder(true);
      },
      moveOrderRow(i, dir) {
        const j = i + dir;
        if (j < 0 || j >= this.orderRows.length) return;
        const tmp = this.orderRows[i];
        this.orderRows[i] = this.orderRows[j];
        this.orderRows[j] = tmp;
        this.orderRows.forEach((r, idx) => (r.order = idx + 1));
        this.queueSaveOrder(true);
      },
      serializedOrder() {
        return this.orderRows.map((r, idx) => ({ order: idx + 1, itemType: r.itemType || '', detail: r.detail || '', scriptureText: r.scriptureText || '', leader: r.leader || '', notes: r.notes || '' }));
      },

      slotFor(i) {
        const t = String(this.orderRows[i]?.itemType || '').toLowerCase();
        return t;
      },
      async suggestForRow(i) {
        if (this.loadingSuggestion) return;
        this.loadingSuggestion = true;
        this.suggestTargetIndex = i;
        try {
          const t = String(this.orderRows[i]?.itemType || '').toLowerCase();
          const isScripture = t.includes('scripture') || t.includes('call to worship');
          if (!isScripture) {
            // Song suggestion via modal (existing behavior)
            this.suggestOpenIndex = i;
            this.suggestTargetIndex = i;
            const slot = this.slotFor(i);
            const theme = String(this.form.theme || '');
            const scripture = String(this.scriptureText || this.form.scripture || '');
            const res = await callRpc('suggestSongs', { theme, scripture, slot, k: 6 });
            this.suggestions = Array.isArray(res?.items) ? res.items : [];
            this.updateSuggestDefaults(i);
            this.showSuggestModal = true;
            return;
          }

          // Scripture suggestions based on adjacent songs or service context
          const neighbors = this.adjacentSongs(i);
          const names = neighbors.filter(Boolean);
          const refs = new Set();
          let songPayload = [];
          if (names.length) {
            const songs = await this.getSongsCache();
            const findRow = (name) => this.findSongRowByName(name, songs);
            for (const n of names) {
              const row = findRow(n);
              const scr = row ? this.field(row, ['scriptures', 'scripture refs', 'scripture']) : '';
              scr.split(/[,;|\n]+/).map(s => s.trim()).filter(Boolean).forEach(v => refs.add(v));
            }
            try {
              const fetch = await callRpc('getSongFields', { names, fields: ['Lyrics', 'Themes'] });
              const items = Array.isArray(fetch?.items) ? fetch.items : [];
              songPayload = names.map(n => {
                const it = items.find(x => String(x?.name || '').toLowerCase() === String(n).toLowerCase()) || items.find(x => String(x?.name || '').toLowerCase().includes(String(n).toLowerCase())) || null;
                const lyrics = it && it.fields ? String(it.fields['Lyrics'] || '') : '';
                return { name: n, lyrics };
              });
              try {
                const withLyrics = songPayload.filter(s => (s.lyrics || '').trim()).length;
                notify(`AI payload songs: ${songPayload.length}, with lyrics: ${withLyrics}`, 'info', 1200);
              } catch (_) { }
            } catch (err) {
              console.error('Failed to pull song lyrics for scripture ideas', err);
            }
          } else {
            try { notify('Using service theme and keywords for scripture ideas.', 'info', 1600); } catch (_) { }
          }

          if (songPayload.length) {
            try {
              const lyricRefs = await this.requestScriptureIdeas({
                songs: songPayload,
                theme: this.form.theme,
                keywords: this.form.keywords,
                primaryScripture: this.form.scripture,
                reason: 'lyrics',
                limit: 12
              });
              lyricRefs.forEach(v => refs.add(String(v)));
              try { notify(`AI refs from lyrics: ${lyricRefs.length}`, 'info', 1400); } catch (_) { }
            } catch (err) {
              console.error('AI lyric scripture fetch failed', err);
            }
          }

          if (!refs.size) {
            try {
              const fallbackRefs = await this.requestScriptureIdeas({
                songs: [],
                theme: this.form.theme,
                keywords: this.form.keywords,
                primaryScripture: this.form.scripture,
                reason: songPayload.length ? 'lyrics-fallback' : 'context',
                limit: 12
              });
              fallbackRefs.forEach(v => refs.add(String(v)));
              if (fallbackRefs.length) {
                try { notify(`AI refs from service context: ${fallbackRefs.length}`, 'info', 1600); } catch (_) { }
              }
            } catch (err) {
              console.error('AI fallback scripture fetch failed', err);
            }
          }

          const seedRefs = Array.from(refs.values());
          const additions = this.mergeScriptureSuggestions(seedRefs, { reset: true });
          this.scriptureSuggestIndex = i;
          this.prepareScriptureSearchDefaults();
          let defaultRef = additions[0] || String(this.orderRows[i]?.detail || '').trim() || this.mainScriptureRef();
          if (!defaultRef && this.scriptureSuggestions.length) defaultRef = this.scriptureSuggestions[0];
          this.openScriptureModal({ defaultRef, autoFetch: !!defaultRef });
          if (!this.scriptureSuggestions.length && !defaultRef) {
            this.scriptureSearchError = 'No ideas yet. Adjust theme/keywords and try again.';
          }
        } catch (e) {
          console.error(e);
          notify('Failed to build suggestions', 'error');
        } finally {
          this.loadingSuggestion = false;
        }
      },

      adjacentSongs(i) {
        const isSong = (t) => /song\b|closing song|opening song|communion song|offering song/i.test(String(t || ''));
        let prev = '', next = '';
        for (let j = i - 1; j >= 0; j--) { const r = this.orderRows[j]; if (r && isSong(r.itemType) && String(r.detail || '').trim()) { prev = String(r.detail); break; } }
        for (let j = i + 1; j < this.orderRows.length; j++) { const r = this.orderRows[j]; if (r && isSong(r.itemType) && String(r.detail || '').trim()) { next = String(r.detail); break; } }
        return [prev, next];
      },

      async getSongsCache() {
        if (Array.isArray(this._songsCache)) return this._songsCache;
        try { const r = await callRpc('getSongsForView', null); this._songsCache = Array.isArray(r) ? r : []; } catch (_) { this._songsCache = []; }
        return this._songsCache;
      },

      applyScriptureSuggestion(i, ref) {
        try { this.orderRows[i].detail = String(ref || ''); this.scriptureSuggestIndex = -1; this.scriptureSuggestions = []; } catch (_) { }
        this.queueSaveOrder(true);
      },

      prepareScriptureSearchDefaults() {
        this.scriptureSearchTheme = String(this.form.theme || '');
        this.scriptureSearchKeywords = String(this.form.keywords || '');
        this.scriptureSearchPrimary = this.mainScriptureRef();
        this.scriptureSearchError = '';
      },

      async requestScriptureIdeas({ songs = [], theme = '', keywords = '', primaryScripture = '', reason = 'manual', limit = 12 } = {}) {
        const payload = {
          songs: Array.isArray(songs) ? songs : [],
          theme: String(theme || ''),
          keywords: String(keywords || ''),
          primaryScripture: String(primaryScripture || ''),
          k: Number.isFinite(limit) ? limit : 12,
          reason
        };
        const res = await callRpc('aiScripturesForLyrics', payload);
        const refs = Array.isArray(res?.refs) ? res.refs : [];
        return refs.map(r => String(r || '').trim()).filter(Boolean);
      },

      async refreshScriptureIdeas(reason = 'manual') {
        if (this.scriptureSearchPending) return;
        this.scriptureSearchError = '';
        this.scriptureSearchPending = true;
        try {
          const refs = await this.requestScriptureIdeas({
            songs: [],
            theme: this.scriptureSearchTheme || this.form.theme,
            keywords: this.scriptureSearchKeywords || this.form.keywords,
            primaryScripture: this.scriptureSearchPrimary || this.form.scripture,
            reason,
            limit: 16
          });
          const additions = this.mergeScriptureSuggestions(refs, { reset: false });
          if (additions.length) {
            this.selectedScriptureRef = additions[0];
            this.selectedScriptureText = '';
            this.selectedScriptureHtml = '';
            this.$nextTick(() => this.fetchPassage(this.selectedScriptureRef));
            this.isScriptureEditing = false;
          } else if (!this.selectedScriptureRef) {
            const fallbackRef = this.scriptureSuggestions[0] || this.mainScriptureRef();
            if (fallbackRef) {
              this.selectedScriptureRef = fallbackRef;
              this.$nextTick(() => this.fetchPassage(this.selectedScriptureRef));
              this.isScriptureEditing = false;
            } else {
              this.selectedScriptureHtml = '';
              this.isScriptureEditing = true;
            }
          }
          if (!additions.length) {
            if (!this.scriptureSuggestions.length) {
              this.scriptureSearchError = 'No passages returned. Try adjusting keywords or theme.';
            } else {
              this.scriptureSearchError = 'No new passages returned; existing references kept.';
            }
          }
        } catch (err) {
          const msg = (err && err.message) ? err.message : 'Failed to fetch scripture ideas';
          this.scriptureSearchError = msg;
          try { if (typeof notify === 'function') notify(msg, 'error'); } catch (_) { }
        } finally {
          this.scriptureSearchPending = false;
        }
      },

      openScriptureModal({ defaultRef = '', autoFetch = true } = {}) {
        try {
          this.selectedScriptureRef = String(defaultRef || '');
          const cached = this.selectedScriptureRef && this._passageCache ? this._passageCache[this.selectedScriptureRef] : null;
          if (cached) {
            this.selectedScriptureText = String(cached.text || '');
            this.selectedScriptureHtml = String(cached.html || '');
          } else {
            this.selectedScriptureText = '';
            this.selectedScriptureHtml = '';
          }
          this.showScriptureModal = true;
          this.isScriptureEditing = !this.selectedScriptureHtml && !!this.selectedScriptureText;
          if (!this.selectedScriptureRef) this.isScriptureEditing = true;
          if (autoFetch && this.selectedScriptureRef) {
            this.$nextTick(() => { this.fetchPassage(this.selectedScriptureRef); });
          }
        } catch (_) { this.showScriptureModal = true; }
      },

      async fetchPassage(ref) {
        const key = String(ref || '').trim();
        const wasEditing = this.isScriptureEditing;
        if (!key) {
          this.selectedScriptureText = '';
          this.selectedScriptureHtml = '';
          this.isScriptureEditing = true;
          return;
        }
        const cached = this._passageCache && this._passageCache[key];
        if (cached) {
          this.selectedScriptureText = String(cached.text || '');
          this.selectedScriptureHtml = String(cached.html || '');
          this.isScriptureEditing = wasEditing;
          return;
        }
        try {
          const r = await callRpc('esvPassage', { reference: key });
          const txt = (r && r.text) ? String(r.text) : '';
          const html = (r && r.html) ? String(r.html) : '';
          this.selectedScriptureText = txt;
          this.selectedScriptureHtml = html;
          try { this._passageCache[key] = { text: txt, html }; } catch (_) { }
          this.isScriptureEditing = wasEditing;
        } catch (err) {
          console.error('Failed to fetch passage', err);
          this.selectedScriptureText = '';
          this.selectedScriptureHtml = '';
          this.isScriptureEditing = true;
        }
      },

      chooseScripture() {
        const i = this.scriptureSuggestIndex;
        if (i < 0) { this.showScriptureModal = false; return; }
        const ref = String(this.selectedScriptureRef || '');
        if (ref) {
          this.applyScriptureSuggestion(i, ref);
          try { this.orderRows[i].scriptureText = String(this.selectedScriptureText || ''); } catch (_) { }
          this.queueSaveOrder(true);
        }
        this.showScriptureModal = false;
      },

      toggleScriptureEditing() {
        this.isScriptureEditing = !this.isScriptureEditing;
        if (this.isScriptureEditing) {
          this.$nextTick(() => {
            try {
              const el = this.$refs?.scriptureEditor;
              if (el && typeof el.focus === 'function') el.focus();
            } catch (_) { }
          });
        }
      },

      refChanged() {
        try { if (this._refTimer) clearTimeout(this._refTimer); } catch (_) { }
        this.selectedScriptureHtml = '';
        if (!this.isScriptureEditing) this.selectedScriptureText = '';
        this._refTimer = setTimeout(() => this.fetchPassage(this.selectedScriptureRef), 500);
      },

      customScriptureEdited() {
        try {
          if (this.selectedScriptureRef) {
            this._passageCache[this.selectedScriptureRef] = { text: this.selectedScriptureText || '', html: '' };
          }
        } catch (_) { }
        this.selectedScriptureHtml = '';
        this.isScriptureEditing = true;
      },

      mainScriptureRef() {
        return String(this.form?.scripture || '').trim();
      },

      normalizeRef(ref) {
        return String(ref || '').trim().replace(/\s+/g, ' ').toLowerCase();
      },

      mergeScriptureSuggestions(newRefs, { reset = false } = {}) {
        const base = reset ? [] : (Array.isArray(this.scriptureSuggestions) ? [...this.scriptureSuggestions] : []);
        const seen = new Set(base.map(r => this.normalizeRef(r)));
        const mainNorm = this.normalizeRef(this.mainScriptureRef());
        const added = [];
        for (const ref of Array.isArray(newRefs) ? newRefs : []) {
          const norm = this.normalizeRef(ref);
          if (!norm) continue;
          if (norm === mainNorm) continue;
          if (seen.has(norm)) continue;
          seen.add(norm);
          const clean = String(ref).trim();
          base.push(clean);
          added.push(clean);
        }
        this.scriptureSuggestions = base.slice(0, 40);
        return added;
      },

      // Helper to read a row field with flexible header names
      field(row, candidates) {
        if (!row) return '';
        const keys = Object.keys(row);
        const L = keys.map(k => k.toLowerCase());
        for (const cand of candidates) {
          const i = L.indexOf(String(cand).toLowerCase());
          if (i >= 0) return String(row[keys[i]] ?? '');
        }
        // fallback: partial contains match
        for (const cand of candidates) {
          const ci = L.findIndex(k => k.includes(String(cand).toLowerCase()));
          if (ci >= 0) return String(row[keys[ci]] ?? '');
        }
        return '';
      },

      normalizeTitle(s) {
        let t = String(s || '').toLowerCase();
        t = t.replace(/\([^)]*\)|\[[^\]]*\]/g, ' '); // remove () or [] content
        t = t.replace(/\+sp|\+es/g, ' ');              // drop language tags like (+Sp)
        t = t.replace(/[^a-z0-9\s]/g, ' ');
        t = t.replace(/\s+/g, ' ').trim();
        return t;
      },

      findSongRowByName(name, songs) {
        const q = this.normalizeTitle(name);
        if (!q) return null;
        let best = null; let bestScore = 0;
        for (const r of (songs || [])) {
          const t = this.normalizeTitle((r && (r.Song || r['song'] || r['Title'])) || '');
          if (!t) continue;
          if (t === q) return r; // exact
          if (t.includes(q) || q.includes(t)) {
            const sc = Math.min(t.length, q.length) / Math.max(t.length, q.length);
            if (sc > bestScore) { best = r; bestScore = sc; }
            continue;
          }
          const A = new Set(t.split(' '));
          const B = new Set(q.split(' '));
          let inter = 0; for (const x of A) if (B.has(x)) inter++;
          const union = A.size + B.size - inter;
          const j = union ? inter / union : 0;
          if (j > bestScore) { best = r; bestScore = j; }
        }
        return best;
      },

      normalizeTitle(s) {
        return String(s || '')
          .toLowerCase()
          .replace(/[^a-z0-9\s]+/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      },

      findSongRowByName(name, songs) {
        const q = this.normalizeTitle(name);
        if (!q) return null;
        let best = null; let bestScore = 0;
        for (const r of (songs || [])) {
          const t = this.normalizeTitle((r && (r.Song || r['song'] || r['Title'])) || '');
          if (!t) continue;
          if (t === q) return r; // exact
          // two-way contains
          if (t.includes(q) || q.includes(t)) {
            const sc = Math.min(t.length, q.length) / Math.max(t.length, q.length);
            if (sc > bestScore) { best = r; bestScore = sc; }
            continue;
          }
          // token overlap
          const A = new Set(t.split(' '));
          const B = new Set(q.split(' '));
          let inter = 0; for (const x of A) if (B.has(x)) inter++;
          const union = A.size + B.size - inter;
          const j = union ? inter / union : 0;
          if (j > bestScore) { best = r; bestScore = j; }
        }
        return bestScore >= 0.45 ? best : best; // return best anyway for debugging
      },
      applySuggestion(i, s) {
        const chosen = s?.name || '';
        this.orderRows[i].detail = chosen;
        this.suggestOpenIndex = -1;
        this.suggestions = [];
        this.queueSaveOrder(true);
        this.bumpSongUsage(chosen);
      },

      async bumpSongUsage(name) {
        if (this.isGuest) return;
        try {
          const songName = String(name || '').trim();
          if (!songName) return;
          const date = String(this.form?.date || '').trim();
          const res = await callRpc('updateSongUsage', { name: songName, date });
          const target = this.normalizeTitle(songName);
          const applyPatch = (row) => {
            if (!row) return;
            const title = this.normalizeTitle((row && (row.Song || row['song'] || row['Title'])) || '');
            if (title === target) {
              if (res && res.lastUsed) row.Last_Used = res.lastUsed;
              if (res && typeof res.uses === 'number') row.Uses = res.uses;
              if (res && res.years) row.Years_Used = res.years;
            }
          };
          if (Array.isArray(window.__ROWS__)) {
            window.__ROWS__.forEach(applyPatch);
          }
          const modal = this.$refs?.suggestApp;
          const store = modal && modal.__x ? modal.__x.$data : null;
          if (store) {
            try {
              if (Array.isArray(store.rows)) store.rows.forEach(applyPatch);
              if (Array.isArray(store.filtered)) store.filtered.forEach(applyPatch);
              if (typeof store.render === 'function') store.render(false);
            } catch (_) { }
          }
        } catch (e) {
          console.error('Failed to update song usage', e);
        }
      },

      isAdventChristmas(dateISO) {
        try {
          const s = String(dateISO || '').trim();
          if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return false;
          const [y, m, d] = s.split('-').map(Number);
          if (m === 12) return true;
          if (m === 11 && d >= 27) return true;
          if (m === 1 && d <= 6) return true;
          return false;
        } catch (_) {
          return false;
        }
      },

      usageFromItemType(label) {
        const s = String(label || '').toLowerCase();
        if (!s) return '';
        if (s.includes('call to worship') || s.includes('opening')) return 'Call to Worship';
        if (/\bsong\s*2\b/.test(s)) return 'Song2';
        if (/\bsong\s*3\b/.test(s)) return 'Song3';
        if (/\bsong\s*4\b/.test(s)) return 'Song4';
        if (s.includes('communion')) return 'Communion';
        if (s.includes('offering')) return 'Offering';
        if (s.includes('closing')) return 'Closing';
        return '';
      },

      ensureOrderOptionsFromRows() {
        try {
          const set = new Set(this.orderItemTypes);
          for (const r of this.orderRows) {
            const v = String(r?.itemType || '').trim();
            if (v && !set.has(v)) set.add(v);
          }
          this.orderItemTypes = Array.from(set);
        } catch (_) { }
      },

      updateCachedService(id, patch) {
        try {
          const targetId = String(id || '').trim();
          if (!targetId) return;
          let found = false;
          const next = (Array.isArray(this.existingServices) ? this.existingServices : []).map((svc) => {
            if (svc && svc.id === targetId) {
              found = true;
              return { ...svc, ...patch };
            }
            return svc;
          });
          if (found) {
            this.existingServices = next;
            try { localStorage.setItem('wp.servicesCache', JSON.stringify({ ts: Date.now(), items: next })); } catch (_) { }
            if (targetId === this.selectedServiceId) {
              const updated = next.find(svc => svc && svc.id === targetId);
              if (updated) this.applyServiceDetails(updated, { force: true, focus: false });
            }
          }
        } catch (_) { }
      },

      queueSaveDetails(immediate = false) {
        if (this.isGuest) return;
        try {
          if (this.saveDetailsTimer) {
            clearTimeout(this.saveDetailsTimer);
            this.saveDetailsTimer = null;
          }
        } catch (_) { }
        if (!this.selectedServiceId) return;
        this.detailsDirty = true;
        if (immediate) {
          this.persistDetails();
          return;
        }
        this.saveDetailsTimer = setTimeout(() => this.persistDetails(), 600);
      },

      async persistDetails() {
        if (this.isGuest) return;
        try {
          if (this.saveDetailsTimer) {
            clearTimeout(this.saveDetailsTimer);
            this.saveDetailsTimer = null;
          }
        } catch (_) { }
        if (!this.selectedServiceId) return;
        this.savingDetails = true;
        this.detailsError = '';
        const payload = { ...this.form, id: this.selectedServiceId, scriptureText: this.scriptureText };
        try {
          const res = await callRpc('saveService', payload);
          const newId = res?.id || this.selectedServiceId;
          if (newId && newId !== this.selectedServiceId) {
            this.selectedServiceId = newId;
          }
          const patch = {
            date: this.form.date,
            time: this.form.time,
            type: this.form.type,
            leader: this.form.leader,
            preacher: this.form.preacher,
            scripture: this.form.scripture,
            scriptureText: this.scriptureText,
            theme: this.form.theme,
            keywords: this.form.keywords,
            notes: this.form.notes
          };
          this.updateCachedService(newId, patch);
          this.detailsDirty = false;
          this.savedAt = Date.now();
        } catch (e) {
          console.error(e);
          const msg = (e && e.message) ? e.message : 'Failed to save service details';
          this.detailsError = msg;
          try { notify(msg, 'error'); } catch (_) { }
        } finally {
          this.savingDetails = false;
        }
      },

      actionLabel() { return 'Save Service'; },

      queueSaveOrder(immediate = false) {
        if (this.isGuest) return;
        try {
          if (this.saveOrderTimer) {
            clearTimeout(this.saveOrderTimer);
            this.saveOrderTimer = null;
          }
        } catch (_) { }
        if (!this.selectedServiceId) return; // need a service id first
        if (immediate) { this.persistOrder(); return; }
        this.saveOrderTimer = setTimeout(() => this.persistOrder(), 800);
      },

      async persistOrder() {
        if (this.isGuest) return;
        if (!this.selectedServiceId) return;
        this.savingOrder = true;
        this.saveOrderError = '';
        try {
          const sid = this.selectedServiceId;
          await callRpc('saveOrder', { serviceId: sid, items: this.serializedOrder() });
          this.savedAt = Date.now();
        } catch (e) {
          console.error(e);
          this.saveOrderError = (e && e.message) ? e.message : 'Failed to save order';
        } finally {
          this.savingOrder = false;
        }
      }
    }
  }
</script>







  <script>
  function availabilityApp() {
    return {
      email: '',
      services: [],
      selectedServiceIds: [],
      loadingServices: true,
      loadingAvailability: false,
      saving: false,
      error: '',
      statusMessage: '',
      prefilledFor: '',
      memberVerified: false,
      verifiedEmail: '',
      shareLink: '',
      emailSubject: '',
      emailBody: '',
      emailEditorOpen: false,
      isAdmin: false,
      viewerProfile: null,
      recipientLoading: false,
      recipientError: '',
      recipientTeams: [{ value: 'all', label: 'All members' }],
      recipientMembers: [],
      filteredRecipients: [],
      selectedRecipientTeam: 'all',
      selectedRecipientEmails: [],
      emailSending: false,
      emailSendStatus: '',
      emailSendError: '',

      init() {
        this.prepareEmailTemplate();
        this.loadViewerProfile();
        this.fetchServices();
        try {
          const params = new URLSearchParams(location.search || '');
          const emailParam = params.get('email');
          if (emailParam) {
            this.email = emailParam;
            this.prefillAvailability(true);
          }
        } catch (_) { /* ignore */ }
      },

      async loadViewerProfile() {
        try {
          const profile = await callRpc('getViewerProfile', null);
          this.viewerProfile = profile || null;
          this.isAdmin = Boolean(profile?.isAdmin);
          if (this.isAdmin) {
            this.loadEmailRecipients();
          }
        } catch (e) {
          console.error(e);
          this.viewerProfile = null;
          this.isAdmin = false;
        }
      },

      prepareEmailTemplate() {
        this.shareLink = this.availabilityShareUrl();
        this.emailSubject = this.normalizeEmailSubject(this.emailSubject);
        if (!this.emailBody) {
          this.emailBody = `Hi team,\n\nPlease record your upcoming availability here:\n${this.shareLink}\n\nThank you!`;
        }
      },

      availabilityShareUrl() {
        const fallbackBase = `${location.origin}${location.pathname}`;
        const base = this.preferredShareBase() || fallbackBase;
        try {
          const url = new URL(base);
          url.searchParams.set('mode', 'guest');
          url.searchParams.set('tab', 'availability');
          if (!url.hash || url.hash === '#') {
            url.hash = '#/availability';
          }
          return url.toString();
        } catch (_) {
          const join = base.includes('?') ? '&' : '?';
          return `${base}${join}mode=guest&tab=availability#/availability`;
        }
      },

      preferredShareBase() {
        try {
          const { origin, pathname } = window.location || {};
          const locationBase = origin && pathname ? `${origin}${pathname}` : '';
          const path = String(pathname || '');
          if (!window.__BASE__) {
            return locationBase;
          }
          if (/\/dev(\/|$)/.test(path) || /localhost/i.test(String(origin || ''))) {
            return locationBase;
          }
          return window.__BASE__ || locationBase;
        } catch (_) {
          return window.__BASE__ || '';
        }
      },

      async copyShareLink() {
        await this.copyToClipboard(this.shareLink || '', 'Share link copied.');
      },

      async copyEmailSubject() {
        this.emailSubject = this.normalizeEmailSubject(this.emailSubject);
        await this.copyToClipboard(this.emailSubject, 'Subject copied.');
      },

      async copyEmailBody() {
        await this.copyToClipboard(this.emailBody || '', 'Email text copied.');
      },

      async copyRecipientEmails() {
        await this.copyToClipboard(this.selectedRecipientEmails.join(', '), 'Recipient emails copied.');
      },

      async sendAvailabilityEmail() {
        if (!this.selectedRecipientEmails.length) {
          notify('Select at least one recipient.', 'error');
          return;
        }
        this.emailSubject = this.normalizeEmailSubject(this.emailSubject);
        const subject = this.emailSubject;
        const body = String(this.emailBody || '').trim();
        if (!body) {
          this.emailSendError = 'Email text is required.';
          return;
        }
        this.emailSending = true;
        this.emailSendStatus = '';
        this.emailSendError = '';
        try {
          const res = await callRpc('sendAvailabilityEmail', {
            subject,
            body,
            recipients: this.selectedRecipientEmails
          });
          const count = res?.sent ?? this.selectedRecipientEmails.length;
          this.emailSendStatus = `Email sent to ${count} recipient${count === 1 ? '' : 's'}.`;
          notify('Availability email sent.', 'success');
        } catch (e) {
          console.error(e);
          this.emailSendError = (e && e.message) ? e.message : 'Unable to send email.';
        } finally {
          this.emailSending = false;
        }
      },

      normalizeEmailSubject(value) {
        const trimmed = String(value || '').trim();
        const fallback = 'Please update your availability';
        const base = trimmed || fallback;
        return base.startsWith('') ? base : ` ${base}`;
      },

      async copyToClipboard(text, successMsg = 'Copied.') {
        if (!text) {
          notify('Nothing to copy.', 'error');
          return;
        }
        try {
          if (navigator?.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.setAttribute('readonly', 'true');
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            textarea.remove();
          }
          notify(successMsg, 'success');
        } catch (err) {
          console.error(err);
          notify('Unable to copy to clipboard.', 'error');
        }
      },

      async loadEmailRecipients() {
        this.recipientLoading = true;
        this.recipientError = '';
        try {
          const res = await callRpc('listRoles', null);
          const items = Array.isArray(res?.items) ? res.items : [];
          const members = items
            .map(row => {
              const email = String(row?.email || '').trim().toLowerCase();
              if (!email) return null;
              const first = String(row?.first || '').trim();
              const last = String(row?.last || '').trim();
              const teams = Array.isArray(row?.teams)
                ? row.teams.filter(Boolean)
                : String(row?.teamRaw || '')
                    .split(/[,;|]/)
                    .map(v => v.trim())
                    .filter(Boolean);
              return {
                email,
                name: [first, last].filter(Boolean).join(' '),
                teams
              };
            })
            .filter(Boolean)
            .sort((a, b) => {
              const nameA = a.name || a.email;
              const nameB = b.name || b.email;
              return nameA.localeCompare(nameB);
            });
          const teamSet = new Set();
          members.forEach(m => {
            if (!Array.isArray(m.teams) || !m.teams.length) return;
            m.teams.forEach(team => {
              if (team) teamSet.add(team);
            });
          });
          const teams = [{ value: 'all', label: 'All members' }];
          Array.from(teamSet)
            .sort((a, b) => a.localeCompare(b))
            .forEach(team => teams.push({ value: team, label: team }));
          this.recipientMembers = members;
          this.recipientTeams = teams;
          this.applyRecipientFilter(this.selectedRecipientTeam || 'all');
        } catch (e) {
          console.error(e);
          this.recipientError = (e && e.message) ? e.message : 'Unable to load team members.';
          this.filteredRecipients = [];
          this.selectedRecipientEmails = [];
        } finally {
          this.recipientLoading = false;
        }
      },

      applyRecipientFilter(teamValue) {
        const team = teamValue || 'all';
        this.selectedRecipientTeam = team;
        if (team === 'all') {
          this.filteredRecipients = this.recipientMembers.slice();
        } else {
          this.filteredRecipients = this.recipientMembers.filter(m => Array.isArray(m.teams) && m.teams.includes(team));
        }
        this.selectedRecipientEmails = this.filteredRecipients.map(m => m.email);
      },

      selectAllRecipients() {
        this.selectedRecipientEmails = this.filteredRecipients.map(m => m.email);
      },

      deselectAllRecipients() {
        this.selectedRecipientEmails = [];
      },

      onRecipientTeamChange(value) {
        this.applyRecipientFilter(value);
      },

      todayISO() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      },

      emailValid() {
        return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(String(this.email || '').trim());
      },

      normalizedEmail() {
        return String(this.email || '').trim().toLowerCase();
      },

      onEmailInput() {
        if (this.normalizedEmail() !== this.prefilledFor) {
          this.memberVerified = false;
          this.verifiedEmail = '';
          this.selectedServiceIds = [];
          this.statusMessage = '';
        }
        if (!this.emailValid()) {
          this.error = '';
        }
      },

      async verifyMemberEmail(force = false) {
        const email = this.normalizedEmail();
        if (!email) {
          this.memberVerified = false;
          this.verifiedEmail = '';
          return false;
        }
        if (!force && this.memberVerified && email === this.verifiedEmail) {
          return true;
        }
        try {
          const res = await callRpc('memberExistsInRoles', { email });
          this.memberVerified = Boolean(res?.exists);
          this.verifiedEmail = this.memberVerified ? email : '';
          if (!this.memberVerified) {
            this.error = 'Please contact Belinda to add your email to the database.';
          } else {
            this.error = '';
          }
          return this.memberVerified;
        } catch (e) {
          console.error(e);
          this.memberVerified = false;
          this.verifiedEmail = '';
          this.error = (e && e.message) ? e.message : 'Unable to verify your email.';
          return false;
        }
      },

      async fetchServices() {
        this.loadingServices = true;
        this.error = '';
        try {
          const res = await callRpc('listServices', {
            includePast: false,
            sort: 'asc',
            startDate: this.todayISO(),
            limit: 20
          });
          const items = Array.isArray(res?.items) ? res.items : [];
          this.services = items.map(it => ({
            ...it,
            label: this.formatServiceLabel(it),
            subtitle: [it.type || '', it.time || '10:00 AM'].filter(Boolean).join('  ') || 'Service'
          }));
        } catch (e) {
          console.error(e);
          this.error = (e && e.message) ? e.message : 'Unable to load services.';
        } finally {
          this.loadingServices = false;
        }
      },

      formatServiceLabel(item) {
        const iso = String(item?.date || '').trim();
        if (!iso) return item?.id || 'Service';
        try {
          const [y, m, d] = iso.split('-').map(Number);
          const dt = new Date(y, m - 1, d);
          return dt.toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' });
        } catch (_) {
          return iso;
        }
      },

      async prefillAvailability(force = false) {
        const email = this.normalizedEmail();
        if (!email) {
          this.error = 'Enter your email to load saved dates.';
          return;
        }
        if (!force && email === this.prefilledFor && this.memberVerified) return;
        this.loadingAvailability = true;
        this.error = '';
        try {
          const verified = await this.verifyMemberEmail(force);
          if (!verified) {
            this.selectedServiceIds = [];
            this.statusMessage = '';
            this.prefilledFor = '';
            return;
          }
          const res = await callRpc('getMemberAvailability', { email });
          this.selectedServiceIds = Array.isArray(res?.unavailable) ? res.unavailable.slice() : [];
          this.prefilledFor = email;
          this.statusMessage = this.selectedServiceIds.length
            ? 'Loaded your saved unavailable dates.'
            : 'No saved dates yet. Check every service you cannot serve.';
        } catch (e) {
          console.error(e);
          this.error = (e && e.message) ? e.message : 'Unable to load availability.';
        } finally {
          this.loadingAvailability = false;
        }
      },

      clearSelections() {
        this.selectedServiceIds = [];
      },

      async saveAvailability() {
        const email = this.normalizedEmail();
        if (!email) {
          this.error = 'Email is required.';
          return;
        }
        if (!this.memberVerified || email !== this.verifiedEmail) {
          this.error = 'Load dates for your email before saving.';
          return;
        }
        this.saving = true;
        this.error = '';
        this.statusMessage = '';
        try {
          await callRpc('saveMemberAvailability', {
            email,
            unavailableServiceIds: this.selectedServiceIds
          });
          this.statusMessage = 'Availability saved. Thank you!';
          this.prefilledFor = email;
        } catch (e) {
          console.error(e);
          this.error = (e && e.message) ? e.message : 'Unable to save availability.';
        } finally {
          this.saving = false;
        }
      }
    };
  }
</script>


</head>

<body x-data="app()" x-init="init()" class="min-h-screen overflow-y-auto bg-gray-50">

  <!-- Topbar -->
  <div class="sticky top-0 z-10 bg-white border-b" x-data="{ menuOpen: false }">
  <div class="h-14 px-4 flex items-center gap-3">
    <h1 class="text-lg font-bold mr-1">Worship Planner</h1>

    <!-- Current view label (always visible) -->
    <div class="text-sm text-gray-700 flex-1 min-w-0 text-center md:hidden">
      <span class="truncate text-lg font-bold text-blue-700"
            x-text="route==='plan' ? 'Weekly Plan' : (route==='songs' ? 'Song List' : (route==='team' ? 'Team' : 'Availability'))"></span>
    </div>

    <!-- Desktop tabs -->
    <nav class="hidden md:flex items-center gap-2">
      <a href="#/plan"
         class="px-2 py-1"
         :class="route==='plan' ? 'font-semibold border-b-2 border-blue-600' : 'text-gray-700'">
        Weekly Plan
      </a>

      <a href="#/songs"
         class="px-2 py-1"
         :class="route==='songs' ? 'font-semibold border-b-2 border-blue-600' : 'text-gray-700'">
        Song List
      </a>

      <template x-if="!window.__GUEST__">
        <a href="#/team"
           class="px-2 py-1"
           :class="route==='team' ? 'font-semibold border-b-2 border-blue-600' : 'text-gray-700'">
          Team
        </a>
      </template>

      <a href="#/availability"
         class="px-2 py-1"
         :class="route==='availability' ? 'font-semibold border-b-2 border-blue-600' : 'text-gray-700'">
        Availability
      </a>
    </nav>

    <!-- Mobile hamburger -->
    <div class="md:hidden relative" x-data="{ tooltip: false }">
      <button type="button" class="p-2 rounded hover:bg-gray-100 border" aria-label="Open menu"
              @click="menuOpen = !menuOpen" :aria-expanded="menuOpen">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <!-- Dropdown absolute box -->
      <div class="absolute right-0 mt-2 w-48 bg-white border rounded-md shadow-lg" role="menu"
           x-show="menuOpen" x-transition.origin.top.right @click.outside="menuOpen=false" @keydown.escape.window="menuOpen=false">
        <nav class="py-1">
          <a href="#/plan" class="block px-4 py-2 text-sm text-gray-800 hover:bg-gray-100"
             :class="route==='plan' ? 'font-semibold' : ''" @click="menuOpen=false">Weekly Plan</a>
          <a href="#/songs" class="block px-4 py-2 text-sm text-gray-800 hover:bg-gray-100"
             :class="route==='songs' ? 'font-semibold' : ''" @click="menuOpen=false">Song List</a>
          <template x-if="!window.__GUEST__">
            <a href="#/team" class="block px-4 py-2 text-sm text-gray-800 hover:bg-gray-100"
               :class="route==='team' ? 'font-semibold' : ''" @click="menuOpen=false">Team</a>
          </template>
          <a href="#/availability" class="block px-4 py-2 text-sm text-gray-800 hover:bg-gray-100"
             :class="route==='availability' ? 'font-semibold' : ''" @click="menuOpen=false">Availability</a>
        </nav>
      </div>
    </div>
  </div>
</div>


  <!-- Views stay mounted; tabs toggle visibility to preserve state -->
  <main class="min-h-[calc(100vh-56px)]">
    <div class="h-full">
      <template x-if="route==='songs'">
        <div x-data="songsApp('page')" x-init="init()" class="h-full flex flex-col">
    <h1 class="text-3xl font-bold mb-4 text-center hidden">Song List</h1>

    <!-- Sticky controls -->
    <div class="sticky top-0 z-10 bg-white/95 backdrop-blur border-b">
        <div class="p-4 flex items-center gap-4 bg-gray-100">

            <!-- Search Input -->
            <input type="search" placeholder="Filter (title, theme, scripture)" class="hidden xl:block border rounded px-3 py-2 w-80 flex-1"
            x-model.debounce.200ms="q" @search="render(true)" />


            <!-- Mobile Filters trigger -->
            <button type="button" class="xl:hidden px-3 py-2 border rounded bg-white hover:bg-gray-50" @click="filtersOpen = true">Filters</button>

            <!-- Options/Filters group for md+ -->
            <div class="hidden xl:flex items-center gap-4">
            <!-- Options Dropdown -->
            <div class="relative" x-data="{ open: false }">
                <button type="button" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 flex items-center gap-2"
                    @click="open = !open">
                    Options
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div x-show="open" x-cloak @click.outside="open = false"
                    class="absolute z-20 mt-1 w-48 bg-white border rounded shadow">
                    <label class="flex items-center gap-2 px-3 py-2 text-sm border-b">
                        <input type="checkbox" x-model="searchLyrics" @change="render()" />
                        Lyrics
                    </label>
                    <label class="flex items-center gap-2 px-3 py-2 text-sm border-b">
                        <input type="checkbox" x-model="spanishOnly" @change="render(true)" />
                        Spanish
                    </label>
                    <label class="flex items-center gap-2 px-3 py-2 text-sm">
                        <input type="checkbox" x-model="showArchived" @change="render(true)" />
                        Archived
                    </label>
                </div>
            </div>

            <!-- Season dropdown -->
            <label class="text-sm flex flex-col">
                <span class="text-gray-600 text-center sr-only">Season</span>
                <select class="border rounded px-2 py-1" x-model="selectedSeason" @change="render()">
                    <option value="">All seasons</option>
                    <template x-for="{key,label} in seasons" :key="key">
                        <option :value="key" x-text="label"></option>
                    </template>
                </select>
            </label>

            <!-- Leader dropdown -->
            <label class="text-sm flex flex-col">
                <span class="text-gray-600 text-center sr-only">Leader</span>
                <select class="border rounded px-2 py-1" x-model="selectedLeader" @change="render()">
                    <option value="">All leaders</option>
                    <template x-for="name in leaderOptions" :key="name">
                        <option :value="name" x-text="name"></option>
                    </template>
                </select>
            </label>

            <!-- Usage dropdown -->
            <label class="text-sm flex flex-col">
                <span class="text-gray-600 text-center sr-only">Usage</span>
                <select class="border rounded px-2 py-1" x-model="selectedUsage" @change="render()">
                    <option value="">All usage</option>
                    <template x-for="u in usageOptions" :key="u">
                        <option :value="u" x-text="u"></option>
                    </template>
                </select>
            </label>
            </div>


            <div class="flex flex-wrap items-center gap-2 ml-auto">
                <span class="text-sm text-gray-700" x-text="`${filtered.length} of ${rows.length}`"></span>
                <span class="text-sm italic text-gray-500" x-show="loading">Loading</span>
                <span class="text-sm text-red-600" x-text="error"></span>
                <template x-if="!isGuest">
                  <button type="button" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 flex items-center gap-2"
                    @click="openSongEditor('edit')" :disabled="!selected" title="Edit song" aria-label="Edit song">
                    <!-- icon below xl, label on xl+ -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-5 w-5 xl:hidden">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M16.5 3.964a2.25 2.25 0 113.182 3.182L7.5 19.5 3 21l1.5-4.5L16.5 3.964z" />
                    </svg>
                    <span class="hidden xl:inline">Edit song</span>
                  </button>
                </template>
                <template x-if="!isGuest">
                  <button type="button" class="px-3 py-2 border rounded bg-emerald-50 text-emerald-700 hover:bg-emerald-100 flex items-center gap-2"
                    @click="openSongEditor('create')" title="Add song" aria-label="Add song">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-5 w-5 xl:hidden">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span class="hidden xl:inline">Add song</span>
                  </button>
                </template>
                <button type="button" class="md:hidden px-3 py-2 border rounded bg-white hover:bg-gray-50 flex items-center gap-2"
                  @click="mobileListOpen = true" title="Browse songs" aria-label="Browse songs">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-5 w-5">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 110-16 8 8 0 010 16z" />
                  </svg>
                  <span class="hidden xl:inline">Browse songs</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Filters sheet -->
    <div x-show="filtersOpen" x-cloak class="fixed inset-0 z-50 md:hidden">
      <div class="absolute inset-0 bg-black/40" @click="filtersOpen=false"></div>
      <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-xl shadow-lg p-4 space-y-3">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Filters</div>
          <button type="button" class="text-sm underline" @click="filtersOpen=false">Close</button>
        </div>
        <div class="grid grid-cols-1 gap-3">
          <label class="text-sm flex flex-col">
            <span class="text-gray-600">Keyword</span>
            <input type="search" class="border rounded px-3 py-2" placeholder="Filter (title, theme, scripture...)"
              x-model.debounce.200ms="q" @search="render(true)" />
          </label>
          <label class="text-sm flex items-center gap-2">
            <input type="checkbox" x-model="searchLyrics" @change="render()" />
            <span>Lyrics</span>
          </label>
          <label class="text-sm flex items-center gap-2">
            <input type="checkbox" x-model="spanishOnly" @change="render(true)" />
            <span>Spanish</span>
          </label>
          <label class="text-sm flex items-center gap-2">
            <input type="checkbox" x-model="showArchived" @change="render(true)" />
            <span>Archived</span>
          </label>
          <label class="text-sm flex flex-col">
            <span class="text-gray-600">Season</span>
            <select class="border rounded px-2 py-1" x-model="selectedSeason" @change="render()">
              <option value="">All seasons</option>
              <template x-for="{key,label} in seasons" :key="key">
                <option :value="key" x-text="label"></option>
              </template>
            </select>
          </label>
          <label class="text-sm flex flex-col">
            <span class="text-gray-600">Leader</span>
            <select class="border rounded px-2 py-1" x-model="selectedLeader" @change="render()">
              <option value="">All leaders</option>
              <template x-for="name in leaderOptions" :key="name">
                <option :value="name" x-text="name"></option>
              </template>
            </select>
          </label>
          <label class="text-sm flex flex-col">
            <span class="text-gray-600">Usage</span>
            <select class="border rounded px-2 py-1" x-model="selectedUsage" @change="render()">
              <option value="">All usage</option>
              <template x-for="u in usageOptions" :key="u">
                <option :value="u" x-text="u"></option>
              </template>
            </select>
          </label>
        </div>
      </div>
    </div>

    <!-- Content area fills the rest of the viewport; no page scroll -->
    <div class="flex-1 min-h-0 p-4 z-0">
        <div class="flex gap-4 h-full relative">
            <!-- LEFT PANE: table scrolls -->
            <div class="hidden md:block w-full md:w-[360px] flex-shrink-0 h-full overflow-auto border rounded">
                <table class="min-w-full">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <template x-for="h in tableHeaders" :key="h">
                                <th class="text-left py-2 cursor-pointer select-none" @click="sort(h)">
                                    <span class="inline-block w-4 text-xs align-middle" x-html="headerIcon(h)"></span>
                                    <span x-text="headerLabel(h)"></span>
                                </th>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(r, i) in filtered" :key="i">
                            <tr class="odd:bg-white even:bg-gray-50 hover:bg-indigo-50 cursor-pointer"
                                :class="selected === r ? 'ring-2 ring-indigo-400' : ''" @click="select(r)">
                                <template x-for="h in tableHeaders" :key="h">
                                    <td class="px-3 py-2" x-text="format(r[h])"></td>
                                </template>
                            </tr>
                        </template>
                        <tr x-show="!filtered.length">
                            <td class="px-3 py-6 text-center text-gray-500" :colspan="tableHeaders.length">
                                No results
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- RIGHT PANE: Preview -->
            <div class="flex-1 h-full overflow-auto border rounded p-4">
                <div x-show="selected">
                    <!-- HEADER -->
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <h2 class="text-2xl font-semibold" x-text="selected?.Song || '(Untitled)'"></h2>
                            <div class="mt-1 text-xs font-semibold uppercase text-rose-600" x-show="isArchived(selected)">
                              Archived
                            </div>

                            <div class="mt-1 text-sm text-gray-600" x-show="selected?.Leader">
                                Leader: <span class="font-medium" x-text="selected?.Leader"></span>
                            </div>

                            <div class="mt-1 text-sm text-gray-600" x-show="selected?.Season">
                                Season: <span class="font-medium" x-text="selected?.Season"></span>
                            </div>

                            <div class="mt-1 text-sm text-gray-600" x-show="selected?.Themes">
                                Themes: <span class="font-medium" x-text="selected?.Themes"></span>
                            </div>

                            <div class="mt-1 text-sm text-gray-600" x-show="selected?.Scriptures">
                                Scriptures: <span class="font-medium" x-text="selected?.Scriptures"></span>
                            </div>

                            <div class="mt-1 text-sm text-gray-600" x-show="selected?.Keywords">
                                Keywords: <span class="font-medium" x-text="selected?.Keywords"></span>
                            </div>
                        </div>

                        <div class="text-sm text-right text-gray-600">
                            <div x-show="selected?.Uses">Uses: <span class="font-medium" x-text="selected?.Uses"></span>
                            </div>
                            <div x-show="selected?.Usage">Usage: <span class="font-medium"
                                    x-text="selected?.Usage"></span></div>
                            <div x-show="selected?.Years_Used">Years Used: <span class="font-medium"
                                    x-text="selected?.Years_Used"></span></div>
                            <div x-show="selected?.Last_Used">Last used: <span class="font-medium"
                                    x-text="format(selected?.Last_Used)"></span></div>
                            <div x-show="selected?.First_Used">First used: <span class="font-medium"
                                    x-text="format(selected?.First_Used)"></span></div>
                        </div>
                    </div>

                    <!-- MEDIA -->
                    <div class="mt-4">
                        <div class="text-sm font-medium text-gray-700 mb-1">Media</div>

                        <div x-show="selected?._folderUrl" class="mb-2">
                            <a class="inline-flex items-center gap-2 px-2 py-1 border rounded hover:bg-gray-50"
                                :href="selected?._folderUrl || '#'" target="_blank" rel="noopener">
                                <span class="font-semibold text-sm">Open Folder</span>
                            </a>
                        </div>

                        <div x-show="mediaLoading" class="text-sm text-gray-500">Loading files...</div>

                        <ul x-show="!mediaLoading && mediaFiles.length" class="space-y-1">
                            <template x-for="(file, i) in mediaFiles" :key="i">
                                <li>
                                    <a class="text-blue-600 hover:text-blue-800 hover:underline" :href="file.url" target="_blank" rel="noopener">
                                        <span x-text="fileIcon(file.mimeType)"></span>
                                        <span x-text="friendlyMediaName(file)"></span>
                                    </a>
                                </li>
                            </template>
                        </ul>

                        <div x-show="!mediaLoading && !mediaFiles.length" class="text-sm text-gray-500" x-text="mediaMessage || 'No files in folder.'"></div>
                    </div>

                    <!-- NOTES -->
                    <div class="mt-3" x-show="selected?.Notes">
                        <div class="text-sm font-medium text-gray-700 mb-1">Notes</div>
                        <div class="text-sm whitespace-pre-wrap" x-text="selected?.Notes"></div>
                    </div>

                    <!-- LYRICS -->
                    <div class="mt-4">
                            <div class="flex items-center justify-between mb-1">
                                <div class="text-sm font-medium text-gray-700">Lyrics</div>
                                <button type="button" class="text-sm underline"
                                    @click="copy(selected.Lyrics || selected['Lyrics (PD)'])">Copy</button>
                            </div>
                            <pre class="bg-gray-50 border rounded p-3 overflow-auto max-h-[60vh] whitespace-pre-wrap"
                                x-text="selected?.Lyrics || selected?.['Lyrics (PD)'] || '(No lyrics)'"></pre>
                    </div>
                </div>

                <div x-show="!selected" class="text-gray-500">Select a song to preview.</div>
            </div>

        </div>
    </div>

    <!-- Song editor modal -->
    <div x-show="showSongEditor" x-cloak class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/40" @click="cancelSongEditor()"></div>
        <div class="relative bg-white rounded-lg shadow-lg max-w-3xl w-[95vw] max-h-[90vh] overflow-y-auto">
            <div class="px-4 py-3 border-b flex items-center justify-between">
                <template x-if="!isGuest">
                <template x-if="!isGuest">
                <div class="font-semibold" x-text="songEditorMode === 'edit' ? 'Edit Song' : 'Add Song'"></div>
                <button type="button" class="text-sm text-blue-700 hover:underline" @click="cancelSongEditor()">Close</button>
            </div>
            <form class="p-4 space-y-4" @submit.prevent="saveSongEditor()">
                <div class="grid md:grid-cols-2 gap-4">
                    <label class="text-sm flex flex-col gap-1">
                        <span class="font-medium text-gray-700">Song title</span>
                        <input type="text" class="border rounded px-3 py-2" x-model="songForm.Song" x-ref="songTitle" required>
                    </label>
                    <label class="text-sm flex flex-col gap-1">
                        <span class="font-medium text-gray-700">Leader(s)</span>
                        <input type="text" class="border rounded px-3 py-2" x-model="songForm.Leader" placeholder="Comma separated">
                    </label>
                    <label class="text-sm flex flex-col gap-1">
                        <span class="font-medium text-gray-700">Season</span>
                        <input type="text" class="border rounded px-3 py-2" x-model="songForm.Season">
                    </label>
                    <label class="text-sm flex flex-col gap-1">
                        <span class="font-medium text-gray-700">Usage</span>
                        <input type="text" class="border rounded px-3 py-2" x-model="songForm.Usage">
                    </label>
                    <label class="text-sm flex flex-col gap-1 md:col-span-2">
                        <span class="font-medium text-gray-700">Themes</span>
                        <input type="text" class="border rounded px-3 py-2" x-model="songForm.Themes" placeholder="Comma separated">
                    </label>
                    <label class="text-sm flex flex-col gap-1 md:col-span-2">
                        <span class="font-medium text-gray-700">Keywords</span>
                        <input type="text" class="border rounded px-3 py-2" x-model="songForm.Keywords" placeholder="Comma separated">
                    </label>
                    <label class="text-sm flex flex-col gap-1 md:col-span-2">
                        <span class="font-medium text-gray-700">Scriptures</span>
                        <input type="text" class="border rounded px-3 py-2" x-model="songForm.Scriptures" placeholder="Comma separated">
                    </label>
                    <label class="text-sm flex flex-col gap-1 md:col-span-2">
                        <span class="font-medium text-gray-700">Link</span>
                        <input type="url" class="border rounded px-3 py-2" x-model="songForm.Link" placeholder="https://...">
                    </label>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <label class="text-sm flex flex-col gap-1">
                        <span class="font-medium text-gray-700">Notes</span>
                        <textarea class="border rounded px-3 py-2 min-h-[80px]" x-model="songForm.Notes"></textarea>
                    </label>
                    <label class="text-sm flex flex-col gap-1">
                        <span class="font-medium text-gray-700">Lyrics</span>
                        <textarea class="border rounded px-3 py-2 min-h-[120px]" x-model="songForm.Lyrics"></textarea>
                    </label>
                </div>
                <div class="flex items-center gap-4">
                    <label class="inline-flex items-center gap-2 text-sm">
                        <input type="checkbox" x-model="songForm.Sp">
                        Spanish
                    </label>
                    <label class="inline-flex items-center gap-2 text-sm">
                        <input type="checkbox" x-model="songForm.Archive">
                        Archived
                    </label>
                </div>
                <div class="text-sm text-rose-600" x-show="songEditorError" x-text="songEditorError"></div>
                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" class="px-4 py-2 border rounded hover:bg-gray-50" @click="cancelSongEditor()" :disabled="songEditorSaving">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded bg-emerald-600 text-white disabled:opacity-50" :disabled="songEditorSaving">
                        <span x-show="!songEditorSaving">Save song</span>
                        <span x-show="songEditorSaving">Saving</span>
                    </button>
                </template>
                </template>
                </div>
            </form>
        </div>
    </div>

    <!-- Mobile song list overlay -->
    <div class="md:hidden" x-show="mobileListOpen" x-transition.opacity x-cloak>
        <div class="fixed inset-0 bg-black/40 z-40" @click="mobileListOpen = false"></div>
        <div class="fixed inset-y-0 left-0 right-0 z-50 flex">
            <div class="ml-auto h-full w-full max-w-md bg-white shadow-xl border-l flex flex-col">
                <div class="px-4 py-3 border-b flex items-center justify-between">
                    <div class="font-semibold">Select a song</div>
                    <button type="button" class="text-sm text-blue-600 hover:underline" @click="mobileListOpen = false">Close</button>
                </div>
                <div class="flex-1 overflow-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <template x-for="h in tableHeaders" :key="h">
                                    <th class="text-left py-2 cursor-pointer select-none px-3" @click="sort(h)">
                                        <span class="inline-block w-4 text-xs align-middle" x-html="headerIcon(h)"></span>
                                        <span x-text="headerLabel(h)"></span>
                                    </th>
                                </template>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(r, i) in filtered" :key="i">
                                <tr class="odd:bg-white even:bg-gray-50 hover:bg-indigo-50 cursor-pointer"
                                    :class="selected === r ? 'ring-2 ring-indigo-400' : ''" @click="select(r)">
                                    <template x-for="h in tableHeaders" :key="h">
                                        <td class="px-3 py-2" x-text="format(r[h])"></td>
                                    </template>
                                </tr>
                            </template>
                            <tr x-show="!filtered.length">
                                <td class="px-3 py-6 text-center text-gray-500" :colspan="tableHeaders.length">
                                    No results
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    

      </template>

      <div x-show="route==='plan'" class="h-full">
        <div x-data="weeklyPlanApp()" x-init="init()"
  @use-song.window="applySuggestion(suggestTargetIndex, { name: $event.detail.name }); showSuggestModal=false"
  class="min-h-screen flex flex-col overflow-y-auto pt-6 md:pt-8">
  <div class="p-3 border-b flex items-center gap-3 bg-gray-100">
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-700">Existing Service</label>
      <select class="border rounded px-2 py-1 min-w-[320px]" x-model="selectedServiceId">
        <option value="" disabled selected>Select...</option>
        <template x-for="s in existingServices" :key="s.id || (s.date + s.time)">
          <option :value="s.id"
            x-text="(s.id || ((s.date||'') + (s.time?(' '+s.time):''))) + (s.type?(' - '+s.type):'') + (s.leader?(' ('+s.leader+')'):'')">
          </option>
        </template>
      </select>
      <button class="inline-flex items-center justify-center h-9 px-3 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100 disabled:opacity-50"
        :disabled="loadingServices || !selectedServiceId"
        @click="loadSelected()">Load</button>
      <template x-if="!selectedServiceId && !isGuest">
        <button class="inline-flex items-center justify-center h-9 px-3 rounded bg-emerald-600 text-white hover:bg-emerald-700"
          @click="submit()" x-text="actionLabel()"></button>
      </template>
      <template x-if="!isGuest">
        <button
          class="ml-1 inline-flex items-center justify-center h-9 w-9 rounded bg-rose-50 text-rose-800 border border-rose-300 hover:bg-rose-100 disabled:opacity-50"
          :disabled="loadingServices || !selectedServiceId"
          title="Delete service"
          @click="selectedServiceId && confirm('Delete this service and all its items?') && deleteSelectedService()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
            <path
              d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166M19.5 5.79 18.16 19.673A2.25 2.25 0 0 1 15.916 21.75H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.455 0c-1.146-.173-2.306-.306-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397M15.75 5.394V4.478c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0C9.16 2.314 8.25 3.299 8.25 4.478v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
          </svg>
        </button>
      </template>
    </div>
    <div class="flex-1"></div>
    <div class="flex items-center gap-2">
      <span x-cloak x-show="loadingServices"
        class="inline-flex items-center gap-2 text-sm text-blue-800 bg-blue-50 border border-blue-200 px-2 py-1 rounded">
        <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
          stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="9" stroke-opacity=".25"></circle>
          <path d="M21 12a9 9 0 0 1-9 9" stroke-linecap="round"></path>
        </svg>
        <span>Syncing services...</span>
      </span>
      <template x-if="!isGuest">
        <button
          class="inline-flex items-center justify-center h-9 px-3 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100 disabled:opacity-50"
          :disabled="loadingServices" @click="openCreateServicesModal()">Add New Services</button>
      </template>
    </div>
  </div>

  <div x-cloak x-show="showCreateServicesModal && !isGuest"
    class="fixed inset-0 z-30 flex items-center justify-center bg-black/40 px-4"
    @keydown.escape.window="closeCreateServicesModal()"
    @click.self="closeCreateServicesModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-5">
      <h2 class="text-lg font-semibold mb-3">Batch Create Services</h2>
      <p class="text-sm text-gray-600 mb-4">
        We'll create Sunday services at 10:00 AM. Communion is scheduled on the 1st, 3rd, and 5th Sundays;
        Offering on the 2nd and 4th. Defaults: Leader &mdash; Darden, Preacher &mdash; Tom.
      </p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <label class="text-sm text-gray-700">
          Start Sunday
          <input type="date" class="border rounded w-full mt-1 px-2 py-1"
            x-model="batchStartDate">
        </label>
        <label class="text-sm text-gray-700">
          Weeks to create
          <input type="number" min="1" max="52" class="border rounded w-full mt-1 px-2 py-1"
            x-model.number="batchWeeks" x-ref="batchWeeks">
        </label>
      </div>
      <div class="text-sm text-rose-600 mb-2" x-text="batchCreateError" x-show="batchCreateError"></div>
      <div class="flex justify-end gap-2">
        <button type="button" class="px-3 py-1.5 rounded border border-gray-300 text-gray-700 hover:bg-gray-50"
          @click="closeCreateServicesModal()"
          :disabled="batchCreateLoading">Cancel</button>
        <button type="button"
          class="px-3 py-1.5 rounded bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50"
          :disabled="batchCreateLoading"
          @click="submitBatchCreate()">
          <span x-show="!batchCreateLoading">Create Services</span>
          <span x-show="batchCreateLoading">Creating...</span>
        </button>
      </div>
    </div>
  </div>

  <div class="mx-4 mt-3 mb-0" x-show="loadingServices" x-cloak>
    <div class="rounded border border-blue-200 bg-blue-50 text-blue-800 px-3 py-2 text-sm">Fetching existing services...
      please wait.</div>
  </div>

  <div class="p-4" x-show="showDetails" x-cloak>
    <h3 class="text-lg font-semibold mb-3 sr-only">Service Details</h3>
    <div class="flex gap-2 flex-wrap">
      <div class="pr-6">
        <h1 class="font-bold text-2xl" x-html="formattedDateTimeHtml()"></h1>
      </div>
      <label class="text-sm flex-1">Service Type
        <select class="mt-1 w-full border rounded px-2 py-1" x-model="form.type" @change="queueSaveDetails()">
          <option value="Communion">Communion</option>
          <option value="Offering">Offering</option>
        </select>
      </label>
      <label class="text-sm flex-1">Leader
        <div class="mt-1">
          <select x-ref="leaderSel" class="border rounded px-2 py-1 w-full" x-model="leaderSelect"
            @change="form.leader = leaderSelect==='__custom' ? '' : leaderSelect; queueSaveDetails()">
            <template x-for="n in leaderChoices" :key="'lead-'+n">
              <option :value="n" x-text="n"></option>
            </template>
            <option value="__custom">Custom...</option>
          </select>
        </div>
        <template x-if="leaderSelect==='__custom'"><input type="text" class="mt-2 w-full border rounded px-2 py-1"
            placeholder="Type leader name" x-model="form.leader" @input="queueSaveDetails()" /></template>
      </label>
      <label class="text-sm min-w-32 flex-1">Preacher
        <div class="mt-1">
          <select x-ref="preacherSel" class="border rounded px-2 py-1 w-full" x-model="preacherSelect"
            @change="form.preacher = preacherSelect==='__custom' ? '' : preacherSelect; queueSaveDetails()">
            <template x-for="n in preacherChoices" :key="'prech-'+n">
              <option :value="n" x-text="n"></option>
            </template>
            <option value="__custom">Custom...</option>
          </select>
        </div>
        <template x-if="preacherSelect==='__custom'"><input type="text" class="mt-2 w-full border rounded px-2 py-1"
            placeholder="Type preacher name" x-model="form.preacher" @input="queueSaveDetails()" /></template>
      </label>
    </div>

    <div class="pt-2">
      <div class="border rounded w-full">
        <button type="button" class="w-full flex items-center px-3 py-2" @click="showScripture = !showScripture">
          <span class="mr-2 select-none text-3xl text-blue-700" x-text="showScripture ? '' : ''"></span>
          <span class="font-medium">Scripture</span>
        </button>
        <div class="p-3 border-t" x-show="showScripture" x-cloak>
          <div class="flex items-center gap-2">
            <input class="flex-1 border rounded px-2 py-1" type="text" placeholder="e.g., John 3:5-6, 8-10"
              x-model="form.scripture" @input="queueSaveDetails()" />
            <button class="px-2 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
              @click="fetchScripture()">Fetch Text</button>
          </div>
          <textarea class="mt-2 w-full border rounded px-2 py-1" rows="6" x-model="scriptureText" @input="queueSaveDetails()"
            placeholder="Scripture text (editable)"></textarea>
            <div class="mt-2 flex">
              <label class="text-sm block">Theme
                <input type="text" class="mt-1 w-full border rounded px-2 py-1" x-model="form.theme" @input="queueSaveDetails()" />
              </label>
              <label class="text-sm block flex-1">Keywords
                <input type="text" class="mt-1 w-full border rounded px-2 py-1" placeholder="Auto from Scripture; comma separated" x-model="form.keywords" @input="queueSaveDetails()" />
              </label>
            </div>
            <label class="text-sm block mt-2">Notes
              <textarea class="mt-1 w-full border rounded px-2 py-1" rows="3" x-model="form.notes" @input="queueSaveDetails()"></textarea>
            </label>
        </div>
      </div>
    </div>

    <div class="mt-4 border rounded p-3" x-show="showOrder" x-cloak>
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-3">
          <span class="font-medium">Order of Worship</span>
          <span class="text-xs text-gray-500" x-show="savingOrder">Saving</span>
          <span class="text-xs text-gray-500" x-show="!savingOrder && savedAt">Saved</span>
        </div>
        <div class="flex gap-2">
          <template x-if="!isGuest">
            <button
              class="px-2 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
              @click="addOrderRow()">+ Add Row</button>
          </template>
        </div>
      </div>
      <div class="relative max-h-[50vh] overflow-auto">
        <div x-cloak x-show="loadingOrder"
          class="absolute inset-0 z-10 flex items-center justify-center bg-white/80 backdrop-blur-sm">
          <div class="inline-flex items-center gap-2 text-sm text-indigo-700">
            <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="9" stroke-opacity=".25"></circle>
              <path d="M21 12a9 9 0 0 1-9 9" stroke-linecap="round"></path>
            </svg>
            <span>Loading order...</span>
          </div>
        </div>
        <table class="min-w-full border text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="border px-2 py-1 w-14 text-left">#</th>
              <th class="border px-2 py-1 text-left">Item</th>
              <th class="border px-2 py-1 text-left">Detail</th>
              <th class="border px-2 py-1 text-left">Leader</th>
              <th class="border px-2 py-1 text-left">Notes</th>
              <template x-if="!isGuest">
                <th class="border px-2 py-1 w-28">Actions</th>
              </template>
            </tr>
          </thead>
          <tbody>
            <template x-for="(row, i) in orderRows" :key="'ord-'+i">
              <tr>
                <td class="border px-2 py-1" x-text="i+1"></td>
                <td class="border px-2 py-1">
                  <select class="border rounded px-2 py-1 w-full" x-model="row.itemType" @change="queueSaveOrder(true)"
                    :disabled="isGuest">
                    <option :value="row.itemType" x-text="row.itemType"></option>
                    <template x-for="t in orderItemTypes" :key="t">
                      <option :value="t" x-text="t"></option>
                    </template>
                  </select>
                </td>
                <td class="border px-2 py-1 relative">
                  <div class="flex items-center gap-2 relative">
                    <template x-if="loadingSuggestion && suggestTargetIndex === i">
                      <div class="absolute inset-y-0 right-12 flex items-center text-xs text-indigo-600">
                        <svg class="h-3.5 w-3.5 animate-spin mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <circle cx="12" cy="12" r="9" stroke-opacity=".25"></circle>
                          <path d="M21 12a9 9 0 0 1-9 9" stroke-linecap="round"></path>
                        </svg>
                        <span>Thinking...</span>
                      </div>
                    </template>
                    <input class="border rounded px-2 py-1 w-full" x-model="row.detail" @input="queueSaveOrder()"
                      @blur="queueSaveOrder(true)" placeholder="e.g., Song title" :disabled="isGuest" />
                    <!-- Suggest songs -->
                    <button class="px-2 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
                      title="Suggest song" aria-label="Suggest song"
                      x-show="!isGuest && /song/i.test(String(row.itemType||''))"
                      :disabled="loadingSuggestion || isGuest"
                      @click.stop="suggestForRow(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        class="w-4 h-4">
                        <path
                          d="M12 18V12.75M12 12.75c.518 0 1.021-.066 1.5-.189M12 12.75c-.518 0-1.021-.066-1.5-.189M14.25 20.039A9.02 9.02 0 0 1 12 20.25c-.769 0-1.521-.073-2.25-.211M13.5 22.422A14.706 14.706 0 0 1 12 22.5c-.507 0-1.007-.026-1.5-.078M14.25 18v-.192c0-.983.658-1.823 1.508-2.316A7.46 7.46 0 0 0 19.5 9c0-4.142-3.358-7.5-7.5-7.5S4.5 4.858 4.5 9c0 2.773 1.505 5.194 3.742 6.492.85.493 1.508 1.333 1.508 2.316V18" />
                      </svg>
                    </button>
                    <!-- Suggest scripture -->
                    <button class="px-2 py-1 rounded bg-blue-50 text-blue-800 border border-blue-300 hover:bg-blue-100"
                      title="Suggest scripture" aria-label="Suggest scripture"
                      x-show="!isGuest && /call to worship|scripture/i.test(String(row.itemType||''))"
                      :disabled="loadingSuggestion || isGuest"
                      @click.stop="suggestForRow(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        class="w-4 h-4">
                        <path
                          d="M12 6.042C10.408 4.617 8.305 3.75 6 3.75c-1.052 0-2.062.18-3 .512v14.25c.938-.332 1.948-.512 3-.512 2.305 0 4.408.867 6 2.292m0-14.25C13.592 4.617 15.695 3.75 18 3.75c1.052 0 2.062.18 3 .512v14.25c-.938-.332-1.948-.512-3-.512-2.305 0-4.408.867-6 2.292m0-14.25v14.25" />
                      </svg>
                    </button>
                    <!-- Eye button to view stored scripture text -->
                    <button class="px-2 py-1 rounded text-blue-800 hover:bg-blue-50" title="View Scripture Text"
                      x-show="row.scriptureText"
                      @click.stop="viewRowScripture(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                        <path d="M12 5c-5 0-9 4.5-10 7 1 2.5 5 7 10 7s9-4.5 10-7c-1-2.5-5-7-10-7zm0 11a4 4 0 110-8 4 4 0 010 8z"/>
                      </svg>
                    </button>
                  <!-- Inline scripture suggestions dropdown -->
                    <div x-show="false"></div>
                  </div>
                </td>
                <td class="border px-2 py-1"><input class="border rounded px-2 py-1 w-full" x-model="row.leader" @input="queueSaveOrder()" @blur="queueSaveOrder(true)"
                    placeholder="Leader" :disabled="isGuest" /></td>
                <td class="border px-2 py-1"><input class="border rounded px-2 py-1 w-full" x-model="row.notes" @input="queueSaveOrder()" @blur="queueSaveOrder(true)"
                    placeholder="Notes" :disabled="isGuest" /></td>
                <template x-if="!isGuest">
                  <td class="border px-2 py-1">
                  <div class="flex items-center gap-1">
                    <button type="button" aria-label="Move up"
                      class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-indigo-200 text-indigo-600 hover:bg-indigo-50 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-0"
                      @click="moveOrderRow(i,-1)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"
                        aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m4.5 15.75 7.5-7.5 7.5 7.5" />
                      </svg>
                    </button>
                    <button type="button" aria-label="Move down"
                      class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-indigo-200 text-indigo-600 hover:bg-indigo-50 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-0"
                      @click="moveOrderRow(i,1)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"
                        aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                      </svg>
                    </button>
                    <button type="button" aria-label="Remove"
                      class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-rose-200 text-rose-600 hover:bg-rose-50 hover:border-rose-300 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-offset-0"
                      @click="removeOrderRow(i)">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"
                        aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.455 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                      </svg>
                    </button>
                  </div>
                  </td>
                </template>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Save button moved to header next to Load -->
  </div>

  <!-- Suggest Songs Modal -->
  <div x-show="showSuggestModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center"
    @keydown.window.escape.prevent="showSuggestModal=false">
    <div class="absolute inset-0 bg-black/40" @click="showSuggestModal=false"></div>
    <div class="relative bg-white rounded shadow-lg max-w-[95vw] h-[80vh] p-0 flex flex-col">
      <div class="px-4 py-2 border-b flex items-center justify-between">
        <div class="font-semibold">Suggest Songs</div>
        <button class="text-sm underline" @click="showSuggestModal=false">Close</button>
      </div>
      <div class="flex-1 min-h-0">
        <div x-data="songsApp('modal')" x-init="init()" x-ref="suggestApp" class="h-full flex flex-col">
          <div class="sticky top-0 z-10 bg-white border-b">
            <div class="p-3 flex flex-wrap items-center gap-3">
              <input type="search" placeholder="Search" class="border rounded px-3 py-1 w-64" x-model.debounce.200ms="q"
                @search="render(true)" />
              <div class="relative" x-data="{ open: false }">
                <button type="button" class="px-3 py-1.5 border rounded bg-white hover:bg-gray-50 text-sm flex items-center gap-2"
                  @click="open = !open">
                  Options
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div x-show="open" x-cloak @click.outside="open = false"
                  class="absolute mt-1 w-44 bg-white border rounded shadow z-20">
                  <label class="flex items-center gap-2 px-3 py-2 text-sm border-b">
                    <input type="checkbox" x-model="searchLyrics" @change="render()" />
                    Lyrics
                  </label>
                  <label class="flex items-center gap-2 px-3 py-2 text-sm border-b">
                    <input type="checkbox" x-model="spanishOnly" @change="render(true)" />
                    Spanish
                  </label>
                  <label class="flex items-center gap-2 px-3 py-2 text-sm">
                    <input type="checkbox" x-model="showArchived" @change="render(true)" />
                    Show archived
                  </label>
                </div>
              </div>
              <label class="text-sm flex flex-col">
                <span class="text-gray-600">Season</span>
                <select class="border rounded px-2 py-1" x-model="selectedSeason" @change="render()">
                  <option value="">All</option>
                  <template x-for="{key,label} in seasons" :key="key">
                    <option :value="key" x-text="label"></option>
                  </template>
                </select>
              </label>
              <label class="text-sm flex flex-col">
                <span class="text-gray-600">Leader</span>
                <select class="border rounded px-2 py-1" x-model="selectedLeader" @change="render()">
                  <option value="">All</option>
                  <template x-for="name in leaderOptions" :key="name">
                    <option :value="name" x-text="name"></option>
                  </template>
                </select>
              </label>
              <label class="text-sm flex flex-col">
                <span class="text-gray-600">Usage</span>
                <select class="border rounded px-2 py-1" x-model="selectedUsage" @change="render()">
                  <option value="">All</option>
                  <template x-for="u in usageOptions" :key="u">
                    <option :value="u" x-text="u"></option>
                  </template>
                </select>
              </label>
              <span class="text-sm text-gray-700" x-text="filtered.length + ' of ' + rows.length"></span>
            </div>
          </div>
          <div class="flex-1 min-h-0 p-3">
            <div class="flex gap-3 h-full">
              <div class="w-[320px] flex-shrink-0 h-full overflow-auto border rounded">
                <table class="min-w-full">
                  <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr>
                      <template x-for="h in tableHeaders" :key="h">
                        <th class="text-left px-2 py-1 cursor-pointer select-none" @click="sort(h)">
                          <span class="inline-block w-4 text-xs align-middle" x-html="headerIcon(h)"></span>
                          <span x-text="headerLabel(h)"></span>
                        </th>
                      </template>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="(r, i) in filtered" :key="i">
                      <tr class="odd:bg-white even:bg-gray-50 hover:bg-indigo-50 cursor-pointer"
                        :class="selected === r ? 'ring-2 ring-indigo-400' : ''" @click="select(r)">
                        <template x-for="h in tableHeaders" :key="h">
                          <td class="px-2 py-1" x-text="format(r[h])"></td>
                        </template>
                      </tr>
                    </template>
                    <tr x-show="!filtered.length">
                      <td class="px-2 py-6 text-center text-gray-500" :colspan="tableHeaders.length">No results</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="flex-1 h-full overflow-auto border rounded p-3">
                <div x-show="selected">
                  <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold" x-text="selected?.Song || '(Untitled)'"></h3>
                    <button class="px-2 py-1 border rounded"
                      @click="$dispatch('use-song', { index: $root.suggestTargetIndex, name: selected?.Song || '' })">Use
                      This Song</button>
                  </div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Leader">Leader: <span class="font-medium"
                      x-text="selected?.Leader"></span></div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Season">Season: <span class="font-medium"
                      x-text="selected?.Season"></span></div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Themes">Themes: <span class="font-medium"
                      x-text="selected?.Themes"></span></div>
                  <div class="mt-1 text-sm text-gray-600" x-show="selected?.Scriptures">Scriptures: <span
                      class="font-medium" x-text="selected?.Scriptures"></span></div>
                  <div class="mt-3" x-show="selected?.Notes">
                    <div class="text-sm font-medium text-gray-700 mb-1">Notes</div>
                    <div class="text-sm whitespace-pre-wrap" x-text="selected?.Notes"></div>
                  </div>
                  <div class="mt-3">
                  <div class="text-sm font-medium text-gray-700 mb-1">Lyrics</div>
                  <div class="bg-gray-50 border rounded p-2 max-h-[40vh] overflow-auto whitespace-pre-wrap"
                    x-html="highlightedLyrics()"></div>
                  </div>
                </div>
                <div x-show="!selected" class="text-gray-500">Select a song to preview.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripture Ideas Modal -->
  <div x-show="showScriptureModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center" @keydown.window.escape.prevent="showScriptureModal=false">
    <div class="absolute inset-0 bg-black/40" @click="showScriptureModal=false"></div>
    <div class="relative bg-white rounded shadow-lg max-w-[95vw] h-[80vh] p-0 flex flex-col">
      <div class="px-4 py-2 border-b flex items-center justify-between">
        <div class="font-semibold">Scripture Ideas</div>
        <button class="text-sm underline" @click="showScriptureModal=false">Close</button>
      </div>
      <div class="flex-1 min-h-0 p-3">
        <div class="mb-3 grid gap-2 md:grid-cols-[repeat(auto-fit,minmax(180px,1fr))]">
          <label class="text-xs text-gray-600 flex flex-col gap-1">
            Theme
            <input type="text" class="border rounded px-2 py-1" placeholder="Theme"
              x-model="scriptureSearchTheme" />
          </label>
          <label class="text-xs text-gray-600 flex flex-col gap-1">
            Keywords
            <input type="text" class="border rounded px-2 py-1" placeholder="Comma separated"
              x-model="scriptureSearchKeywords" />
          </label>
          <div class="flex items-end gap-2">
            <button class="px-3 py-1.5 border rounded bg-blue-50 text-blue-800 border-blue-300 hover:bg-blue-100 disabled:opacity-50"
              :disabled="scriptureSearchPending"
              @click="refreshScriptureIdeas('manual')">
              <span x-show="!scriptureSearchPending">Search Ideas</span>
              <span x-show="scriptureSearchPending">Searching</span>
            </button>
            <div class="text-xs text-rose-600" x-show="scriptureSearchError" x-text="scriptureSearchError"></div>
          </div>
        </div>
        <style>
          .scripture-html sup,
          .scripture-html .verse-num {
            color: #1d4ed8;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.25rem;
          }
          .scripture-html .verse-num sup {
            color: inherit;
            font-size: inherit;
            margin: 0;
          }
          .scripture-ref-main {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
          }
          .scripture-ref-main.is-selected {
            background-color: #fde68a;
            border-left-color: #d97706;
          }
        </style>
        <div class="flex gap-3 h-full">
          <div class="w-[250px] flex-shrink-0 h-full overflow-auto border rounded">
            <div class="text-xs text-gray-500 px-2 py-1 border-b">References</div>
            <template x-if="form.scripture">
              <div class="px-2 py-2 border-b border-amber-200 bg-amber-50/70">
                <div class="text-[11px] uppercase tracking-wide text-amber-700 font-semibold mb-1">Main Scripture</div>
                <button class="block w-full text-left px-2 py-1 rounded scripture-ref-main"
                        :class="selectedScriptureRef === form.scripture ? 'is-selected' : ''"
                        @click="selectedScriptureRef=form.scripture; fetchPassage(form.scripture)">
                  <span x-text="form.scripture"></span>
                </button>
              </div>
            </template>
            <template x-if="scriptureSuggestions.length">
              <div>
                <template x-for="s in scriptureSuggestions" :key="s">
                  <button class="block w-full text-left px-2 py-1 hover:bg-blue-50"
                          :class="selectedScriptureRef===s ? 'bg-blue-50' : ''"
                          @click="selectedScriptureRef=s; fetchPassage(s)">
                    <span x-text="s"></span>
                  </button>
                </template>
              </div>
            </template>
            <div class="text-xs text-gray-500 px-2 py-3" x-show="!scriptureSuggestions.length">
              No AI suggestions yet  enter a reference manually or tweak the search inputs.
            </div>
          </div>
          <div class="w-[500px] h-full overflow-auto border rounded p-3">
            <div class="flex items-center justify-between mb-2 gap-3">
              <div class="flex items-center gap-2 flex-1">
                <input type="text" class="border rounded px-2 py-1 w-full" x-model="selectedScriptureRef" @input="refChanged()" placeholder="e.g., John 1:1-5" />
              </div>
              <div class="flex items-center gap-2">
                <button class="px-2 py-1 border rounded text-blue-800 bg-blue-50 border-blue-200 hover:bg-blue-100"
                  @click="toggleScriptureEditing()">
                  <span x-show="!isScriptureEditing">Edit Passage</span>
                  <span x-show="isScriptureEditing">Hide Editor</span>
                </button>
                <button class="px-2 py-1 border rounded bg-blue-50 text-blue-800 border-blue-300 hover:bg-blue-100" @click="chooseScripture()">Use This Passage</button>
              </div>
            </div>
            <div class="font-medium mb-1" x-text="selectedScriptureRef || 'Select a reference'"></div>
            <div class="text-sm prose max-w-none scripture-html" x-show="selectedScriptureHtml" x-html="selectedScriptureHtml"></div>
            <textarea x-ref="scriptureEditor" class="border rounded w-full mt-2 px-2 py-2 text-sm min-h-[160px] resize-y font-sans"
              :class="isScriptureEditing || !selectedScriptureHtml ? '' : 'hidden'"
              placeholder="Type or paste a scripture reference"
              x-model="selectedScriptureText" @input="customScriptureEdited()"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




      </div>

      <div x-show="route==='team' && !window.__GUEST__" class="h-full">
        <div x-data="teamApp()" x-init="init()" class="h-full flex flex-col">
  <div class="border-b px-4 pt-3 flex items-center gap-3 bg-gray-100 relative">
      <div class="flex items-center gap-1 text-sm z-10">
      <button type="button"
        class="px-3 py-1 rounded-t-md transition border-t border-x"
        :class="activeTab==='schedule'
          ? 'bg-white border-gray-300 text-blue-700 font-semibold -mb-px'
          : 'text-gray-600 border-transparent hover:text-blue-700 hover:bg-gray-100'"
        @click="activeTab='schedule'">
        Schedule
      </button>
      <button type="button"
        class="px-3 py-1 rounded-t-md transition border-t border-x"
        :class="activeTab==='weeklyTeams'
          ? 'bg-white border-gray-300 text-blue-700 font-semibold -mb-px'
          : 'text-gray-600 border-transparent hover:text-blue-700 hover:bg-gray-100'"
        @click="activeTab='weeklyTeams'">
        Weekly Teams
      </button>
      <button type="button"
        class="px-3 py-1 rounded-t-md  transition border-t border-x"
        :class="activeTab==='roles'
          ? 'bg-white border-gray-300 text-blue-700 font-semibold -mb-px'
          : 'text-gray-600 border-transparent hover:text-blue-700 hover:bg-gray-100'"
        @click="activeTab='roles'">
        Roles
      </button>
    </div>
    <div class="flex-1"></div>
    <div class="flex items-center gap-2 absolute bottom-1 right-4">
      <span class="text-sm text-red-600" x-text="error" x-show="error"></span>
      <button type="button" class="px-2 py-1 text-sm border rounded bg-white hover:bg-gray-50 disabled:opacity-50"
        :disabled="loading"
        @click="refresh()">Refresh</button>
    </div>
  </div>

  <div x-cloak x-show="weeklyTeamEditorOpen" class="fixed inset-0 z-40 flex items-center justify-center"
    @keydown.escape.window="closeWeeklyTeamEditor()">
    <div class="absolute inset-0 bg-black/40" @click="closeWeeklyTeamEditor()"></div>
    <div class="relative bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="border-b px-5 py-4 flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-gray-500" x-text="weeklyTeamDraft.team || 'Team'"></div>
          <h3 class="text-lg font-semibold" x-text="weeklyTeamDraft.teamName || 'Weekly Team'"></h3>
        </div>
        <button type="button" class="px-2 py-1 text-sm text-gray-500 hover:text-gray-800"
          @click="closeWeeklyTeamEditor()">Close</button>
      </div>
      <div class="flex-1 overflow-auto">
        <div class="p-6 space-y-6">
          <div class="grid gap-4 md:grid-cols-2">
            <label class="block text-sm">
              <span class="font-medium text-gray-700">Team type</span>
              <select class="mt-1 w-full border rounded px-3 py-2"
                x-model="weeklyTeamDraft.team"
                @change="handleWeeklyTeamTypeChange()">
                <template x-for="teamType in weeklyTeamTypes()" :key="'edit-'+teamType">
                  <option :value="teamType" x-text="teamType"></option>
                </template>
              </select>
            </label>
            <label class="block text-sm">
              <span class="font-medium text-gray-700">Team name</span>
              <input type="text" class="mt-1 w-full border rounded px-3 py-2"
                placeholder="e.g., 1st Sunday"
                x-model="weeklyTeamDraft.teamName" />
            </label>
            <label class="block text-sm md:col-span-2">
              <span class="font-medium text-gray-700">Description / notes</span>
              <textarea class="mt-1 w-full border rounded px-3 py-2 min-h-[88px]"
                placeholder="Optional notes"
                x-model="weeklyTeamDraft.description"></textarea>
            </label>
          </div>

          <div class="space-y-4">
            <div class="flex flex-wrap items-center justify-between gap-3 text-sm">
              <span class="font-medium text-gray-700">Role assignments</span>
              <div class="flex items-center gap-2">
                <button type="button" class="text-xs text-blue-600 hover:text-blue-800"
                  @click="toggleShowAllRoles()">
                  <span x-show="!weeklyTeamShowAllRoles">Show extra role types</span>
                  <span x-show="weeklyTeamShowAllRoles">Hide extra role types</span>
                </button>
                <button type="button" class="px-2 py-1 border rounded text-xs bg-white hover:bg-blue-50"
                  @click="addWeeklyTeamRole()">
                  + Add role
                </button>
              </div>
            </div>
            <div class="text-sm text-gray-500" x-show="!weeklyTeamRolesDraft.length">
              No roles defined yet. Use Add role to start building this team.
            </div>
            <div class="border rounded overflow-x-auto" x-show="weeklyTeamRolesDraft.length">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="text-left font-medium px-3 py-2">Role name</th>
                    <th class="text-left font-medium px-3 py-2 w-48">Role type</th>
                    <th class="text-left font-medium px-3 py-2 w-56">Assigned member</th>
                    <th class="px-3 py-2 w-12 text-center"></th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="role in weeklyTeamRolesDraft" :key="role.id">
                    <tr class="border-t">
                      <td class="px-3 py-2 align-top">
                        <input type="text"
                          class="w-full border rounded px-2 py-1.5"
                          placeholder="e.g., Guitar 1"
                          x-model="role.roleName" />
                      </td>
                      <td class="px-3 py-2 align-top">
                        <select class="w-full border rounded px-2 py-1"
                          x-model="role.roleType"
                          x-bind:data-role-type-select="role.id">
                          <option value="">Select role type</option>
                          <template x-for="type in roleTypeOptionsForRole(role)" :key="role.id + '-' + type">
                            <option :value="type" x-text="type"></option>
                          </template>
                        </select>
                      </td>
                      <td class="px-3 py-2 align-top">
                        <select class="w-full border rounded px-2 py-1"
                          x-model="role.memberEmail"
                          x-bind:data-role-member-select="role.id">
                          <option value="">Unassigned</option>
                          <template x-for="member in memberOptionsForRoleType(role.roleType, role)" :key="member.email + '-' + role.id">
                            <option :value="member.email" x-text="member.label"></option>
                          </template>
                        </select>
                      </td>
                      <td class="px-3 py-2 align-top text-center">
                        <button type="button"
                          class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-rose-200 text-rose-600 hover:bg-rose-50 hover:border-rose-300 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-offset-0"
                          title="Remove role"
                          aria-label="Remove role"
                          @click="removeWeeklyTeamRole(role.id)">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" class="h-4 w-4" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                              d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.455 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                          </svg>
                        </button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button type="button" class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
              :disabled="weeklyTeamSaving || !weeklyTeamDirty"
              @click="saveWeeklyTeam()">
              Save Weekly Team
            </button>
            <button type="button" class="px-3 py-1.5 rounded border text-sm hover:bg-gray-50 disabled:opacity-50"
              :disabled="weeklyTeamSaving || !weeklyTeamDirty"
              @click="resetWeeklyTeamEdits()">
              Discard
            </button>
            <span class="text-sm text-green-700" x-show="weeklyTeamSavedAt" x-text="'Saved ' + timeAgo(weeklyTeamSavedAt)"></span>
            <span class="text-sm text-gray-600" x-show="weeklyTeamSaving">Saving...</span>
            <span class="text-sm text-red-600" x-show="weeklyTeamSaveError" x-text="weeklyTeamSaveError"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex-1 min-h-0 flex flex-col" x-show="activeTab==='schedule'" x-cloak>
    <div class="border-b bg-gray-50 px-4 py-3 flex flex-wrap items-center gap-3">
      <div class="text-xs text-red-600" x-show="scheduleError" x-text="scheduleError"></div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-3 text-sm">
        <span class="text-emerald-700" x-show="scheduleSaveMessage" x-text="scheduleSaveMessage"></span>
        <span class="text-red-600" x-show="scheduleSaveError" x-text="scheduleSaveError"></span>
        <span class="text-gray-600" x-show="scheduleSaving">Saving schedule...</span>
      </div>
      <button type="button" class="px-2 py-1 text-sm border rounded bg-white hover:bg-gray-50 disabled:opacity-50"
        :disabled="scheduleSaving"
        @click="refresh()">Refresh</button>
      <button type="button" class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
        :disabled="scheduleSaving || !scheduleDirty"
        @click="saveSchedule()">
        Save Schedule
      </button>
    </div>
    <div class="flex-1 min-h-0 overflow-auto px-4 pb-4 space-y-6">
      <div class="text-sm text-gray-500" x-show="scheduleLoading">Loading upcoming services...</div>
      <div class="text-sm text-gray-500" x-show="!scheduleLoading && !scheduleLayouts.length">
        No upcoming services to schedule.
      </div>
      <template x-for="layout in scheduleLayouts" :key="layout.teamType">
        <section class="border border-slate-200 rounded bg-white shadow-sm relative">
          <div class="bg-blue-900 text-white px-4 py-3 flex flex-wrap items-center gap-4 sticky top-0 z-10 shadow" style="top:0">
            <div class="flex flex-col">
              <h3 class="text-xl font-semibold" x-text="layout.teamType || '(unspecified team)'"></h3>
              <span class="text-xs text-blue-100" x-text="layout.columns.length + ' services'"></span>
            </div>
            <div class="flex-1"></div>
            <span class="text-xs font-bold uppercase tracking-wide text-amber-200" x-show="scheduleDirty">Unsaved</span>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-100 text-gray-700">
                <tr>
                  <th class="text-left font-medium px-3 py-2 w-48 sticky left-0 z-20 bg-slate-100">Role</th>
                  <template x-for="column in layout.columns" :key="column.id">
                    <th class="text-left font-medium px-3 py-2 align-top min-w-[200px]">
                      <div class="font-semibold" x-text="column.service.label"></div>
                      <div class="text-xs text-gray-500" x-text="column.service.ordinalLabel"></div>
                      <div class="text-xs text-gray-400"
                        x-show="column.teamLabel && column.teamLabel !== column.service.ordinalLabel"
                        x-text="column.teamLabel"></div>
                    </th>
                  </template>
                </tr>
              </thead>
              <tbody>
                <template x-for="row in layout.rows" :key="row.key">
                  <tr class="border-t">
                    <th class="px-3 py-1 text-left bg-slate-50 align-middle sticky left-0 z-10" x-text="row.label"></th>
                    <template x-for="column in layout.columns" :key="column.id + '-' + row.key">
                      <td class="align-top px-2 py-2 min-w-[200px]"
                        :class="!row.cells[column.id]?.memberEmail ? 'bg-amber-50' : ''">
                        <div class="flex flex-col gap-1">
                          <select class="w-full border rounded px-2 py-1 text-sm"
                            :class="!row.cells[column.id]?.memberEmail ? 'border-amber-400 bg-amber-50' : ''"
                            :value="row.cells[column.id]?.memberEmail || ''"
                            :disabled="scheduleSaving"
                            @change="setScheduleAssignment(column.id, layout.teamType, row.label, $event.target.value)">
                            <option value="">Open</option>
                            <template x-for="member in memberOptionsForRoleType(row.label, row.cells[column.id], { serviceId: column.id })"
                              :key="member.email + '-' + column.id + '-' + row.key">
                              <option :value="member.email" x-text="member.display"></option>
                            </template>
                          </select>
                        </div>
                      </td>
                    </template>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </section>
      </template>
    </div>
  </div>

  <div class="flex-1 min-h-0 flex" x-show="activeTab==='roles'" x-cloak>
    <!-- Left column: list -->
    <div class="w-[360px] flex-shrink-0 border-r flex flex-col min-h-0">
      <div class="p-3 space-y-2 border-b">
        <button type="button" class="w-full px-3 py-2 text-sm font-medium border rounded bg-white hover:bg-blue-50" @click="openNewMember()">+ Add Member</button>
        <input type="search" class="w-full border rounded px-3 py-2 text-sm"
          placeholder="Search team members"
          x-model.debounce.250ms="search" />
        <select class="w-full border rounded px-2 py-1 text-sm" x-model="teamFilter">
          <option value="">All teams</option>
          <template x-for="t in teamOptions" :key="t">
            <option :value="t" x-text="t"></option>
          </template>
        </select>
      </div>
      <div class="flex-1 min-h-0 overflow-auto">
        <div class="p-4 text-sm text-gray-500" x-show="loading">Loading team...</div>
        <div class="p-4 text-sm text-gray-500" x-show="!loading && !filteredRoles().length">No matches.</div>
        <ul>
          <template x-for="person in filteredRoles()" :key="person.email">
            <li class="border-b px-3 py-2 cursor-pointer hover:bg-blue-50 text-sm"
              :class="selectedEmail === person.email ? 'bg-blue-50 border-l-4 border-blue-400' : ''"
              @click="select(person.email)">
              <div class="font-medium" x-text="person.first + ' ' + person.last"></div>
              <div class="text-xs text-gray-500" x-text="person.email"></div>
              <div class="text-xs text-gray-600 mt-1" x-show="person.teamRaw">
                <span class="font-medium">Teams:</span>
                <span x-text="person.teamRaw"></span>
              </div>
              <div class="text-xs text-gray-600 truncate" x-show="person.role">
                <span class="font-medium">Roles:</span>
                <span x-text="person.role"></span>
              </div>
            </li>
          </template>
        </ul>
      </div>
    </div>

    <!-- Right column: detail -->
    <div class="flex-1 min-h-0 flex flex-col">
      <div class="p-4 text-sm" x-show="selected">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-xl font-semibold" x-text="selected?.first + ' ' + selected?.last"></h3>
            <div class="text-sm text-gray-600" x-text="selected?.email"></div>
            <div class="mt-2 text-xs inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-800 rounded"
              x-show="editPermissions || selected?.permissions">
              <span class="font-semibold uppercase tracking-wide"
                x-text="(editPermissions || selected?.permissions || '').toUpperCase()"></span>
            </div>
          </div>
          <div class="text-xs text-gray-500" x-show="selected?.spanish">
            Spanish: <span class="font-semibold" x-text="selected?.spanish"></span>
          </div>
        </div>

        <div class="mt-4 space-y-6 max-w-3xl">
        <div class="space-y-3">
          <span class="font-medium text-gray-700">Teams</span>
          <div class="grid gap-2 sm:grid-cols-2">
            <template x-for="team in teamList()" :key="team">
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" :checked="isTeamSelected(team)" @change="toggleTeam(team, $event.target.checked)" />
                <span x-text="team"></span>
              </label>
            </template>
          </div>
        </div>

          <div class="space-y-4">
            <div class="flex items-center justify-between text-sm">
              <span class="font-medium text-gray-700">Roles</span>

            </div>
            <template x-for="(roles, teamName) in rolePresets" :key="teamName">
              <div class="border rounded px-3 py-2" x-show="isTeamSelected(teamName)">
                <div class="flex items-center justify-between text-sm font-semibold">
                  <span x-text="teamName"></span>
                  <span class="text-xs text-indigo-600"
                    x-show="isTeamSelected(teamName)">On team</span>
                </div>
                <div class="mt-2 grid gap-2 sm:grid-cols-2">
                  <template x-for="role in roles" :key="role">
                    <label class="inline-flex items-center gap-2 text-sm">
                      <input type="checkbox"
                        :checked="roleSelections[role] || false"
                        @change="setRole(role, $event.target.checked)" />
                      <span x-text="role"></span>
                    </label>
                  </template>
                </div>
              </div>
            </template>
            </div>

          <div class="grid gap-4 sm:grid-cols-2 max-w-xl">
            <label class="block text-sm">
              <span class="font-medium text-gray-700">Permissions</span>
              <select class="mt-1 w-full border rounded px-3 py-2"
                x-model="editPermissions">
                <template x-for="perm in permissionsOptions" :key="'edit-'+perm">
                  <option :value="perm" x-text="formatPermission(perm)"></option>
                </template>
              </select>
            </label>
            <label class="flex items-center gap-2 text-sm mt-1 sm:mt-6">
              <input type="checkbox" x-model="spanishChecked" />
              <span>Spanish speaker</span>
            </label>
          </div>
        </div>

        <div class="mt-4 flex items-center gap-2">
          <button type="button" class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
            :disabled="saving || !dirty"
            @click="save()">Save Changes</button>
          <button type="button" class="px-3 py-1.5 rounded border text-sm hover:bg-gray-50 disabled:opacity-50"
            :disabled="saving || !dirty"
            @click="resetEdits()">Discard</button>
          <span class="text-sm text-green-700" x-show="!saving && savedAt" x-text="'Saved ' + timeAgo(savedAt)"></span>
          <span class="text-sm text-gray-600" x-show="saving">Saving...</span>
        </div>
      </div>
      <div class="p-6 text-gray-500" x-show="!selected && !loading">
        Select a team member to view and edit their roles.
      </div>
    </div>
  </div>


  <div class="flex-1 min-h-0 flex flex-col" x-show="activeTab==='weeklyTeams'" x-cloak>
    <div class="border-b bg-gray-50 px-4 py-3 flex flex-wrap items-center gap-3">
      <div class="text-xs text-red-600" x-show="weeklyTeamsError" x-text="weeklyTeamsError"></div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-3 text-sm">
        <span class="text-emerald-700" x-show="weeklyTeamsSaveMessage" x-text="weeklyTeamsSaveMessage"></span>
        <span class="text-red-600" x-show="weeklyTeamsSaveError" x-text="weeklyTeamsSaveError"></span>
        <span class="text-gray-600" x-show="weeklyTeamsSaving">Saving weekly teams...</span>
      </div>
      <button type="button" class="px-2 py-1 text-sm border rounded bg-white hover:bg-gray-50 disabled:opacity-50"
        :disabled="weeklyTeamsSaving"
        @click="refresh()">Refresh</button>
      <button type="button" class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
        :disabled="!hasDirtyWeeklyTeams() || weeklyTeamsSaving"
        @click="saveDirtyWeeklyTeams()">
        Save Changes
      </button>
    </div>
    <div class="flex-1 min-h-0 overflow-auto px-4 pb-4">
      <div class="text-sm text-gray-500" x-show="weeklyTeamsLoading">Loading weekly teams...</div>
      <div class="text-sm text-gray-500" x-show="!weeklyTeamsLoading && !weeklyTeamLayouts.length">
        No weekly teams yet. Create a team to get started.
      </div>
      <div class="flex flex-col gap-6">
        <template x-for="group in weeklyTeamLayouts" :key="group.teamType">
        <section class="border border-slate-200 rounded bg-white shadow-sm relative">
          <div class="bg-blue-900 text-white px-4 py-3 flex flex-wrap items-center gap-4 sticky top-0 z-10 shadow"
            style="top:0">
            <div class="flex items-center gap-3">
              <h3 class="text-xl font-semibold" x-text="group.teamType || '(unspecified)'"></h3>
              <span class="text-xs font-bold uppercase tracking-wide text-amber-200"
                x-show="groupDirtyIds(group).length">Unsaved</span>
            </div>
            <div class="flex-1"></div>
            <div class="flex gap-2 items-center">
              <button type="button" class="px-3 py-1.5 text-sm rounded border border-white/40 text-white hover:bg-white/10"
                @click="openRoleDefaults(group.teamType)">Edit default roles</button>
              <button type="button" class="px-3 py-1.5 text-sm rounded border border-white/40 text-white hover:bg-white/10 disabled:opacity-60"
                :disabled="!groupDirtyIds(group).length"
                @click="saveDirtyWeeklyTeams(groupDirtyIds(group))">
                Save
              </button>
            </div>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-100 text-gray-700">
                <tr>
                  <th class="text-left font-medium px-3 py-2 w-48 sticky left-0 z-20 bg-slate-100">Role</th>
                  <template x-for="team in group.teams" :key="team.key">
                    <th class="text-left font-medium px-3 py-2 align-top">
                      <div class="font-semibold" x-text="team.teamName || '(untitled)'"></div>
                      <div class="text-xs text-gray-500" x-text="team.description"></div>
                   </th>
                 </template>
                </tr>
              </thead>
              <tbody>
                <template x-for="role in group.roles" :key="role.key">
                  <tr class="border-t">
                    <th class="px-3 py-1 text-left bg-slate-50 align-middle sticky left-0 z-10" x-text="role.label"></th>
                    <template x-for="team in group.teams" :key="team.key">
                      <td class="align-top min-w-[180px]">
                        <select class="w-full border rounded px-2 py-1 text-sm"
                          :value="role.cells[team.key]?.memberEmail || ''"
                          @change="setWeeklyTeamMember(team.id, role.label, $event.target.value)">
                          <option value="">Unassigned</option>
                              <template x-for="member in memberOptionsForRoleType(role.label)"
                                :key="member.email + '-' + team.key + '-' + role.key">
                                <option :value="member.email" x-text="member.display"></option>
                              </template>
                        </select>
                      </td>
                    </template>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </section>
      </template>
      </div>
    </div>
  </div>
  <div x-cloak x-show="showRoleDefaultsModal" class="fixed inset-0 z-40 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40" @click="closeRoleDefaults()"></div>
    <div class="relative bg-white rounded shadow-lg w-full max-w-lg p-5 space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold">Edit Default Roles</h3>
          <p class="text-sm text-gray-500" x-text="roleDefaultsTeamType || 'Team type'"></p>
        </div>
        <button type="button" class="text-sm text-gray-500 hover:text-gray-800"
          :disabled="roleDefaultsSaving"
          @click="closeRoleDefaults()">Close</button>
      </div>
      <div class="max-h-[60vh] overflow-auto space-y-2">
        <template x-for="(roleName, idx) in roleDefaultsDraft" :key="idx">
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-500 w-6 text-right" x-text="idx + 1"></span>
            <input type="text" class="flex-1 border rounded px-2 py-1" data-role-default-input
              :placeholder="'Role ' + (idx + 1)"
              x-model="roleDefaultsDraft[idx]" />
            <div class="flex flex-col gap-1">
              <button type="button" class="text-xs text-gray-500 hover:text-gray-800 disabled:text-gray-300"
                :disabled="idx===0"
                @click="moveRoleDefault(idx, -1)"></button>
              <button type="button" class="text-xs text-gray-500 hover:text-gray-800 disabled:text-gray-300"
                :disabled="idx===roleDefaultsDraft.length-1"
                @click="moveRoleDefault(idx, 1)"></button>
            </div>
            <button type="button" class="text-xs text-rose-600 hover:text-rose-800 px-2 py-1"
              @click="removeRoleDefault(idx)">Remove</button>
          </div>
        </template>
        <button type="button" class="text-sm text-blue-600 hover:text-blue-800"
          @click="addRoleDefault()">+ Add role</button>
      </div>
      <div class="text-sm text-red-600" x-show="roleDefaultsError" x-text="roleDefaultsError"></div>
      <div class="flex items-center justify-end gap-2">
        <button type="button" class="px-3 py-1.5 border rounded text-sm hover:bg-gray-50"
          :disabled="roleDefaultsSaving"
          @click="closeRoleDefaults()">Cancel</button>
        <button type="button" class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
          :disabled="roleDefaultsSaving"
          @click="saveRoleDefaults()">
          <span x-show="!roleDefaultsSaving">Save Defaults</span>
          <span x-show="roleDefaultsSaving">Saving...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- New member modal -->
  <div x-cloak x-show="showNewMemberModal" class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40" @click="closeNewMember()"></div>
    <div class="relative bg-white rounded shadow-lg w-full max-w-md p-5 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Add Team Member</h3>
        <button type="button" class="text-sm text-gray-500 hover:text-gray-800" @click="closeNewMember()">Close</button>
      </div>
      <div class="space-y-3 text-sm">
        <div class="flex gap-3">
          <label class="flex-1">
            <span class="font-medium text-gray-700">First name</span>
            <input type="text" class="mt-1 w-full border rounded px-3 py-2" x-model="newMember.first" />
          </label>
          <label class="flex-1">
            <span class="font-medium text-gray-700">Last name</span>
            <input type="text" class="mt-1 w-full border rounded px-3 py-2" x-model="newMember.last" />
          </label>
        </div>
        <label class="block">
          <span class="font-medium text-gray-700">Email</span>
          <input type="email" class="mt-1 w-full border rounded px-3 py-2" x-model="newMember.email" x-ref="newMemberEmail" />
        </label>
        <label class="block">
          <span class="font-medium text-gray-700">Permissions</span>
          <select class="mt-1 w-full border rounded px-2 py-1" x-model="newMember.permissions">
            <template x-for="perm in permissionsOptions" :key="'new-'+perm">
              <option :value="perm" x-text="formatPermission(perm)"></option>
            </template>
          </select>
        </label>
        <div class="text-sm text-red-600" x-text="newMemberError" x-show="newMemberError"></div>
      </div>
      <div class="flex items-center justify-end gap-2">
        <button type="button" class="px-3 py-1.5 border rounded text-sm hover:bg-gray-50"
          :disabled="newMemberSaving"
          @click="closeNewMember()">Cancel</button>
        <button type="button" class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
          :disabled="newMemberSaving"
          @click="createMember()">
          <span x-show="!newMemberSaving">Add Member</span>
          <span x-show="newMemberSaving">Saving...</span>
        </button>
      </div>
    </div>
  </div>

  <div x-cloak x-show="showNewWeeklyTeamModal" class="fixed inset-0 z-40 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40" @click="closeNewWeeklyTeam()"></div>
    <div class="relative bg-white rounded shadow-lg w-full max-w-md p-5 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Create Weekly Team</h3>
        <button type="button" class="text-sm text-gray-500 hover:text-gray-800" @click="closeNewWeeklyTeam()">Close</button>
      </div>
      <div class="space-y-3 text-sm">
        <label class="block">
          <span class="font-medium text-gray-700">Team type</span>
          <select class="mt-1 w-full border rounded px-3 py-2" x-model="newWeeklyTeam.team">
            <template x-for="teamType in weeklyTeamTypes()" :key="'new-weekly-'+teamType">
              <option :value="teamType" x-text="teamType"></option>
            </template>
          </select>
        </label>
        <label class="block">
          <span class="font-medium text-gray-700">Team name</span>
          <input type="text" class="mt-1 w-full border rounded px-3 py-2"
            placeholder="e.g., 1st Sunday"
            x-model="newWeeklyTeam.teamName" />
        </label>
        <label class="block">
          <span class="font-medium text-gray-700">Description</span>
          <textarea class="mt-1 w-full border rounded px-3 py-2 min-h-[80px]"
            placeholder="Optional notes"
            x-model="newWeeklyTeam.description"></textarea>
        </label>
        <div class="text-sm text-red-600" x-show="newWeeklyTeamError" x-text="newWeeklyTeamError"></div>
      </div>
      <div class="flex items-center justify-end gap-2">
        <button type="button" class="px-3 py-1.5 border rounded text-sm hover:bg-gray-50"
          :disabled="newWeeklyTeamSaving"
          @click="closeNewWeeklyTeam()">Cancel</button>
        <button type="button" class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
          :disabled="newWeeklyTeamSaving"
          @click="createWeeklyTeam()">
          <span x-show="!newWeeklyTeamSaving">Create Team</span>
          <span x-show="newWeeklyTeamSaving">Saving...</span>
        </button>
      </div>
    </div>
  </div>
</div>

      </div>

      <div x-show="route==='availability'" class="h-full">
        <div x-data="availabilityApp()" x-init="init()" class="min-h-full bg-gray-50 overflow-y-auto">
  <div class="max-w-3xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow p-5">
      <h1 class="text-2xl font-semibold mb-1">Your Availability</h1>
      <p class="text-sm text-gray-600 mb-5">Let us know which upcoming services you are <span class="font-semibold">unavailable</span> to serve.</p>

      <label class="block text-sm text-gray-700 mb-3">
        Email address
        <div class="mt-1 flex gap-2">
          <input type="email" placeholder="you@example.com"
            class="flex-1 border rounded px-3 py-2"
            x-model="email"
            @input="onEmailInput()"
            @blur="prefillAvailability()"
            autocomplete="email" required>
          <button type="button" class="px-3 py-2 border rounded bg-gray-50 hover:bg-gray-100"
            @click="prefillAvailability(true)" :disabled="loadingAvailability || !emailValid()">
            <span x-show="!loadingAvailability">Load Dates</span>
            <span x-show="loadingAvailability">Loading...</span>
          </button>
        </div>
      </label>

      <div class="mb-4 text-sm text-rose-600" x-show="error" x-text="error"></div>
      <div class="mb-4 text-sm text-emerald-700" x-show="statusMessage" x-text="statusMessage"></div>
      <div class="mb-4 text-sm text-gray-600" x-show="!memberVerified">
        Enter your email and load your dates to manage your availability.
      </div>

      <div x-show="loadingServices" class="text-sm text-gray-600">Loading upcoming services&hellip;</div>
      <div x-show="!loadingServices && !services.length" class="text-sm text-gray-600">No upcoming services yet.</div>

      <form x-show="memberVerified && !loadingServices && services.length" @submit.prevent="saveAvailability()" class="flex flex-col gap-4">
        <div class="flex justify-between gap-4">
          <p class="text-sm text-gray-500">Checked services mark the Sundays you are unavailable.</p>
          <div class="flex justify-end items-center">
            <button type="submit"
              class="px-4 py-2 rounded bg-emerald-600 text-white disabled:opacity-50"
              :disabled="saving || !emailValid() || !memberVerified">
              <span x-show="!saving">Save Availability</span>
              <span x-show="saving">Saving...</span>
            </button>
          </div>
        </div>
        <div class="border rounded divide-y max-h-96 overflow-y-auto">
          <template x-for="svc in services" :key="svc.id || svc.date">
            <label class="flex items-start gap-3 px-3 py-3 hover:bg-blue-50">
              <input type="checkbox" class="mt-1 rounded border-gray-300" :value="svc.id"
                x-model="selectedServiceIds">
              <div>
                <div class="font-semibold" x-text="svc.label"></div>
              </div>
            </label>
          </template>
        </div>
        <button type="button" class="self-start text-sm text-blue-700 hover:underline"
          @click="clearSelections()" :disabled="saving">Clear all</button>
      </form>
    </div>
    <div x-cloak x-show="isAdmin" class="mt-6 bg-white rounded-lg shadow p-5 space-y-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h2 class="text-lg font-semibold text-blue-900">Share the availability link</h2>
          <p class="text-xs text-blue-800 break-all" x-text="shareLink"></p>
        </div>
        <div class="flex gap-2">
          <button type="button" class="px-3 py-1.5 text-sm border rounded bg-white hover:bg-blue-100"
            @click="copyShareLink()">Copy Link</button>
          <button type="button" class="px-3 py-1.5 text-sm border rounded bg-blue-600 text-white hover:bg-blue-700"
            @click="emailEditorOpen = !emailEditorOpen">
            <span x-show="!emailEditorOpen">Show Email Text</span>
            <span x-show="emailEditorOpen">Hide Email Text</span>
          </button>
        </div>
      </div>

      <div x-show="emailEditorOpen" class="space-y-3 text-sm">
        <label class="block">
          <span class="font-medium text-gray-700">Email subject</span>
          <div class="mt-1 flex gap-2 items-center">
            <div class="relative flex-1">
              <span class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M6.75 3v2.25M17.25 3v2.25M3 8.25h18M5.25 6.75h13.5A2.25 2.25 0 0 1 21 9v9.75A2.25 2.25 0 0 1 18.75 21H5.25A2.25 2.25 0 0 1 3 18.75V9a2.25 2.25 0 0 1 2.25-2.25zM7.5 12h1.5m3 0h1.5m-6 3h1.5m3 0h1.5" />
                </svg>
              </span>
              <input type="text" class="w-full border rounded px-3 py-2 pl-9" x-model="emailSubject" />
            </div>
            <button type="button" class="px-3 py-2 border rounded bg-white hover:bg-blue-50"
              @click="copyEmailSubject()">Copy subject</button>
          </div>
        </label>
        <label class="block">
          <span class="font-medium text-gray-700">Email message</span>
          <textarea class="mt-1 w-full border rounded px-3 py-2 min-h-[140px]" x-model="emailBody"></textarea>
        </label>
        <div class="flex flex-wrap items-center gap-2">
          <button type="button" class="px-3 py-2 border rounded bg-white hover:bg-blue-50"
            @click="copyEmailBody()">Copy email text</button>
          <p class="text-xs text-gray-600">Update the text above and click copy to paste into your email client.</p>
        </div>
      </div>

      <div class="border-t pt-4 space-y-3">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <h3 class="text-base font-semibold text-gray-900">Email recipients</h3>
            <p class="text-sm text-gray-600">Pick a team, then uncheck anyone you do not want to include.</p>
          </div>
          <div class="flex flex-wrap gap-2 text-sm items-center">
            <span class="text-gray-700" x-text="`Selected: ${selectedRecipientEmails.length}`"></span>
            <button type="button" class="px-3 py-1.5 border rounded bg-white hover:bg-blue-50"
              @click="selectAllRecipients()" :disabled="!filteredRecipients.length">
              Select all
            </button>
            <button type="button" class="px-3 py-1.5 border rounded bg-white hover:bg-blue-50"
              @click="deselectAllRecipients()" :disabled="!selectedRecipientEmails.length">
              Deselect all
            </button>
            <button type="button" class="px-3 py-1.5 border rounded bg-white hover:bg-blue-50"
              @click="copyRecipientEmails()" :disabled="!selectedRecipientEmails.length">
              Copy recipient emails
            </button>
            <button type="button"
              class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
              @click="sendAvailabilityEmail()"
              :disabled="!selectedRecipientEmails.length || emailSending">
              <span x-show="!emailSending">Send email</span>
              <span x-show="emailSending">Sending...</span>
            </button>
          </div>
          <div class="text-sm text-emerald-700" x-show="emailSendStatus" x-text="emailSendStatus"></div>
          <div class="text-sm text-rose-600" x-show="emailSendError" x-text="emailSendError"></div>
        </div>
        <div class="grid gap-4 md:grid-cols-2 text-sm">
          <label class="block">
            <span class="font-medium text-gray-700">Team</span>
            <select class="mt-1 w-full border rounded px-3 py-2" x-model="selectedRecipientTeam"
              @change="onRecipientTeamChange($event.target.value)">
              <template x-for="team in recipientTeams" :key="team.value">
                <option :value="team.value" x-text="team.label"></option>
              </template>
            </select>
          </label>
          <div class="flex items-center text-gray-600" x-show="recipientLoading">
            Loading team members
          </div>
          <div class="flex items-center text-rose-600" x-show="recipientError" x-text="recipientError"></div>
        </div>
        <div class="border rounded max-h-64 overflow-y-auto divide-y" x-show="filteredRecipients.length">
          <template x-for="member in filteredRecipients" :key="member.email">
            <label class="flex items-start gap-3 px-3 py-2 text-sm">
              <input type="checkbox" class="mt-1" :value="member.email" x-model="selectedRecipientEmails">
              <div class="flex gap-4 items-start">
                <div class="font-medium text-gray-900" x-text="member.name || member.email"></div>
                <div class="text-xs text-gray-500" x-text="member.email"></div>
                <div class="text-xs text-gray-400" x-text="member.teams.join(', ')" x-show="member.teams.length"></div>
              </div>
            </label>
          </template>
        </div>
        <div class="text-sm text-gray-500" x-show="!filteredRecipients.length && !recipientLoading">
          No members found for this team.
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
    </div>
  </main>


  <script>
    function app() {
      return {
        route: 'plan',
        init() {
          const isGuest = !!(window.__GUEST__);
          const allowed = new Set(isGuest ? ['plan','songs','availability'] : ['plan','songs','team','availability']);
          const normalize = (value) => String(value || '').trim().toLowerCase();
          const parseHashRoute = () => normalize(location.hash.replace('#/', ''));
          const setRoute = (value) => {
            const next = allowed.has(value) ? value : 'plan';
            this.route = next;
          };
          const params = (() => {
            try { return new URLSearchParams(location.search || ''); }
            catch (_) { return null; }
          })();
          const paramRoute = params
            ? [params.get('tab'), params.get('route'), params.get('view')].map(normalize).find(Boolean) || ''
            : '';

          const initialHashRoute = parseHashRoute();
          if (initialHashRoute) {
            setRoute(initialHashRoute);
          } else if (paramRoute) {
            setRoute(paramRoute);
            if (!location.hash || location.hash === '#') {
              location.hash = `#/${this.route}`;
            }
          } else {
            setRoute('plan');
          }

          window.addEventListener('hashchange', () => {
            const next = parseHashRoute() || 'plan';
            setRoute(next);
          });
        }
      }
    }
  </script>
</body>

</html>



